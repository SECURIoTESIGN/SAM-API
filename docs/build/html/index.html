<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Welcome to SAM API’s Documentation &mdash; SAM-API 1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="#" class="icon icon-home"> SAM-API
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Welcome to SAM API’s Documentation</a></li>
<li><a class="reference internal" href="#project-overview">Project Overview</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#core-and-community-modules-plugins">Core and Community Modules/Plugins</a><ul>
<li><a class="reference internal" href="#installing-core-modules">Installing Core Modules</a></li>
<li><a class="reference internal" href="#developing-modules">Developing Modules</a></li>
</ul>
</li>
<li><a class="reference internal" href="#statistics-services-api">Statistics Services API</a></li>
<li><a class="reference internal" href="#authentication-services-api">Authentication Services API</a><ul>
<li><a class="reference internal" href="#authenticate-user">Authenticate User</a></li>
<li><a class="reference internal" href="#logout-user">Logout User</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-services-api">User Services API</a><ul>
<li><a class="reference internal" href="#get-users">Get Users</a></li>
<li><a class="reference internal" href="#get-user-groups">Get User Groups</a></li>
<li><a class="reference internal" href="#check-if-user-is-an-admin">Check if User is an Admin</a></li>
<li><a class="reference internal" href="#add-user">Add User</a></li>
<li><a class="reference internal" href="#update-user">Update User</a></li>
<li><a class="reference internal" href="#remove-user">Remove User</a></li>
</ul>
</li>
<li><a class="reference internal" href="#group-services-api">Group Services API</a><ul>
<li><a class="reference internal" href="#get-groups">Get Groups</a></li>
<li><a class="reference internal" href="#add-group">Add Group</a></li>
<li><a class="reference internal" href="#edit-group">Edit Group</a></li>
<li><a class="reference internal" href="#remove-group">Remove Group</a></li>
</ul>
</li>
<li><a class="reference internal" href="#file-services-api">File Services API</a><ul>
<li><a class="reference internal" href="#upload-file">Upload File</a></li>
<li><a class="reference internal" href="#request-file">Request File</a></li>
<li><a class="reference internal" href="#get-files">Get Files</a></li>
<li><a class="reference internal" href="#get-session-files">Get Session Files</a></li>
</ul>
</li>
<li><a class="reference internal" href="#types-services-api">Types Services API</a><ul>
<li><a class="reference internal" href="#get-types">Get Types</a></li>
<li><a class="reference internal" href="#add-type">Add Type</a></li>
<li><a class="reference internal" href="#edit-type">Edit Type</a></li>
<li><a class="reference internal" href="#remove-type">Remove Type</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-services-api">Module Services API</a><ul>
<li><a class="reference internal" href="#get-modules">Get Modules</a></li>
<li><a class="reference internal" href="#get-module-type">Get Module Type</a></li>
<li><a class="reference internal" href="#get-questions-answers-of-a-module">Get Questions/Answers of a Module</a></li>
<li><a class="reference internal" href="#get-questions-of-modules">Get Questions of Modules</a></li>
<li><a class="reference internal" href="#get-modules-answers">Get Modules Answers</a></li>
<li><a class="reference internal" href="#add-module">Add Module</a></li>
<li><a class="reference internal" href="#edit-module">Edit Module</a></li>
<li><a class="reference internal" href="#remove-module">Remove Module</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dependencies-services-api">Dependencies Services API</a><ul>
<li><a class="reference internal" href="#get-dependencies">Get Dependencies</a></li>
<li><a class="reference internal" href="#add-dependency">Add Dependency</a></li>
<li><a class="reference internal" href="#edit-dependency">Edit Dependency</a></li>
<li><a class="reference internal" href="#remove-dependency">Remove Dependency</a></li>
</ul>
</li>
<li><a class="reference internal" href="#questions-services-api">Questions Services API</a><ul>
<li><a class="reference internal" href="#get-questions">Get Questions</a></li>
<li><a class="reference internal" href="#get-questions-answers">Get Questions Answers</a></li>
<li><a class="reference internal" href="#add-question">Add Question</a></li>
<li><a class="reference internal" href="#edit-question">Edit Question</a></li>
<li><a class="reference internal" href="#remove-question">Remove Question</a></li>
</ul>
</li>
<li><a class="reference internal" href="#answers-services-api">Answers Services API</a><ul>
<li><a class="reference internal" href="#get-answers">Get Answers</a></li>
<li><a class="reference internal" href="#add-answer">Add Answer</a></li>
<li><a class="reference internal" href="#edit-answer">Edit Answer</a></li>
<li><a class="reference internal" href="#remove-answer">Remove Answer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#recommendations-services-api">Recommendations Services API</a><ul>
<li><a class="reference internal" href="#get-recommendations">Get Recommendations</a></li>
<li><a class="reference internal" href="#add-recommendation">Add Recommendation</a></li>
<li><a class="reference internal" href="#edit-recommendation">Edit Recommendation</a></li>
<li><a class="reference internal" href="#remove-recommendation">Remove Recommendation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sessions-services-api">Sessions Services API</a><ul>
<li><a class="reference internal" href="#get-user-sessions">Get User Sessions</a></li>
<li><a class="reference internal" href="#create-user-session">Create User Session</a></li>
<li><a class="reference internal" href="#edit-user-session">Edit User Session</a></li>
<li><a class="reference internal" href="#close-user-session">Close User Session</a></li>
</ul>
</li>
<li><a class="reference internal" href="#acknowledgment">Acknowledgment</a></li>
<li><a class="reference internal" href="#license">License</a></li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">SAM-API</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
      <li>Welcome to SAM API’s Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="welcome-to-sam-api-s-documentation">
<h1>Welcome to SAM API’s Documentation<a class="headerlink" href="#welcome-to-sam-api-s-documentation" title="Permalink to this headline"></a></h1>
<div class="toctree-wrapper compound">
</div>
<img alt="SAM" src="_images/sam_logo.png" />
<p>Welcome to SAM API’s documentation. This document is aimed at developers and it is highly recommended to start with the <a class="reference internal" href="#install"><span class="std std-ref">Installation</span></a> section
and then go forward with the API sections. The main purpose of this documentation is to provide insights into how one should use
SAM’s core API services in the development of a frontend (e.g., the default one provided at <a class="reference external" href="https://github.com/SECURIoTESIGN/SAM">https://github.com/SECURIoTESIGN/SAM</a>).</p>
</section>
<section id="project-overview">
<h1>Project Overview<a class="headerlink" href="#project-overview" title="Permalink to this headline"></a></h1>
<p>Security Advising Modules (SAM) is a framework that aggregates and connects all the various modules developed under the scope of the <a class="reference external" href="https://lx.it.pt/securIoTesign">SECURIoTESIGN</a>
project while providing a graphical interface to interact with them. SAM is modular, allowing for both quick integrations of newly developed modules and updates
to existing modules. SAM works as a personal security assistant, more relatable, and capable of communicating with the end-user through a series of easily
understandable questions, which the user can answer directly or through a set of predefined answers.</p>
</section>
<section id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h1>
<p id="install">The installation, <strong>for development proposes only</strong>, can be accomplished through a group of <a class="reference external" href="https://www.docker.com/">Docker</a> containers.</p>
<ol class="arabic simple">
<li><p><strong>Clone the public repository.</strong></p></li>
<li><p><strong>Create the API and database docker imagens and subsequent containers:</strong></p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> sam-api
make
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The database and API container will be deployed with API port set to 8080 and database port set to 3306.
The database user will be <code class="docutils literal notranslate"><span class="pre">root</span></code> and the password <code class="docutils literal notranslate"><span class="pre">secure</span></code>.</p>
</div>
<ol class="arabic simple" start="3">
<li><p><strong>Deploy the database into the database container:</strong></p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker <span class="nb">exec</span> -it sam-db python3 install_db.py
</pre></div>
</div>
<p>You can access the database using DBeaver or similar (use <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">docker</span> <span class="pre">inspect</span> <span class="pre">sam-db</span></code> to get the IP of the sam-db container).</p>
<ol class="arabic simple" start="4">
<li><p><strong>Develop away!</strong></p></li>
</ol>
<p>You can start both containers as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo docker stop sam-api <span class="o">&amp;&amp;</span> sudo docker start sam-api
</pre></div>
</div>
<p>SAM’s REST services can be tested and accessed through <a class="reference external" href="https://insomnia.rest/download">insomnia</a> – The Insomnia JSON file of this project can be found on the following <a class="reference external" href="https://github.com/SECURIoTESIGN/SAM-API/blob/master/docs/insomnia/Insomnia-SAM-API-Services.json">link</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The contents of folder <code class="docutils literal notranslate"><span class="pre">sam-api</span></code> are mapped to the sam-api container, any local changes will be reflected.</p>
</div>
</section>
<section id="core-and-community-modules-plugins">
<h1>Core and Community Modules/Plugins<a class="headerlink" href="#core-and-community-modules-plugins" title="Permalink to this headline"></a></h1>
<p>Several module and plugins have been developed by the SECURIoTESIGN team and the community. Namely:</p>
<ul class="simple">
<li><p><strong>Security Requirements Elicitation (SRE)</strong> - This module will elicit the main security requirements and properties, e.g., confidentiality, integrity, authentication, access control, availability or accountability that the system should implement from the basic information of what composes it and defines it (e.g., type of system, methods of authentication, types of users, sensitive information storage).</p></li>
<li><p><strong>Security Best Best Practices (SBPG)</strong> - This module will provide best practices guildelines that will highlight common potential vulnerabilities that need to be taken into account during development, and provide information on secure practices that should be implemented.</p></li>
<li><p><strong>Lightweight Criptographic Algorithms Recommendation (LWCAR)</strong> - This module will take the information on the system hardware requirements and defined security requirements. It also proposes algorithms that can be implemented to ensure the security requirements are fulfilled. It specifically recommends lightweight cryptographic algorithms, for both software and hardware implementations.</p></li>
<li><p><strong>Threat Modeling Solution (TMS)</strong> - This modules provides a set of threats that based on the answers given by a user.</p></li>
<li><p><strong>Assessment of the Correct Integration of Security Mechanisms (ACISM)</strong> - This module outputs system tests to check for the presence of threats.</p></li>
</ul>
<p>These modules can be found at <a class="reference external" href="https://github.com/SECURIoTESIGN/SAM-Modules">https://github.com/SECURIoTESIGN/SAM-Modules</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A module is defined as a component that incorporates questions and answers and an output designated as recommendations, while a plugin is a special module similar to
the latter but it only provides the output (i.e., recommendations) – These plugins are dependent on the input of other modules.</p>
</div>
<section id="installing-core-modules">
<h2>Installing Core Modules<a class="headerlink" href="#installing-core-modules" title="Permalink to this headline"></a></h2>
<p>To install core modules into SAM:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> sam-api
make modules
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><em>Beware</em>, this process will recreate SAM’s database - All data will be lost!</p>
</div>
</section>
<section id="developing-modules">
<h2>Developing Modules<a class="headerlink" href="#developing-modules" title="Permalink to this headline"></a></h2>
<p>The development of modules can be accomplished by using the services detailed in section <a class="reference internal" href="#modules"><span class="std std-ref">Modules Services API</span></a>.  If there is a need to develop modules with some logic –
that is, without being dependent on the mapping between question, answer, and recommendation provided by core services – an example is available on the following <a class="reference external" href="https://github.com/SECURIoTESIGN/SAM-API/blob/master/docs/example_module_logic.py">link</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a logic file is developed for a module those services detailed in section <a class="reference internal" href="#addmodule"><span class="std std-ref">Add module</span></a> should be used in conjuntion with the file API detailed in <a class="reference internal" href="#upload"><span class="std std-ref">Upload File</span></a>.</p>
</div>
</section>
</section>
<section id="statistics-services-api">
<h1>Statistics Services API<a class="headerlink" href="#statistics-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the statistic entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>statistic.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">modules.utils</span><span class="o">,</span> <span class="nn">views.recommendation</span><span class="o">,</span> <span class="nn">views.module</span><span class="o">,</span> <span class="nn">views.session</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 33</span><span class="sd">[Summary]: Get Global Stats</span>
<span class="linenos"> 34</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 35</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 36</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/statistics&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 37</span><span class="k">def</span> <span class="nf">get_global_stats</span><span class="p">():</span>
<span class="linenos"> 38</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 39</span>    
<span class="linenos"> 40</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 41</span>
<span class="linenos"> 42</span>    <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 43</span>    <span class="n">tmp_users</span> <span class="o">=</span> <span class="n">get_number_of_table</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>
<span class="linenos"> 44</span>    <span class="n">tmp_modules</span> <span class="o">=</span> <span class="n">get_number_of_table</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">)</span>
<span class="linenos"> 45</span>    <span class="n">tmp_questions</span> <span class="o">=</span> <span class="n">get_number_of_table</span><span class="p">(</span><span class="s1">&#39;question&#39;</span><span class="p">)</span>
<span class="linenos"> 46</span>    <span class="n">tmp_answers</span> <span class="o">=</span> <span class="n">get_number_of_table</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">)</span>
<span class="linenos"> 47</span>    <span class="n">tmp_sessions</span> <span class="o">=</span> <span class="n">get_number_of_table</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="linenos"> 48</span>    <span class="n">tmp_recommendations</span> <span class="o">=</span> <span class="n">get_number_of_table</span><span class="p">(</span><span class="s1">&#39;recommendation&#39;</span><span class="p">)</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">tmp_users</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="linenos"> 51</span>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">tmp_modules</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="linenos"> 52</span>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">tmp_questions</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="linenos"> 53</span>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;answers&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">tmp_answers</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="linenos"> 54</span>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sessions&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">tmp_sessions</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="linenos"> 55</span>    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">tmp_recommendations</span> <span class="ow">or</span> <span class="mi">0</span>
<span class="linenos"> 56</span>
<span class="linenos"> 57</span>    <span class="c1"># &#39;May the Force be with you.&#39;</span>
<span class="linenos"> 58</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span> 
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 61</span><span class="sd">[Summary]: Get the number of users </span>
<span class="linenos"> 62</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 63</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 64</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/statistic/users&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 65</span><span class="k">def</span> <span class="nf">get_stats_user</span><span class="p">(</span><span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 66</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos"> 67</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 68</span>    
<span class="linenos"> 69</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 70</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 71</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 72</span>    
<span class="linenos"> 73</span>    <span class="c1"># Let&#39;s get the info from the databse.</span>
<span class="linenos"> 74</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 75</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 76</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 77</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(id) as size FROM user&quot;</span><span class="p">)</span>
<span class="linenos"> 78</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 79</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 80</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 81</span>    
<span class="linenos"> 82</span>    <span class="c1"># Check for empty results </span>
<span class="linenos"> 83</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 84</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 85</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 86</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 87</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos"> 88</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 89</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 90</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 91</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 92</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 93</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 94</span>            <span class="k">break</span>
<span class="linenos"> 95</span>    
<span class="linenos"> 96</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 97</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span>    <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">100</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">101</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> 
<span class="linenos">102</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">103</span>        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">104</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">105</span><span class="sd">[Summary]: Get the number of modules </span>
<span class="linenos">106</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">107</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">108</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/statistic/modules&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">109</span><span class="k">def</span> <span class="nf">get_stats_modules</span><span class="p">(</span><span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">110</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">111</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">112</span>    
<span class="linenos">113</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">114</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">115</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">116</span>    
<span class="linenos">117</span>    <span class="c1"># Let&#39;s get the info from the databse.</span>
<span class="linenos">118</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">119</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">120</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">121</span>        <span class="c1"># Top 5 only</span>
<span class="linenos">122</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT shortname, displayname, occurrences FROM module, (SELECT moduleID as mID, count(*) as occurrences FROM session GROUP BY moduleID ORDER BY occurrences DESC LIMIT 5) as Top5 WHERE ID = mID&quot;</span><span class="p">)</span>
<span class="linenos">123</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">124</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">125</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">126</span>    
<span class="linenos">127</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">128</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">129</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">130</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">131</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">132</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}))</span>
<span class="linenos">133</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">134</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">135</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">136</span>        <span class="n">tot_mod</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">137</span>        <span class="n">stat</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">138</span>        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">139</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">140</span>            <span class="n">module</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">141</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">142</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;displayname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">143</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">144</span>            <span class="n">tot_mod</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">145</span>            <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos">146</span>        
<span class="linenos">147</span>        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_mod</span>
<span class="linenos">148</span>
<span class="linenos">149</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> 
<span class="linenos">150</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">151</span>
<span class="linenos">152</span>    <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">153</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">154</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">stat</span><span class="p">))</span>
<span class="linenos">155</span>    <span class="k">else</span><span class="p">:</span> 
<span class="linenos">156</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&gt;&quot;</span> <span class="o">+</span> <span class="n">stat</span><span class="p">)</span>
<span class="linenos">157</span>        <span class="k">return</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
<span class="linenos">158</span>
<span class="linenos">159</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">160</span><span class="sd">[Summary]: Get the number of questions </span>
<span class="linenos">161</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">162</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">163</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/statistic/questions&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">164</span><span class="k">def</span> <span class="nf">get_stats_questions</span><span class="p">(</span><span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">165</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">166</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">167</span>
<span class="linenos">168</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">169</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">170</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">171</span>    
<span class="linenos">172</span>    <span class="c1"># Let&#39;s get the info from the databse.</span>
<span class="linenos">173</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">174</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">175</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">176</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(id) as size FROM question&quot;</span><span class="p">)</span>
<span class="linenos">177</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">178</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">179</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">180</span>    
<span class="linenos">181</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">182</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">183</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">184</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">185</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">186</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">187</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">188</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> 
<span class="linenos">189</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">190</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">191</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">192</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">193</span>            <span class="k">break</span>
<span class="linenos">194</span>    
<span class="linenos">195</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">196</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">197</span>
<span class="linenos">198</span>    <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">199</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">200</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">201</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">202</span>        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">203</span>
<span class="linenos">204</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">205</span><span class="sd">[Summary]: Get the number of answers </span>
<span class="linenos">206</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">207</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">208</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/statistic/answers&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">209</span><span class="k">def</span> <span class="nf">get_stats_answers</span><span class="p">(</span><span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">210</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">211</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">212</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">213</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">214</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">215</span>    
<span class="linenos">216</span>    <span class="c1"># Let&#39;s get the info from the databse.</span>
<span class="linenos">217</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">218</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">219</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">220</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(id) as size FROM answer&quot;</span><span class="p">)</span>
<span class="linenos">221</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">222</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">223</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">224</span>    
<span class="linenos">225</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">226</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">227</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">228</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">229</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">230</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">231</span>        <span class="k">else</span><span class="p">:</span> 
<span class="linenos">232</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">233</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">234</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">235</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">236</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">237</span>            <span class="k">break</span>
<span class="linenos">238</span>    
<span class="linenos">239</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">240</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">241</span>    <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">242</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">243</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">244</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">245</span>        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">246</span>
<span class="linenos">247</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">248</span><span class="sd">[Summary]: Get the number of recommendations </span>
<span class="linenos">249</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">250</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">251</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/statistic/recommendations&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">252</span><span class="k">def</span> <span class="nf">get_stats_recommendations</span><span class="p">(</span><span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">253</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">254</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">255</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">256</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">257</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">258</span>    
<span class="linenos">259</span>    <span class="c1"># Let&#39;s get the info from the databse.</span>
<span class="linenos">260</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">261</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">262</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">263</span>        <span class="c1"># Top 5 only</span>
<span class="linenos">264</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT content, occurrences FROM recommendation, (SELECT recommendationID as rID, count(*) as occurrences FROM session_recommendation GROUP BY recommendationID ORDER BY occurrences DESC LIMIT 5) as Top5 WHERE ID = rID;&quot;</span><span class="p">)</span>
<span class="linenos">265</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">266</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">267</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">268</span>    
<span class="linenos">269</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">270</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">271</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">272</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">273</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">274</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}))</span>
<span class="linenos">275</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">276</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">277</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">278</span>        <span class="n">tot_recm</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">279</span>        <span class="n">stat</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">280</span>        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">281</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">282</span>            <span class="n">recommendation</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">283</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">284</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">285</span>            <span class="n">tot_recm</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">286</span>            <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
<span class="linenos">287</span>        
<span class="linenos">288</span>        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tot_recm</span>
<span class="linenos">289</span>
<span class="linenos">290</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">291</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">292</span>    <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">293</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">294</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">stat</span><span class="p">))</span>
<span class="linenos">295</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">296</span>        <span class="k">return</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
<span class="linenos">297</span>
<span class="linenos">298</span>
<span class="linenos">299</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">300</span><span class="sd">[Summary]: Get the number of sessions in the last 7 days.</span>
<span class="linenos">301</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">302</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">303</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/statistic/sessions&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">304</span><span class="k">def</span> <span class="nf">get_stats_sessions</span><span class="p">(</span><span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">305</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">306</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">307</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">308</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">309</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">310</span>    
<span class="linenos">311</span>    <span class="c1"># Let&#39;s get the info from the databse.</span>
<span class="linenos">312</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">313</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">314</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">315</span>        <span class="c1"># Number of session in the Last 7 days sessions</span>
<span class="linenos">316</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT date(createdOn) as day, COUNT(*) as occurrences FROM session WHERE createdon &gt;= DATE_ADD(CURDATE(), INTERVAL -7 DAY) GROUP BY day&quot;</span><span class="p">)</span>
<span class="linenos">317</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">318</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">319</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">320</span>    
<span class="linenos">321</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">322</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">323</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">324</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">325</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">326</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}))</span>
<span class="linenos">327</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">328</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>   
<span class="linenos">329</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">330</span>        <span class="n">stat</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">331</span>        <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">332</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">333</span>            <span class="n">date</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">334</span>            <span class="n">date</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">335</span>            <span class="n">date</span><span class="p">[</span><span class="s1">&#39;occurrences&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">336</span>            <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
<span class="linenos">337</span>
<span class="linenos">338</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">339</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">340</span>
<span class="linenos">341</span>    <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">342</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">343</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">stat</span><span class="p">))</span>
<span class="linenos">344</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">345</span>        <span class="k">return</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
<span class="linenos">346</span>
<span class="linenos">347</span>
<span class="linenos">348</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">349</span><span class="sd">[Summary]: Get the amount of elements in a table. </span>
<span class="linenos">350</span><span class="sd">[Returns]: Integer.</span>
<span class="linenos">351</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">352</span><span class="k">def</span> <span class="nf">get_number_of_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">):</span>
<span class="linenos">353</span>    <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos">354</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">355</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">356</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">357</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(id) as size FROM &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
<span class="linenos">358</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">359</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">360</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">361</span>    
<span class="linenos">362</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
<span class="linenos">363</span>            <span class="n">size</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">364</span>
<span class="linenos">365</span>    <span class="k">return</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</pre></div>
</div>
</details><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/statistics</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the global statistics of the plataform.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>answers</strong> (<em>int</em>) – The total number of responses.</p></li>
<li><p><strong>modules</strong> (<em>int</em>) – The total number of modules.</p></li>
<li><p><strong>recommendations</strong> (<em>int</em>) – The total number of recommendations.</p></li>
<li><p><strong>sessions</strong> (<em>int</em>) – The total number of sessions executed by users.</p></li>
<li><p><strong>users</strong> (<em>int</em>) – The total number of registered users.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Statistics successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve statistics.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/statistics&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;users&quot;</span><span class="p">:</span><span class="mi">2</span>
      <span class="nt">&quot;modules&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
      <span class="nt">&quot;questions&quot;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span>
      <span class="nt">&quot;answers&quot;</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span>
      <span class="nt">&quot;recommendations&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
      <span class="nt">&quot;sessions&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/statistic/users</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the total number of users of the platform.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>size</strong> (<em>int</em>) – The total number of registered users.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Statistics successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve statistics.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/statistic/users&quot;</span><span class="p">:{</span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/statistic/modules</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the total number of modules of the platform.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>size</strong> (<em>int</em>) – The total number of modules.</p></li>
<li><p><strong>top</strong> (<em>array</em>) – An array that contains the topmost used modules.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Statistics successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve statistics.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/statistic/modules&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
      <span class="nt">&quot;top&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="nt">&quot;SRE&quot;</span>
            <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements&quot;</span><span class="p">,</span>
            <span class="nt">&quot;occurrences&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/statistic/questions</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the total number of questions of the platform.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>size</strong> (<em>int</em>) – The total number of questions.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Statistics successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve statistics.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/statistic/questions&quot;</span><span class="p">:{</span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span> <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/statistic/answers</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the total number of answers of the platform.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>size</strong> (<em>int</em>) – The total number of answers.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Statistics successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve statistics.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/statistic/answers&quot;</span><span class="p">:{</span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="mi">60</span><span class="p">,</span> <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/statistic/recommendations</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the total number of recommendations of the platform.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>size</strong> (<em>int</em>) – The total number of recommendations.</p></li>
<li><p><strong>top</strong> (<em>array</em>) – An array that contains the topmost given recommendations.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Statistics successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve statistics.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/statistic/recommendations&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
      <span class="nt">&quot;top&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
            <span class="nt">&quot;occurrences&quot;</span><span class="p">:</span><span class="mi">2</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/statistic/sessions</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the total number of sessions per day created by users of the platform.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>top</strong> (<em>array</em>) – An array that contains the number of sessions per day.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Statistics successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve statistics.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/statistic/sessions&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;top&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;date&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 00:00:00 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;occurrences&quot;</span><span class="p">:</span><span class="mi">2</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="authentication-services-api">
<h1>Authentication Services API<a class="headerlink" href="#authentication-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the authentication entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>user.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">jwt</span><span class="o">,</span> <span class="nn">ast</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">JWT_EXPIRATION_SECONDS</span><span class="p">,</span> <span class="n">RECAPTCHA_SECRET</span>
<span class="linenos"> 29</span><span class="kn">from</span> <span class="nn">email_validator</span> <span class="kn">import</span> <span class="n">validate_email</span><span class="p">,</span> <span class="n">EmailNotValidError</span>
<span class="linenos"> 30</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 31</span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="linenos"> 32</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="linenos"> 33</span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="linenos"> 34</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 35</span>
<span class="linenos"> 36</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 37</span><span class="sd">[Summary]: User Authentication Service (i.e., login).</span>
<span class="linenos"> 38</span><span class="sd">[Returns]: Returns a JSON object with the data of the user including a JWT authentication token.</span>
<span class="linenos"> 39</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 40</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 41</span><span class="k">def</span> <span class="nf">login_user</span><span class="p">():</span>
<span class="linenos"> 42</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
<span class="linenos"> 43</span>        <span class="c1"># 1. Validate and parse POST data.</span>
<span class="linenos"> 44</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">):</span>
<span class="linenos"> 45</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;The email cannot be empty&#39;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos"> 46</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psw&#39;</span><span class="p">):</span>
<span class="linenos"> 47</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;The password cannot be empty&#39;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos"> 48</span>        
<span class="linenos"> 49</span>        <span class="n">email</span>   <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
<span class="linenos"> 50</span>        <span class="n">psw</span>     <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">]</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>        <span class="c1"># 2. Connect to the DB and get the user info.</span>
<span class="linenos"> 53</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 54</span>            <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 55</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 56</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, email, psw, avatar, administrator FROM user WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<span class="linenos"> 57</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 58</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos"> 59</span>        <span class="c1"># 2.1. Check if the user exists.</span>
<span class="linenos"> 60</span>        <span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
<span class="linenos"> 61</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;A user with the specified email was not found&quot;</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span> 
<span class="linenos"> 62</span>        
<span class="linenos"> 63</span>        <span class="c1"># 2.2. Process the DB results.</span>
<span class="linenos"> 64</span>        <span class="n">records</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 65</span>        <span class="n">dbpsw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 66</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Create a new nice empty dictionary to be populated with data from the DB.</span>
<span class="linenos"> 67</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
<span class="linenos"> 68</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 69</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 70</span>            <span class="c1"># For security reasons lets not store the password in the dic.</span>
<span class="linenos"> 71</span>            <span class="n">dbpsw</span>               <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> 
<span class="linenos"> 72</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos"> 73</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_admin&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos"> 74</span>            <span class="c1"># Set the expiration time of the token, the JWT auth token will not be valid after x seconds</span>
<span class="linenos"> 75</span>            <span class="c1"># Default is a 15 minute session</span>
<span class="linenos"> 76</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">JWT_EXPIRATION_SECONDS</span><span class="p">))</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 79</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos"> 80</span>        
<span class="linenos"> 81</span>        <span class="c1"># Check if the hashed password of the database is the same as the one provided by the user.</span>
<span class="linenos"> 82</span>        <span class="k">if</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">dbpsw</span><span class="p">,</span> <span class="n">psw</span><span class="p">):</span>
<span class="linenos"> 83</span>            <span class="c1"># First, build the authentication token and added it to the dictionary.</span>
<span class="linenos"> 84</span>            <span class="c1"># Second, let&#39;s create a JSON response with the data of the dictionary.</span>
<span class="linenos"> 85</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
<span class="linenos"> 86</span>            
<span class="linenos"> 87</span>            <span class="c1"># Authentication success, the user &#39;can follow the white rabbit&#39;.</span>
<span class="linenos"> 88</span>            <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos"> 89</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 90</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure&quot;</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 93</span><span class="sd">[Summary]: Clear the list of expired blacklisted JSON Web Tokens of a user.</span>
<span class="linenos"> 94</span><span class="sd">[Arguments]:</span>
<span class="linenos"> 95</span><span class="sd">       - $userID$: Target user.</span>
<span class="linenos"> 96</span><span class="sd">[Returns]: Returns false, if an error occurs, true otherwise. </span>
<span class="linenos"> 97</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 98</span><span class="k">def</span> <span class="nf">clear_expired_blacklisted_JWT</span><span class="p">(</span><span class="n">userID</span><span class="p">):</span>
<span class="linenos"> 99</span>    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">100</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking blacklisted tokens for user id =&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">userID</span><span class="p">))</span>
<span class="linenos">101</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">102</span>        <span class="c1"># Check if this user id exists.</span>
<span class="linenos">103</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">104</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">105</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT token FROM auth_token_blackList WHERE userID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
<span class="linenos">106</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">107</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">108</span>        <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos">109</span>        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># &#39;Houston, we have a problem.&#39;</span>
<span class="linenos">110</span>    <span class="c1"># Empty results ?</span>
<span class="linenos">111</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">112</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">113</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">114</span>        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">115</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">116</span>        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
<span class="linenos">117</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span> 
<span class="linenos">118</span>            <span class="n">token</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span>            <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;# Checking token[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span> <span class="o">+</span> <span class="s2">&quot;= &quot;</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span>
<span class="linenos">120</span>            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">121</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">122</span>                <span class="c1"># Let&#39;s see if the token is expired</span>
<span class="linenos">123</span>                <span class="n">res_dic</span>  <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="linenos">124</span>                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - The token is still &#39;alive&#39;. Nothing to do here.&quot;</span><span class="p">)</span>
<span class="linenos">125</span>            <span class="k">except</span><span class="p">:</span>
<span class="linenos">126</span>                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - The token is expired, removing it from the database for user with id &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userID</span><span class="p">))</span>
<span class="linenos">127</span>                <span class="c1"># The token is expired, remove it from the DB</span>
<span class="linenos">128</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">129</span>                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM auth_token_blacklist WHERE token=</span><span class="si">%s</span><span class="s2"> AND userID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="n">userID</span><span class="p">))</span>
<span class="linenos">130</span>                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">131</span>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">132</span>                    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos">133</span>                    <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># &#39;Houston, we have a problem.&#39;</span>
<span class="linenos">134</span>    <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">137</span><span class="sd">[Summary]: Performs a logout using an JWT authentication token.</span>
<span class="linenos">138</span><span class="sd">[Returns]: 200 response if the user was successfully logged out.</span>
<span class="linenos">139</span><span class="sd">[ref]: Based on https://medium.com/devgorilla/how-to-log-out-when-using-jwt-a8c7823e8a6</span>
<span class="linenos">140</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">141</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos">142</span><span class="k">def</span> <span class="nf">logout_user</span><span class="p">():</span>
<span class="linenos">143</span>    <span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">144</span>    
<span class="linenos">145</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">146</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">147</span>    <span class="c1"># 1. Check if the token is available on the request header.</span>
<span class="linenos">148</span>    <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
<span class="linenos">149</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)))</span>
<span class="linenos">150</span>    
<span class="linenos">151</span>    <span class="c1"># 2. Check if the Authorization header name was parsed.</span>
<span class="linenos">152</span>    <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span> <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the permission to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">153</span>    <span class="n">token_parsed</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
<span class="linenos">154</span>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Bearer&quot;</span> <span class="ow">in</span> <span class="n">token_parsed</span><span class="p">):</span>
<span class="linenos">155</span>        <span class="n">token_parsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">token_parsed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">156</span>   
<span class="linenos">157</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsed Token:&quot;</span> <span class="o">+</span> <span class="n">token_parsed</span><span class="p">)</span>
<span class="linenos">158</span>    
<span class="linenos">159</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">160</span>        <span class="c1"># 3. From now on the token will be blacklisted because the user has logout and the token may still</span>
<span class="linenos">161</span>        <span class="c1">#    exists somewhere because its expiration date is still valid.</span>
<span class="linenos">162</span>        
<span class="linenos">163</span>        <span class="c1"># 3.1. Let&#39;s clean the house - Remove possible expired tokens from the user of the token</span>
<span class="linenos">164</span>        <span class="n">res_dic</span>  <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token_parsed</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
<span class="linenos">165</span>       
<span class="linenos">166</span>        <span class="n">userID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_dic</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">167</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">clear_expired_blacklisted_JWT</span><span class="p">(</span><span class="n">userID</span><span class="p">):</span> <span class="c1"># Sanity check</span>
<span class="linenos">168</span>            <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
<span class="linenos">169</span>        <span class="c1"># 3.2. Let&#39;s add the token to the blacklist table on the database for the current user</span>
<span class="linenos">170</span>        <span class="c1">#      That is, blacklist the current token, that may or may not be alive. </span>
<span class="linenos">171</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">172</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">173</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO auth_token_blacklist (userID, token) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">token_parsed</span><span class="p">))</span>
<span class="linenos">174</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">175</span>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The authentication token was blacklisted. The user should now be logouted on the client side.&quot;</span>
<span class="linenos">176</span>       
<span class="linenos">177</span>    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ExpiredSignatureError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">178</span>        <span class="c1"># We don&#39;t need to blacklist this token, the token is already expired (see &#39;exp&#39; field of the JWT defined in the authenticate function).</span>
<span class="linenos">179</span>        <span class="c1"># raise modules.error_handlers.BadRequest(request.path, str(e), 500) </span>
<span class="linenos">180</span>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The token has already expired, no need to blacklist it. The user should now be logouted on the client side.&quot;</span>
<span class="linenos">181</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">182</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
<span class="linenos">183</span>        <span class="c1"># Double token entry ?</span>
<span class="linenos">184</span>        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1062</span><span class="p">:</span>
<span class="linenos">185</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The token was already blacklisted. The user should now be logouted on the client side.&quot;</span>
<span class="linenos">186</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">187</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">188</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">189</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">190</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">191</span>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">192</span>        <span class="k">except</span><span class="p">:</span>
<span class="linenos">193</span>            <span class="k">pass</span> <span class="c1"># cursor or conn may not be defined, I don&#39;t care, &#39;Just keep swimming&#39;.</span>
<span class="linenos">194</span>    <span class="c1">#</span>
<span class="linenos">195</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">196</span>
<span class="linenos">197</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;/admin&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">198</span><span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="linenos">199</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">200</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">201</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">202</span>
<span class="linenos">203</span>    <span class="c1"># 2. Let&#39;s get the groups associated with the parsed user.</span>
<span class="linenos">204</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">205</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">206</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">207</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT email, administrator FROM user WHERE email=</span><span class="si">%s</span><span class="s2"> AND administrator=1&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span> 
<span class="linenos">208</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">209</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">210</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">211</span>
<span class="linenos">212</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">213</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">214</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">215</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">216</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}))</span> 
<span class="linenos">217</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">218</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">219</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">220</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">221</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}))</span>
<span class="linenos">222</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">223</span><span class="sd">[Summary]: User Registration Service (i.e., add a new user).</span>
<span class="linenos">224</span><span class="sd">[Returns]: Returns a JSON object with the data of the user including a JWT authentication token.</span>
<span class="linenos">225</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">226</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos">227</span><span class="k">def</span> <span class="nf">add_user</span><span class="p">():</span>
<span class="linenos">228</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">229</span>
<span class="linenos">230</span>    <span class="c1"># 1. Let&#39;s get our shiny new JSON object and current time.</span>
<span class="linenos">231</span>    <span class="c1"># - Always start by validating the structure of the json, if not valid send an invalid response.</span>
<span class="linenos">232</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">233</span>        <span class="n">obj</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<span class="linenos">234</span>        <span class="n">obj</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="linenos">235</span>
<span class="linenos">236</span>        <span class="n">date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="linenos">237</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">238</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">239</span>
<span class="linenos">240</span>    <span class="c1"># 2. Let&#39;s validate the data of our JSON object with a custom function.</span>
<span class="linenos">241</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;psw&quot;</span><span class="p">,</span> <span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="s2">&quot;lastname&quot;</span><span class="p">,</span> <span class="s2">&quot;avatar&quot;</span><span class="p">,</span> <span class="s2">&quot;g-recaptcha-response&quot;</span><span class="p">})):</span>
<span class="linenos">242</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="linenos">243</span>
<span class="linenos">244</span>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;insomnia&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">)):</span>
<span class="linenos">245</span>        <span class="c1"># 3. Validate reCAPTCHA</span>
<span class="linenos">246</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_human</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;g-recaptcha-response&#39;</span><span class="p">]):</span>
<span class="linenos">247</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;reCAPTCHA failure - Bots are not allowed.&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="linenos">248</span>
<span class="linenos">249</span>    <span class="c1"># 4. Let&#39;s hash the hell of the password.</span>
<span class="linenos">250</span>    <span class="n">hashed_psw</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hash_password</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">])</span>
<span class="linenos">251</span>    <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># &quot;paranoic mode&quot;.</span>
<span class="linenos">252</span>    
<span class="linenos">253</span>    <span class="c1"># 5. Check if the user was not previously registered in the DB (i.e., same email)</span>
<span class="linenos">254</span>    <span class="k">if</span> <span class="p">(</span><span class="n">find_user</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">255</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;The user with that email already exists&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">256</span>
<span class="linenos">257</span>    <span class="c1"># 6. Connect to the database and create the new user.</span>
<span class="linenos">258</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">259</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">260</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">261</span>        <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos">262</span>        <span class="nb">print</span><span class="p">(</span><span class="n">hashed_psw</span><span class="p">)</span>
<span class="linenos">263</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO user (email, psw, firstName, lastName, avatar, createdon, updatedon) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">hashed_psw</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;firstname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;lastname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">],</span> <span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
<span class="linenos">264</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">265</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">266</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&gt;&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos">267</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">268</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">269</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">270</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">271</span>
<span class="linenos">272</span>    <span class="c1"># 7. Authentication success, the user can now choose to &#39;take the red or blue pill to follow the white rabbit&#39;</span>
<span class="linenos">273</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">274</span>
<span class="linenos">275</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">276</span><span class="sd">[Summary]: Get users.</span>
<span class="linenos">277</span><span class="sd">[Returns]: Returns a User object.</span>
<span class="linenos">278</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">279</span><span class="c1"># Check if a user exists</span>
<span class="linenos">280</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">281</span><span class="k">def</span> <span class="nf">get_users</span><span class="p">():</span>
<span class="linenos">282</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">283</span>
<span class="linenos">284</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">285</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">286</span>    
<span class="linenos">287</span>    <span class="c1"># 3. Let&#39;s get users from the database.</span>
<span class="linenos">288</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">289</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">290</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">291</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, email, firstName, lastName, avatar, userStatus, administrator, createdon, updatedon FROM user&quot;</span><span class="p">)</span>
<span class="linenos">292</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">293</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">294</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">295</span>    
<span class="linenos">296</span>    <span class="c1"># Empty results ?</span>
<span class="linenos">297</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">298</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">299</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">300</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">301</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">302</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="linenos">303</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">304</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">305</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">306</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">307</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;firstName&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">308</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastName&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">309</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">310</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_status&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">311</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;administrator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos">312</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="linenos">313</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="linenos">314</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">315</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">316</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">317</span>        <span class="c1"># 4. Return information about the user (except the password) and &#39;May the Force be with you&#39;.</span>
<span class="linenos">318</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos">319</span>
<span class="linenos">320</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">321</span><span class="sd">[Summary]: Finds a user by email.</span>
<span class="linenos">322</span><span class="sd">[Returns]: Returns a User object.</span>
<span class="linenos">323</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">324</span><span class="c1"># Check if a user exists</span>
<span class="linenos">325</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">326</span><span class="k">def</span> <span class="nf">find_user</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">327</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">328</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">329</span>
<span class="linenos">330</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">331</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">332</span>        <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">333</span>       
<span class="linenos">334</span>    <span class="c1"># 2. Let&#39;s validate the email, invalid emails from this point are not allowed.</span>
<span class="linenos">335</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">336</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="linenos">337</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">338</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">339</span>    
<span class="linenos">340</span>    <span class="c1"># 3. Let&#39;s get the user from the database with the provided [email].</span>
<span class="linenos">341</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">342</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">343</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">344</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, email, firstName, lastName, avatar FROM user WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<span class="linenos">345</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">346</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">347</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">348</span>    
<span class="linenos">349</span>    <span class="c1"># Empty results ?</span>
<span class="linenos">350</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">351</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">352</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">353</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">354</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">355</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">356</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">357</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">358</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Create a new nice empty dictionary to be populated with data from the DB.</span>
<span class="linenos">359</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">360</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">361</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">362</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;firstName&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">363</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastName&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">364</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">365</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">366</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">367</span>
<span class="linenos">368</span>        <span class="c1"># 4. Return information about the user (except the password) and &#39;May the Force be with you&#39;.</span>
<span class="linenos">369</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">370</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">371</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">372</span>            <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">373</span>
<span class="linenos">374</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">375</span><span class="sd">[Summary]: Delete a user</span>
<span class="linenos">376</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">377</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">378</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos">379</span><span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="linenos">380</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">381</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">382</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">383</span>  
<span class="linenos">384</span>    <span class="c1"># 2. Let&#39;s validate the email, invalid emails from this point are not allowed.</span>
<span class="linenos">385</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">386</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="linenos">387</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">388</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">389</span>
<span class="linenos">390</span>    <span class="c1"># 3. Connect to the database and delete the user</span>
<span class="linenos">391</span>    <span class="c1"># TODO: Let&#39;s build procedures in the DB to delete Users. </span>
<span class="linenos">392</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">393</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">394</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">395</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM user WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<span class="linenos">396</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">397</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">398</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">399</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">400</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">401</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">402</span>
<span class="linenos">403</span>    <span class="c1"># 4. The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">404</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">405</span>
<span class="linenos">406</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">407</span><span class="sd">[Summary]: Updates a user</span>
<span class="linenos">408</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">409</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">410</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="linenos">411</span><span class="k">def</span> <span class="nf">update_user</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="linenos">412</span>    <span class="n">updatePsw</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">413</span>    <span class="c1"># Note: Remember that if an email is being changed, the email argument is the old one; </span>
<span class="linenos">414</span>    <span class="c1">#       The new email content is available on the JSON object parsed in the body of the request.  </span>
<span class="linenos">415</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">416</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">417</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">418</span>
<span class="linenos">419</span>    <span class="c1"># 2. Let&#39;s validate the email, invalid emails from this point are not allowed.</span>
<span class="linenos">420</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">421</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="linenos">422</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">423</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">424</span>
<span class="linenos">425</span>    <span class="c1"># 3. Let&#39;s get our shiny new JSON object and current time.</span>
<span class="linenos">426</span>    <span class="c1"># - Always start by validating the structure of the json, if not valid send an invalid response.</span>
<span class="linenos">427</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">428</span>        <span class="n">obj</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<span class="linenos">429</span>        <span class="n">date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="linenos">430</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">431</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">432</span>
<span class="linenos">433</span>
<span class="linenos">434</span>    <span class="c1"># 4. Let&#39;s validate the data of our JSON object with a custom function.</span>
<span class="linenos">435</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;avatar&quot;</span><span class="p">,</span> <span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="s2">&quot;lastname&quot;</span><span class="p">})):</span>
<span class="linenos">436</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="linenos">437</span>
<span class="linenos">438</span>    <span class="c1"># 4.1. Let&#39;s also validate the new email, invalid emails from this point are not allowed.</span>
<span class="linenos">439</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">440</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
<span class="linenos">441</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">442</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">443</span>
<span class="linenos">444</span>    <span class="c1"># 5. Hash the new password and store it (if supplied)</span>
<span class="linenos">445</span>    <span class="k">if</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;psw&quot;</span><span class="p">})):</span>
<span class="linenos">446</span>        <span class="n">updatePsw</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">447</span>        <span class="n">hashed_psw</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hash_password</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">])</span>
<span class="linenos">448</span>        <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># &quot;paranoic mode&quot;.</span>
<span class="linenos">449</span>
<span class="linenos">450</span>    <span class="c1"># 6. Connect to the database and update the user with the data of the parsed json object</span>
<span class="linenos">451</span>    <span class="c1"># TODO: - Let&#39;s build procedures in the DB to update Users. </span>
<span class="linenos">452</span>    <span class="c1">#       - Let&#39;s not update every single field of the User, instead, let&#39;s just updated the one that has changed.</span>
<span class="linenos">453</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">454</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">455</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">456</span>        <span class="k">if</span> <span class="p">(</span><span class="n">updatePsw</span><span class="p">):</span>
<span class="linenos">457</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE user SET email=</span><span class="si">%s</span><span class="s2">, psw=</span><span class="si">%s</span><span class="s2">, firstName=</span><span class="si">%s</span><span class="s2">, lastName=</span><span class="si">%s</span><span class="s2">, avatar=</span><span class="si">%s</span><span class="s2">, updatedOn=</span><span class="si">%s</span><span class="s2"> WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">hashed_psw</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;firstname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;lastname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">],</span><span class="n">date</span><span class="p">,</span><span class="n">email</span><span class="p">))</span>
<span class="linenos">458</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">459</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE user SET email=</span><span class="si">%s</span><span class="s2">, firstName=</span><span class="si">%s</span><span class="s2">, lastName=</span><span class="si">%s</span><span class="s2">, avatar=</span><span class="si">%s</span><span class="s2">, updatedOn=</span><span class="si">%s</span><span class="s2"> WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;firstname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;lastname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">],</span><span class="n">date</span><span class="p">,</span><span class="n">email</span><span class="p">))</span>    
<span class="linenos">460</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">461</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">462</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">463</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">464</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">465</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">466</span>
<span class="linenos">467</span>    <span class="c1"># 4. The Update request was a success, the user &#39;is in the rabbit hole&#39;</span>
<span class="linenos">468</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">469</span>
<span class="linenos">470</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">471</span><span class="sd">[Summary]: Finds groups of a user.</span>
<span class="linenos">472</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">473</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">474</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;/groups&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="linenos">475</span><span class="k">def</span> <span class="nf">find_user_groups</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="linenos">476</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">477</span>
<span class="linenos">478</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">479</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">480</span>       
<span class="linenos">481</span>    <span class="c1"># 2. Let&#39;s validate the email, invalid emails from this point are not allowed.</span>
<span class="linenos">482</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">483</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="linenos">484</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">485</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">486</span>    
<span class="linenos">487</span>    <span class="c1"># 3. Let&#39;s get the user from the database with the provided [email].</span>
<span class="linenos">488</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">489</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">490</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">491</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT user_id, user_email, user_group FROM view_user_group WHERE user_email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<span class="linenos">492</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">493</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">494</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">495</span>    
<span class="linenos">496</span>    <span class="c1"># Empty results ?</span>
<span class="linenos">497</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">498</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">499</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">500</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">501</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">502</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">503</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">504</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Create a new nice empty dictionary to be populated with data from the DB.</span>
<span class="linenos">505</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">506</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_email&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">507</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_group&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">508</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">509</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">510</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">511</span>        <span class="c1"># 4. Return information about the user (except the password) and &#39;May the Force be with you&#39;.</span>
<span class="linenos">512</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos">513</span>
<span class="linenos">514</span><span class="sd">&quot;&quot;&quot; [Summary]: Validates recaptcha response from google server.</span>
<span class="linenos">515</span><span class="sd">    [Returns]: Returns True captcha test passed, false otherwise.</span>
<span class="linenos">516</span><span class="sd">    [TODO]: In a production environment the client and server key should be reconfigured.</span>
<span class="linenos">517</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">518</span><span class="k">def</span> <span class="nf">is_human</span><span class="p">(</span><span class="n">captcha_response</span><span class="p">):</span>
<span class="linenos">519</span>    <span class="c1"># https://www.google.com/recaptcha/</span>
<span class="linenos">520</span>    <span class="n">secret</span> <span class="o">=</span> <span class="n">RECAPTCHA_SECRET</span>
<span class="linenos">521</span>    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;response&#39;</span><span class="p">:</span><span class="n">captcha_response</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">:</span><span class="n">secret</span><span class="p">}</span>
<span class="linenos">522</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;https://www.google.com/recaptcha/api/siteverify&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="linenos">523</span>    <span class="n">response_text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">524</span>    <span class="k">return</span> <span class="n">response_text</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span>
<span class="linenos">525</span>
<span class="linenos">526</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">527</span><span class="sd">[Summary]: Check if the user has the necessary permissions to access a service.</span>
<span class="linenos">528</span><span class="sd">[Returns]: True if access is granted to access the resource, false otherwise.</span>
<span class="linenos">529</span><span class="sd">[ref]: CHECK THIS: https://medium.com/devgorilla/how-to-log-out-when-using-jwt-a8c7823e8a6</span>
<span class="linenos">530</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">531</span><span class="k">def</span> <span class="nf">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="linenos">532</span>    <span class="c1"># 1. Check if the token is available on the request header.</span>
<span class="linenos">533</span>    <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
<span class="linenos">534</span>    <span class="c1"># Debug only: print(str(len(headers)))</span>
<span class="linenos">535</span>    
<span class="linenos">536</span>    <span class="c1"># 2. Check if the Authorization header name was parsed.</span>
<span class="linenos">537</span>    <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span> <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the permission to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">538</span>    <span class="n">parsedToken</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
<span class="linenos">539</span>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Bearer&quot;</span> <span class="ow">in</span> <span class="n">parsedToken</span><span class="p">):</span>
<span class="linenos">540</span>        <span class="n">parsedToken</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsedToken</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">541</span>    
<span class="linenos">542</span>    <span class="c1"># 3. Decode the authorization token to get the User object.</span>
<span class="linenos">543</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">544</span>        <span class="c1"># Decode will raise an exception if anything goes wrong within the decoding process (i.e., perform validation of the JWT).</span>
<span class="linenos">545</span>        <span class="n">res_dic</span>  <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">parsedToken</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
<span class="linenos">546</span>        <span class="c1"># Get the ID of the user.</span>
<span class="linenos">547</span>        <span class="n">userID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_dic</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">548</span>        <span class="c1"># Debug only: print(str(json.dumps(res_dic)))</span>
<span class="linenos">549</span>       
<span class="linenos">550</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">551</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">552</span>        <span class="c1"># 3.1. Check if the token is not blacklisted, that is if a user was previously logged out from the platform but the token is still &#39;alive&#39;.</span>
<span class="linenos">553</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM auth_token_blacklist WHERE userID=</span><span class="si">%s</span><span class="s2"> AND token=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">parsedToken</span><span class="p">))</span>
<span class="linenos">554</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">555</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">556</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the necessary permissions to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">557</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">558</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">559</span>
<span class="linenos">560</span>        <span class="c1"># 3.2. Get info of the user</span>
<span class="linenos">561</span>        <span class="c1"># Check if this user id exists.</span>
<span class="linenos">562</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM user WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
<span class="linenos">563</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">564</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">565</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">566</span>
<span class="linenos">567</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
<span class="linenos">568</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">569</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos">570</span>        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># The user is legit, we can let him access the target resource </span>
<span class="linenos">571</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">572</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">573</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos">574</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the necessary permissions to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">575</span>
<span class="linenos">576</span><span class="sd">&quot;&quot;&quot; TODO: Merge this function with the previous one. This function is used to make sure that only admins access particular services.&quot;&quot;&quot;</span>
<span class="linenos">577</span><span class="k">def</span> <span class="nf">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="linenos">578</span>    <span class="c1"># 1. Check if the token is available on the request header.</span>
<span class="linenos">579</span>    <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
<span class="linenos">580</span>    <span class="c1"># Debug only: print(str(len(headers)))</span>
<span class="linenos">581</span>    
<span class="linenos">582</span>    <span class="c1"># 2. Check if the Authorization header name was parsed.</span>
<span class="linenos">583</span>    <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span> <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the permission to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">584</span>    <span class="n">parsedToken</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
<span class="linenos">585</span>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Bearer&quot;</span> <span class="ow">in</span> <span class="n">parsedToken</span><span class="p">):</span>
<span class="linenos">586</span>        <span class="n">parsedToken</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsedToken</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">587</span>    
<span class="linenos">588</span>    <span class="c1"># 3. Decode the authorization token to get the User object.</span>
<span class="linenos">589</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">590</span>        <span class="c1"># Decode will raise an exception if anything goes wrong within the decoding process (i.e., perform validation of the JWT).</span>
<span class="linenos">591</span>        <span class="n">res_dic</span>  <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">parsedToken</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
<span class="linenos">592</span>        <span class="c1"># Get the ID of the user.</span>
<span class="linenos">593</span>        <span class="n">userID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_dic</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">594</span>        <span class="c1"># Debug only: print(str(json.dumps(res_dic)))</span>
<span class="linenos">595</span>        <span class="c1"># The user is not an administrator</span>
<span class="linenos">596</span>        <span class="k">if</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_dic</span><span class="p">[</span><span class="s1">&#39;is_admin&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">597</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the permission to access this resource.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">598</span>        
<span class="linenos">599</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">600</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">601</span>        <span class="c1"># 3.1. Check if the token is not blacklisted, that is if a user was previously logged out from the platform but the token is still &#39;alive&#39;.</span>
<span class="linenos">602</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM auth_token_blacklist WHERE userID=</span><span class="si">%s</span><span class="s2"> AND token=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">parsedToken</span><span class="p">))</span>
<span class="linenos">603</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">604</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">605</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the necessary permissions to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">606</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">607</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">608</span>
<span class="linenos">609</span>        <span class="c1"># 3.2. Get info of the user</span>
<span class="linenos">610</span>        <span class="c1"># Check if this user id exists.</span>
<span class="linenos">611</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM user WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
<span class="linenos">612</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">613</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">614</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">615</span>
<span class="linenos">616</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
<span class="linenos">617</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">618</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos">619</span>        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># The user is legit, we can let him access the target resource </span>
<span class="linenos">620</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">621</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">622</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos">623</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the necessary permissions to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
</pre></div>
</div>
</details><section id="authenticate-user">
<h2>Authenticate User<a class="headerlink" href="#authenticate-user" title="Permalink to this headline"></a></h2>
<span class="target" id="authenticate"></span><dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/user/login</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Authenticate user with an email and password. The authentication process returns a bearer JWT used to grant users access to SAM’s Web services.</p>
</dd>
<dt class="field-even">Response Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – multipart/form-data</p></li>
</ul>
</dd>
<dt class="field-odd">Form Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>email</strong> – The email of the user to be authenticated.</p></li>
<li><p><strong>psw</strong> – The user password.</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the user.</p></li>
<li><p><strong>email</strong> (<em>string</em>) – The email of the user.</p></li>
<li><p><strong>avatar</strong> (<em>string</em>) – Avatar of the user (i.e., location in disk).</p></li>
<li><p><strong>is_admin</strong> (<em>boolean</em>) – Is the user an administrator.</p></li>
<li><p><strong>exp</strong> (<em>int</em>) – Expiration time of the token in seconds.</p></li>
<li><p><strong>token</strong> (<em>string</em>) – The bearer JWT.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Users successfully authenticated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.2">401 Unauthorized</a></span> – Fail to authenticate user / Unauthorized.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Internal server error.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/user/login&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;forrest@sam.pt&quot;</span><span class="p">,</span>
      <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
      <span class="nt">&quot;is_admin&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="nt">&quot;exp&quot;</span><span class="p">:</span><span class="mi">1637410963</span><span class="p">,</span>
      <span class="nt">&quot;token&quot;</span><span class="p">:</span><span class="nt">&quot;eyJ0eXAiOiJKV1QiLCJhb...&quot;</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default the JSON Web Token (JWT) authentication token will expire after 15 minutes.</p>
</div>
</section>
<section id="logout-user">
<h2>Logout User<a class="headerlink" href="#logout-user" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/user/logout</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Logout user with the provided authentication token that should be available in the <code class="docutils literal notranslate"><span class="pre">Authorization</span></code> request header.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – User was successfully logged out.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Unable to logout user.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/user/logout&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="user-services-api">
<h1>User Services API<a class="headerlink" href="#user-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the group entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>user.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">jwt</span><span class="o">,</span> <span class="nn">ast</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">JWT_EXPIRATION_SECONDS</span><span class="p">,</span> <span class="n">RECAPTCHA_SECRET</span>
<span class="linenos"> 29</span><span class="kn">from</span> <span class="nn">email_validator</span> <span class="kn">import</span> <span class="n">validate_email</span><span class="p">,</span> <span class="n">EmailNotValidError</span>
<span class="linenos"> 30</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 31</span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="linenos"> 32</span><span class="kn">import</span> <span class="nn">requests</span>
<span class="linenos"> 33</span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="linenos"> 34</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 35</span>
<span class="linenos"> 36</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 37</span><span class="sd">[Summary]: User Authentication Service (i.e., login).</span>
<span class="linenos"> 38</span><span class="sd">[Returns]: Returns a JSON object with the data of the user including a JWT authentication token.</span>
<span class="linenos"> 39</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 40</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 41</span><span class="k">def</span> <span class="nf">login_user</span><span class="p">():</span>
<span class="linenos"> 42</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
<span class="linenos"> 43</span>        <span class="c1"># 1. Validate and parse POST data.</span>
<span class="linenos"> 44</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">):</span>
<span class="linenos"> 45</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;The email cannot be empty&#39;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos"> 46</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;psw&#39;</span><span class="p">):</span>
<span class="linenos"> 47</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;The password cannot be empty&#39;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos"> 48</span>        
<span class="linenos"> 49</span>        <span class="n">email</span>   <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
<span class="linenos"> 50</span>        <span class="n">psw</span>     <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">]</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>        <span class="c1"># 2. Connect to the DB and get the user info.</span>
<span class="linenos"> 53</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 54</span>            <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 55</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 56</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, email, psw, avatar, administrator FROM user WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<span class="linenos"> 57</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 58</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos"> 59</span>        <span class="c1"># 2.1. Check if the user exists.</span>
<span class="linenos"> 60</span>        <span class="k">if</span> <span class="p">(</span><span class="n">cursor</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
<span class="linenos"> 61</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;A user with the specified email was not found&quot;</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span> 
<span class="linenos"> 62</span>        
<span class="linenos"> 63</span>        <span class="c1"># 2.2. Process the DB results.</span>
<span class="linenos"> 64</span>        <span class="n">records</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 65</span>        <span class="n">dbpsw</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 66</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Create a new nice empty dictionary to be populated with data from the DB.</span>
<span class="linenos"> 67</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
<span class="linenos"> 68</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 69</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 70</span>            <span class="c1"># For security reasons lets not store the password in the dic.</span>
<span class="linenos"> 71</span>            <span class="n">dbpsw</span>               <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> 
<span class="linenos"> 72</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos"> 73</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_admin&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos"> 74</span>            <span class="c1"># Set the expiration time of the token, the JWT auth token will not be valid after x seconds</span>
<span class="linenos"> 75</span>            <span class="c1"># Default is a 15 minute session</span>
<span class="linenos"> 76</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;exp&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">JWT_EXPIRATION_SECONDS</span><span class="p">))</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 79</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos"> 80</span>        
<span class="linenos"> 81</span>        <span class="c1"># Check if the hashed password of the database is the same as the one provided by the user.</span>
<span class="linenos"> 82</span>        <span class="k">if</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">dbpsw</span><span class="p">,</span> <span class="n">psw</span><span class="p">):</span>
<span class="linenos"> 83</span>            <span class="c1"># First, build the authentication token and added it to the dictionary.</span>
<span class="linenos"> 84</span>            <span class="c1"># Second, let&#39;s create a JSON response with the data of the dictionary.</span>
<span class="linenos"> 85</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
<span class="linenos"> 86</span>            
<span class="linenos"> 87</span>            <span class="c1"># Authentication success, the user &#39;can follow the white rabbit&#39;.</span>
<span class="linenos"> 88</span>            <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos"> 89</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 90</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure&quot;</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 93</span><span class="sd">[Summary]: Clear the list of expired blacklisted JSON Web Tokens of a user.</span>
<span class="linenos"> 94</span><span class="sd">[Arguments]:</span>
<span class="linenos"> 95</span><span class="sd">       - $userID$: Target user.</span>
<span class="linenos"> 96</span><span class="sd">[Returns]: Returns false, if an error occurs, true otherwise. </span>
<span class="linenos"> 97</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 98</span><span class="k">def</span> <span class="nf">clear_expired_blacklisted_JWT</span><span class="p">(</span><span class="n">userID</span><span class="p">):</span>
<span class="linenos"> 99</span>    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">100</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking blacklisted tokens for user id =&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">userID</span><span class="p">))</span>
<span class="linenos">101</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">102</span>        <span class="c1"># Check if this user id exists.</span>
<span class="linenos">103</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">104</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">105</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT token FROM auth_token_blackList WHERE userID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
<span class="linenos">106</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">107</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">108</span>        <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos">109</span>        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># &#39;Houston, we have a problem.&#39;</span>
<span class="linenos">110</span>    <span class="c1"># Empty results ?</span>
<span class="linenos">111</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">112</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">113</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">114</span>        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">115</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">116</span>        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
<span class="linenos">117</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span> 
<span class="linenos">118</span>            <span class="n">token</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">119</span>            <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;# Checking token[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span> <span class="o">+</span> <span class="s2">&quot;= &quot;</span> <span class="o">+</span> <span class="n">token</span><span class="p">)</span>
<span class="linenos">120</span>            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="linenos">121</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">122</span>                <span class="c1"># Let&#39;s see if the token is expired</span>
<span class="linenos">123</span>                <span class="n">res_dic</span>  <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="linenos">124</span>                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - The token is still &#39;alive&#39;. Nothing to do here.&quot;</span><span class="p">)</span>
<span class="linenos">125</span>            <span class="k">except</span><span class="p">:</span>
<span class="linenos">126</span>                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - The token is expired, removing it from the database for user with id &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">userID</span><span class="p">))</span>
<span class="linenos">127</span>                <span class="c1"># The token is expired, remove it from the DB</span>
<span class="linenos">128</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">129</span>                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM auth_token_blacklist WHERE token=</span><span class="si">%s</span><span class="s2"> AND userID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="n">userID</span><span class="p">))</span>
<span class="linenos">130</span>                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">131</span>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">132</span>                    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos">133</span>                    <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># &#39;Houston, we have a problem.&#39;</span>
<span class="linenos">134</span>    <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">137</span><span class="sd">[Summary]: Performs a logout using an JWT authentication token.</span>
<span class="linenos">138</span><span class="sd">[Returns]: 200 response if the user was successfully logged out.</span>
<span class="linenos">139</span><span class="sd">[ref]: Based on https://medium.com/devgorilla/how-to-log-out-when-using-jwt-a8c7823e8a6</span>
<span class="linenos">140</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">141</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/logout&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos">142</span><span class="k">def</span> <span class="nf">logout_user</span><span class="p">():</span>
<span class="linenos">143</span>    <span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">144</span>    
<span class="linenos">145</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">146</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">147</span>    <span class="c1"># 1. Check if the token is available on the request header.</span>
<span class="linenos">148</span>    <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
<span class="linenos">149</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">headers</span><span class="p">)))</span>
<span class="linenos">150</span>    
<span class="linenos">151</span>    <span class="c1"># 2. Check if the Authorization header name was parsed.</span>
<span class="linenos">152</span>    <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span> <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the permission to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">153</span>    <span class="n">token_parsed</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
<span class="linenos">154</span>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Bearer&quot;</span> <span class="ow">in</span> <span class="n">token_parsed</span><span class="p">):</span>
<span class="linenos">155</span>        <span class="n">token_parsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">token_parsed</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">156</span>   
<span class="linenos">157</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsed Token:&quot;</span> <span class="o">+</span> <span class="n">token_parsed</span><span class="p">)</span>
<span class="linenos">158</span>    
<span class="linenos">159</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">160</span>        <span class="c1"># 3. From now on the token will be blacklisted because the user has logout and the token may still</span>
<span class="linenos">161</span>        <span class="c1">#    exists somewhere because its expiration date is still valid.</span>
<span class="linenos">162</span>        
<span class="linenos">163</span>        <span class="c1"># 3.1. Let&#39;s clean the house - Remove possible expired tokens from the user of the token</span>
<span class="linenos">164</span>        <span class="n">res_dic</span>  <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">token_parsed</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
<span class="linenos">165</span>       
<span class="linenos">166</span>        <span class="n">userID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_dic</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">167</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">clear_expired_blacklisted_JWT</span><span class="p">(</span><span class="n">userID</span><span class="p">):</span> <span class="c1"># Sanity check</span>
<span class="linenos">168</span>            <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
<span class="linenos">169</span>        <span class="c1"># 3.2. Let&#39;s add the token to the blacklist table on the database for the current user</span>
<span class="linenos">170</span>        <span class="c1">#      That is, blacklist the current token, that may or may not be alive. </span>
<span class="linenos">171</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">172</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">173</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO auth_token_blacklist (userID, token) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">token_parsed</span><span class="p">))</span>
<span class="linenos">174</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">175</span>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The authentication token was blacklisted. The user should now be logouted on the client side.&quot;</span>
<span class="linenos">176</span>       
<span class="linenos">177</span>    <span class="k">except</span> <span class="n">jwt</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ExpiredSignatureError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">178</span>        <span class="c1"># We don&#39;t need to blacklist this token, the token is already expired (see &#39;exp&#39; field of the JWT defined in the authenticate function).</span>
<span class="linenos">179</span>        <span class="c1"># raise modules.error_handlers.BadRequest(request.path, str(e), 500) </span>
<span class="linenos">180</span>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The token has already expired, no need to blacklist it. The user should now be logouted on the client side.&quot;</span>
<span class="linenos">181</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">182</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span> <span class="p">:</span>
<span class="linenos">183</span>        <span class="c1"># Double token entry ?</span>
<span class="linenos">184</span>        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1062</span><span class="p">:</span>
<span class="linenos">185</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The token was already blacklisted. The user should now be logouted on the client side.&quot;</span>
<span class="linenos">186</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">187</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">188</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">189</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">190</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">191</span>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">192</span>        <span class="k">except</span><span class="p">:</span>
<span class="linenos">193</span>            <span class="k">pass</span> <span class="c1"># cursor or conn may not be defined, I don&#39;t care, &#39;Just keep swimming&#39;.</span>
<span class="linenos">194</span>    <span class="c1">#</span>
<span class="linenos">195</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">196</span>
<span class="linenos">197</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;/admin&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">198</span><span class="k">def</span> <span class="nf">is_admin</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="linenos">199</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">200</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">201</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">202</span>
<span class="linenos">203</span>    <span class="c1"># 2. Let&#39;s get the groups associated with the parsed user.</span>
<span class="linenos">204</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">205</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">206</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">207</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT email, administrator FROM user WHERE email=</span><span class="si">%s</span><span class="s2"> AND administrator=1&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span> 
<span class="linenos">208</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">209</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">210</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">211</span>
<span class="linenos">212</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">213</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">214</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">215</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">216</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}))</span> 
<span class="linenos">217</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">218</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">219</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">220</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">221</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;admin&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}))</span>
<span class="linenos">222</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">223</span><span class="sd">[Summary]: User Registration Service (i.e., add a new user).</span>
<span class="linenos">224</span><span class="sd">[Returns]: Returns a JSON object with the data of the user including a JWT authentication token.</span>
<span class="linenos">225</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">226</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos">227</span><span class="k">def</span> <span class="nf">add_user</span><span class="p">():</span>
<span class="linenos">228</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">229</span>
<span class="linenos">230</span>    <span class="c1"># 1. Let&#39;s get our shiny new JSON object and current time.</span>
<span class="linenos">231</span>    <span class="c1"># - Always start by validating the structure of the json, if not valid send an invalid response.</span>
<span class="linenos">232</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">233</span>        <span class="n">obj</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<span class="linenos">234</span>        <span class="n">obj</span><span class="o">=</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<span class="linenos">235</span>
<span class="linenos">236</span>        <span class="n">date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="linenos">237</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">238</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">239</span>
<span class="linenos">240</span>    <span class="c1"># 2. Let&#39;s validate the data of our JSON object with a custom function.</span>
<span class="linenos">241</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;psw&quot;</span><span class="p">,</span> <span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="s2">&quot;lastname&quot;</span><span class="p">,</span> <span class="s2">&quot;avatar&quot;</span><span class="p">,</span> <span class="s2">&quot;g-recaptcha-response&quot;</span><span class="p">})):</span>
<span class="linenos">242</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="linenos">243</span>
<span class="linenos">244</span>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;insomnia&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">)):</span>
<span class="linenos">245</span>        <span class="c1"># 3. Validate reCAPTCHA</span>
<span class="linenos">246</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_human</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;g-recaptcha-response&#39;</span><span class="p">]):</span>
<span class="linenos">247</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;reCAPTCHA failure - Bots are not allowed.&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="linenos">248</span>
<span class="linenos">249</span>    <span class="c1"># 4. Let&#39;s hash the hell of the password.</span>
<span class="linenos">250</span>    <span class="n">hashed_psw</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hash_password</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">])</span>
<span class="linenos">251</span>    <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># &quot;paranoic mode&quot;.</span>
<span class="linenos">252</span>    
<span class="linenos">253</span>    <span class="c1"># 5. Check if the user was not previously registered in the DB (i.e., same email)</span>
<span class="linenos">254</span>    <span class="k">if</span> <span class="p">(</span><span class="n">find_user</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">255</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;The user with that email already exists&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">256</span>
<span class="linenos">257</span>    <span class="c1"># 6. Connect to the database and create the new user.</span>
<span class="linenos">258</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">259</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">260</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">261</span>        <span class="nb">print</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="linenos">262</span>        <span class="nb">print</span><span class="p">(</span><span class="n">hashed_psw</span><span class="p">)</span>
<span class="linenos">263</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO user (email, psw, firstName, lastName, avatar, createdon, updatedon) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">hashed_psw</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;firstname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;lastname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">],</span> <span class="n">date</span><span class="p">,</span> <span class="n">date</span><span class="p">))</span>
<span class="linenos">264</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">265</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">266</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&gt;&quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos">267</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">268</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">269</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">270</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">271</span>
<span class="linenos">272</span>    <span class="c1"># 7. Authentication success, the user can now choose to &#39;take the red or blue pill to follow the white rabbit&#39;</span>
<span class="linenos">273</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">274</span>
<span class="linenos">275</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">276</span><span class="sd">[Summary]: Get users.</span>
<span class="linenos">277</span><span class="sd">[Returns]: Returns a User object.</span>
<span class="linenos">278</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">279</span><span class="c1"># Check if a user exists</span>
<span class="linenos">280</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/users&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">281</span><span class="k">def</span> <span class="nf">get_users</span><span class="p">():</span>
<span class="linenos">282</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">283</span>
<span class="linenos">284</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">285</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">286</span>    
<span class="linenos">287</span>    <span class="c1"># 3. Let&#39;s get users from the database.</span>
<span class="linenos">288</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">289</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">290</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">291</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, email, firstName, lastName, avatar, userStatus, administrator, createdon, updatedon FROM user&quot;</span><span class="p">)</span>
<span class="linenos">292</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">293</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">294</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">295</span>    
<span class="linenos">296</span>    <span class="c1"># Empty results ?</span>
<span class="linenos">297</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">298</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">299</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">300</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">301</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">302</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> 
<span class="linenos">303</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">304</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">305</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">306</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">307</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;firstName&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">308</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastName&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">309</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">310</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_status&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">311</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;administrator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos">312</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="linenos">313</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="linenos">314</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">315</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">316</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">317</span>        <span class="c1"># 4. Return information about the user (except the password) and &#39;May the Force be with you&#39;.</span>
<span class="linenos">318</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos">319</span>
<span class="linenos">320</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">321</span><span class="sd">[Summary]: Finds a user by email.</span>
<span class="linenos">322</span><span class="sd">[Returns]: Returns a User object.</span>
<span class="linenos">323</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">324</span><span class="c1"># Check if a user exists</span>
<span class="linenos">325</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">326</span><span class="k">def</span> <span class="nf">find_user</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">327</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">328</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">329</span>
<span class="linenos">330</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">331</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">332</span>        <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">333</span>       
<span class="linenos">334</span>    <span class="c1"># 2. Let&#39;s validate the email, invalid emails from this point are not allowed.</span>
<span class="linenos">335</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">336</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="linenos">337</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">338</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">339</span>    
<span class="linenos">340</span>    <span class="c1"># 3. Let&#39;s get the user from the database with the provided [email].</span>
<span class="linenos">341</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">342</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">343</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">344</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, email, firstName, lastName, avatar FROM user WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<span class="linenos">345</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">346</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">347</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">348</span>    
<span class="linenos">349</span>    <span class="c1"># Empty results ?</span>
<span class="linenos">350</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">351</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">352</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">353</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">354</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">355</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">356</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">357</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">358</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Create a new nice empty dictionary to be populated with data from the DB.</span>
<span class="linenos">359</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">360</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">361</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">362</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;firstName&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">363</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;lastName&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">364</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">365</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">366</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">367</span>
<span class="linenos">368</span>        <span class="c1"># 4. Return information about the user (except the password) and &#39;May the Force be with you&#39;.</span>
<span class="linenos">369</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">370</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">371</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">372</span>            <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">373</span>
<span class="linenos">374</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">375</span><span class="sd">[Summary]: Delete a user</span>
<span class="linenos">376</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">377</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">378</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos">379</span><span class="k">def</span> <span class="nf">delete_user</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="linenos">380</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">381</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">382</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">383</span>  
<span class="linenos">384</span>    <span class="c1"># 2. Let&#39;s validate the email, invalid emails from this point are not allowed.</span>
<span class="linenos">385</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">386</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="linenos">387</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">388</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">389</span>
<span class="linenos">390</span>    <span class="c1"># 3. Connect to the database and delete the user</span>
<span class="linenos">391</span>    <span class="c1"># TODO: Let&#39;s build procedures in the DB to delete Users. </span>
<span class="linenos">392</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">393</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">394</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">395</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM user WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<span class="linenos">396</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">397</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">398</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">399</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">400</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">401</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">402</span>
<span class="linenos">403</span>    <span class="c1"># 4. The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">404</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">405</span>
<span class="linenos">406</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">407</span><span class="sd">[Summary]: Updates a user</span>
<span class="linenos">408</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">409</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">410</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="linenos">411</span><span class="k">def</span> <span class="nf">update_user</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="linenos">412</span>    <span class="n">updatePsw</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">413</span>    <span class="c1"># Note: Remember that if an email is being changed, the email argument is the old one; </span>
<span class="linenos">414</span>    <span class="c1">#       The new email content is available on the JSON object parsed in the body of the request.  </span>
<span class="linenos">415</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">416</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">417</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">418</span>
<span class="linenos">419</span>    <span class="c1"># 2. Let&#39;s validate the email, invalid emails from this point are not allowed.</span>
<span class="linenos">420</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">421</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="linenos">422</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">423</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">424</span>
<span class="linenos">425</span>    <span class="c1"># 3. Let&#39;s get our shiny new JSON object and current time.</span>
<span class="linenos">426</span>    <span class="c1"># - Always start by validating the structure of the json, if not valid send an invalid response.</span>
<span class="linenos">427</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">428</span>        <span class="n">obj</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<span class="linenos">429</span>        <span class="n">date</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="linenos">430</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">431</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">432</span>
<span class="linenos">433</span>
<span class="linenos">434</span>    <span class="c1"># 4. Let&#39;s validate the data of our JSON object with a custom function.</span>
<span class="linenos">435</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;avatar&quot;</span><span class="p">,</span> <span class="s2">&quot;firstname&quot;</span><span class="p">,</span> <span class="s2">&quot;lastname&quot;</span><span class="p">})):</span>
<span class="linenos">436</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="linenos">437</span>
<span class="linenos">438</span>    <span class="c1"># 4.1. Let&#39;s also validate the new email, invalid emails from this point are not allowed.</span>
<span class="linenos">439</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">440</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">])</span>
<span class="linenos">441</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">442</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">443</span>
<span class="linenos">444</span>    <span class="c1"># 5. Hash the new password and store it (if supplied)</span>
<span class="linenos">445</span>    <span class="k">if</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;psw&quot;</span><span class="p">})):</span>
<span class="linenos">446</span>        <span class="n">updatePsw</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">447</span>        <span class="n">hashed_psw</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hash_password</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">])</span>
<span class="linenos">448</span>        <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;psw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1"># &quot;paranoic mode&quot;.</span>
<span class="linenos">449</span>
<span class="linenos">450</span>    <span class="c1"># 6. Connect to the database and update the user with the data of the parsed json object</span>
<span class="linenos">451</span>    <span class="c1"># TODO: - Let&#39;s build procedures in the DB to update Users. </span>
<span class="linenos">452</span>    <span class="c1">#       - Let&#39;s not update every single field of the User, instead, let&#39;s just updated the one that has changed.</span>
<span class="linenos">453</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">454</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">455</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">456</span>        <span class="k">if</span> <span class="p">(</span><span class="n">updatePsw</span><span class="p">):</span>
<span class="linenos">457</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE user SET email=</span><span class="si">%s</span><span class="s2">, psw=</span><span class="si">%s</span><span class="s2">, firstName=</span><span class="si">%s</span><span class="s2">, lastName=</span><span class="si">%s</span><span class="s2">, avatar=</span><span class="si">%s</span><span class="s2">, updatedOn=</span><span class="si">%s</span><span class="s2"> WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">hashed_psw</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;firstname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;lastname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">],</span><span class="n">date</span><span class="p">,</span><span class="n">email</span><span class="p">))</span>
<span class="linenos">458</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">459</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE user SET email=</span><span class="si">%s</span><span class="s2">, firstName=</span><span class="si">%s</span><span class="s2">, lastName=</span><span class="si">%s</span><span class="s2">, avatar=</span><span class="si">%s</span><span class="s2">, updatedOn=</span><span class="si">%s</span><span class="s2"> WHERE email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;firstname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;lastname&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">],</span><span class="n">date</span><span class="p">,</span><span class="n">email</span><span class="p">))</span>    
<span class="linenos">460</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">461</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">462</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">463</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">464</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">465</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">466</span>
<span class="linenos">467</span>    <span class="c1"># 4. The Update request was a success, the user &#39;is in the rabbit hole&#39;</span>
<span class="linenos">468</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">469</span>
<span class="linenos">470</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">471</span><span class="sd">[Summary]: Finds groups of a user.</span>
<span class="linenos">472</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">473</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">474</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/user/&lt;email&gt;/groups&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="linenos">475</span><span class="k">def</span> <span class="nf">find_user_groups</span><span class="p">(</span><span class="n">email</span><span class="p">):</span>
<span class="linenos">476</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">477</span>
<span class="linenos">478</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">479</span>    <span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">480</span>       
<span class="linenos">481</span>    <span class="c1"># 2. Let&#39;s validate the email, invalid emails from this point are not allowed.</span>
<span class="linenos">482</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">483</span>        <span class="n">valid</span> <span class="o">=</span> <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="linenos">484</span>    <span class="k">except</span> <span class="n">EmailNotValidError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">485</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">486</span>    
<span class="linenos">487</span>    <span class="c1"># 3. Let&#39;s get the user from the database with the provided [email].</span>
<span class="linenos">488</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">489</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">490</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">491</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT user_id, user_email, user_group FROM view_user_group WHERE user_email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
<span class="linenos">492</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">493</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">494</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">495</span>    
<span class="linenos">496</span>    <span class="c1"># Empty results ?</span>
<span class="linenos">497</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">498</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">499</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">500</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">501</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">502</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">503</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">504</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Create a new nice empty dictionary to be populated with data from the DB.</span>
<span class="linenos">505</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">506</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_email&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">507</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_group&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">508</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">509</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">510</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">511</span>        <span class="c1"># 4. Return information about the user (except the password) and &#39;May the Force be with you&#39;.</span>
<span class="linenos">512</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos">513</span>
<span class="linenos">514</span><span class="sd">&quot;&quot;&quot; [Summary]: Validates recaptcha response from google server.</span>
<span class="linenos">515</span><span class="sd">    [Returns]: Returns True captcha test passed, false otherwise.</span>
<span class="linenos">516</span><span class="sd">    [TODO]: In a production environment the client and server key should be reconfigured.</span>
<span class="linenos">517</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">518</span><span class="k">def</span> <span class="nf">is_human</span><span class="p">(</span><span class="n">captcha_response</span><span class="p">):</span>
<span class="linenos">519</span>    <span class="c1"># https://www.google.com/recaptcha/</span>
<span class="linenos">520</span>    <span class="n">secret</span> <span class="o">=</span> <span class="n">RECAPTCHA_SECRET</span>
<span class="linenos">521</span>    <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;response&#39;</span><span class="p">:</span><span class="n">captcha_response</span><span class="p">,</span> <span class="s1">&#39;secret&#39;</span><span class="p">:</span><span class="n">secret</span><span class="p">}</span>
<span class="linenos">522</span>    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;https://www.google.com/recaptcha/api/siteverify&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
<span class="linenos">523</span>    <span class="n">response_text</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="linenos">524</span>    <span class="k">return</span> <span class="n">response_text</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span>
<span class="linenos">525</span>
<span class="linenos">526</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">527</span><span class="sd">[Summary]: Check if the user has the necessary permissions to access a service.</span>
<span class="linenos">528</span><span class="sd">[Returns]: True if access is granted to access the resource, false otherwise.</span>
<span class="linenos">529</span><span class="sd">[ref]: CHECK THIS: https://medium.com/devgorilla/how-to-log-out-when-using-jwt-a8c7823e8a6</span>
<span class="linenos">530</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">531</span><span class="k">def</span> <span class="nf">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="linenos">532</span>    <span class="c1"># 1. Check if the token is available on the request header.</span>
<span class="linenos">533</span>    <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
<span class="linenos">534</span>    <span class="c1"># Debug only: print(str(len(headers)))</span>
<span class="linenos">535</span>    
<span class="linenos">536</span>    <span class="c1"># 2. Check if the Authorization header name was parsed.</span>
<span class="linenos">537</span>    <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span> <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the permission to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">538</span>    <span class="n">parsedToken</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
<span class="linenos">539</span>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Bearer&quot;</span> <span class="ow">in</span> <span class="n">parsedToken</span><span class="p">):</span>
<span class="linenos">540</span>        <span class="n">parsedToken</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsedToken</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">541</span>    
<span class="linenos">542</span>    <span class="c1"># 3. Decode the authorization token to get the User object.</span>
<span class="linenos">543</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">544</span>        <span class="c1"># Decode will raise an exception if anything goes wrong within the decoding process (i.e., perform validation of the JWT).</span>
<span class="linenos">545</span>        <span class="n">res_dic</span>  <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">parsedToken</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
<span class="linenos">546</span>        <span class="c1"># Get the ID of the user.</span>
<span class="linenos">547</span>        <span class="n">userID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_dic</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">548</span>        <span class="c1"># Debug only: print(str(json.dumps(res_dic)))</span>
<span class="linenos">549</span>       
<span class="linenos">550</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">551</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">552</span>        <span class="c1"># 3.1. Check if the token is not blacklisted, that is if a user was previously logged out from the platform but the token is still &#39;alive&#39;.</span>
<span class="linenos">553</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM auth_token_blacklist WHERE userID=</span><span class="si">%s</span><span class="s2"> AND token=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">parsedToken</span><span class="p">))</span>
<span class="linenos">554</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">555</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">556</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the necessary permissions to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">557</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">558</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">559</span>
<span class="linenos">560</span>        <span class="c1"># 3.2. Get info of the user</span>
<span class="linenos">561</span>        <span class="c1"># Check if this user id exists.</span>
<span class="linenos">562</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM user WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
<span class="linenos">563</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">564</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">565</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">566</span>
<span class="linenos">567</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
<span class="linenos">568</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">569</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos">570</span>        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># The user is legit, we can let him access the target resource </span>
<span class="linenos">571</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">572</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">573</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos">574</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the necessary permissions to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">575</span>
<span class="linenos">576</span><span class="sd">&quot;&quot;&quot; TODO: Merge this function with the previous one. This function is used to make sure that only admins access particular services.&quot;&quot;&quot;</span>
<span class="linenos">577</span><span class="k">def</span> <span class="nf">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="linenos">578</span>    <span class="c1"># 1. Check if the token is available on the request header.</span>
<span class="linenos">579</span>    <span class="n">headers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
<span class="linenos">580</span>    <span class="c1"># Debug only: print(str(len(headers)))</span>
<span class="linenos">581</span>    
<span class="linenos">582</span>    <span class="c1"># 2. Check if the Authorization header name was parsed.</span>
<span class="linenos">583</span>    <span class="k">if</span> <span class="s1">&#39;Authorization&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span> <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the permission to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">584</span>    <span class="n">parsedToken</span> <span class="o">=</span> <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span>
<span class="linenos">585</span>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Bearer&quot;</span> <span class="ow">in</span> <span class="n">parsedToken</span><span class="p">):</span>
<span class="linenos">586</span>        <span class="n">parsedToken</span> <span class="o">=</span> <span class="p">(</span><span class="n">parsedToken</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Bearer&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">587</span>    
<span class="linenos">588</span>    <span class="c1"># 3. Decode the authorization token to get the User object.</span>
<span class="linenos">589</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">590</span>        <span class="c1"># Decode will raise an exception if anything goes wrong within the decoding process (i.e., perform validation of the JWT).</span>
<span class="linenos">591</span>        <span class="n">res_dic</span>  <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">parsedToken</span><span class="p">,</span> <span class="n">JWT_SECRET_TOKEN</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
<span class="linenos">592</span>        <span class="c1"># Get the ID of the user.</span>
<span class="linenos">593</span>        <span class="n">userID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_dic</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">594</span>        <span class="c1"># Debug only: print(str(json.dumps(res_dic)))</span>
<span class="linenos">595</span>        <span class="c1"># The user is not an administrator</span>
<span class="linenos">596</span>        <span class="k">if</span> <span class="p">(</span> <span class="nb">int</span><span class="p">(</span><span class="n">res_dic</span><span class="p">[</span><span class="s1">&#39;is_admin&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">597</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the permission to access this resource.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">598</span>        
<span class="linenos">599</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">600</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">601</span>        <span class="c1"># 3.1. Check if the token is not blacklisted, that is if a user was previously logged out from the platform but the token is still &#39;alive&#39;.</span>
<span class="linenos">602</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM auth_token_blacklist WHERE userID=</span><span class="si">%s</span><span class="s2"> AND token=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">userID</span><span class="p">,</span> <span class="n">parsedToken</span><span class="p">))</span>
<span class="linenos">603</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">604</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">605</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the necessary permissions to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">606</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">607</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">608</span>
<span class="linenos">609</span>        <span class="c1"># 3.2. Get info of the user</span>
<span class="linenos">610</span>        <span class="c1"># Check if this user id exists.</span>
<span class="linenos">611</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM user WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">userID</span><span class="p">)</span>
<span class="linenos">612</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">613</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">614</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">615</span>
<span class="linenos">616</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span> 
<span class="linenos">617</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">618</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos">619</span>        <span class="k">return</span> <span class="kc">True</span> <span class="c1"># The user is legit, we can let him access the target resource </span>
<span class="linenos">620</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">621</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">622</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="linenos">623</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Authentication failure - You don&#39;t have the necessary permissions to access this resource. Please, provide an authorization token.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
</pre></div>
</div>
</details><section id="get-users">
<h2>Get Users<a class="headerlink" href="#get-users" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/user</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get all users</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the user.</p></li>
<li><p><strong>email</strong> (<em>string</em>) – email of the user.</p></li>
<li><p><strong>avatar</strong> (<em>string</em>) – avatar of the user (i.e., location in disk).</p></li>
<li><p><strong>firstname</strong> (<em>string</em>) – First name of the user.</p></li>
<li><p><strong>lastname</strong> (<em>string</em>) – Last name of the user.</p></li>
<li><p><strong>user_status</strong> (<em>boolean</em>) – Is the user active.</p></li>
<li><p><strong>administrator</strong> (<em>boolean</em>) – Is the user an admin.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Users successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve users.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/users&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;administrator&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Thu, 18 Nov 2021 12:38:43 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;admin@sam.pt&quot;</span><span class="p">,</span>
            <span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="s2">&quot;Administrator&quot;</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Thu, 18 Nov 2021 12:38:43 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;user_status&quot;</span><span class="p">:</span><span class="mi">1</span>
         <span class="p">},</span>
         <span class="p">{</span>
            <span class="nt">&quot;administrator&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Thu, 18 Nov 2021 12:38:43 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;forrest@sam.pt&quot;</span><span class="p">,</span>
            <span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="s2">&quot;Forrest&quot;</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="s2">&quot;Gump&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Thu, 18 Nov 2021 12:38:43 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;user_status&quot;</span><span class="p">:</span><span class="mi">1</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/user/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">email</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get a user by <code class="docutils literal notranslate"><span class="pre">email</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>email</strong> – The email of the user to be retrieved.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the user.</p></li>
<li><p><strong>email</strong> (<em>string</em>) – email of the user.</p></li>
<li><p><strong>avatar</strong> (<em>string</em>) – avatar of the user (i.e., location in disk).</p></li>
<li><p><strong>firstname</strong> (<em>string</em>) – First name of the user.</p></li>
<li><p><strong>lastname</strong> (<em>string</em>) – Last name of the user.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – User successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve user.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/user/forrest@sam.pt&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
      <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;forrest@sam.pt&quot;</span><span class="p">,</span>
      <span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="s2">&quot;Forrest&quot;</span><span class="p">,</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
      <span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="s2">&quot;Gump&quot;</span><span class="p">,</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="get-user-groups">
<h2>Get User Groups<a class="headerlink" href="#get-user-groups" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/user/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">email</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/groups</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of groups mapped to a user identified by <code class="docutils literal notranslate"><span class="pre">email</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>email</strong> – The email of the user.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>user_id</strong> (<em>int</em>) – Id of the user.</p></li>
<li><p><strong>user_email</strong> (<em>string</em>) – email of the user.</p></li>
<li><p><strong>user_group</strong> (<em>string</em>) – Group of the user.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – User groups successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve user groups.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/user/admin@SAM.pt/groups&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;user_email&quot;</span><span class="p">:</span><span class="s2">&quot;admin@sam.pt&quot;</span><span class="p">,</span>
            <span class="nt">&quot;user_group&quot;</span><span class="p">:</span><span class="s2">&quot;Administrators&quot;</span><span class="p">,</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">1</span>
         <span class="p">},</span>
         <span class="p">{</span>
            <span class="nt">&quot;user_email&quot;</span><span class="p">:</span><span class="s2">&quot;admin@sam.pt&quot;</span><span class="p">,</span>
            <span class="nt">&quot;user_group&quot;</span><span class="p">:</span><span class="s2">&quot;Users&quot;</span><span class="p">,</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">1</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="check-if-user-is-an-admin">
<h2>Check if User is an Admin<a class="headerlink" href="#check-if-user-is-an-admin" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/user/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">email</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/admin</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Check if the user identified by <code class="docutils literal notranslate"><span class="pre">email</span></code> is an administrator.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>email</strong> – The email of the user to be checked.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>admin</strong> (<em>boolean</em>) – Is the user an admin.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Check performed to see if the user is an administrator.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to verify user group.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/user/admin@sam.pt/admin&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;admin&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="add-user">
<h2>Add User<a class="headerlink" href="#add-user" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/user</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Add a new user.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>email</strong> (<em>string</em>) – User email.</p></li>
<li><p><strong>psw</strong> (<em>string</em>) – User password.</p></li>
<li><p><strong>firstname</strong> (<em>string</em>) – User first name.</p></li>
<li><p><strong>lastname</strong> (<em>string</em>) – User last name.</p></li>
<li><p><strong>avatar</strong> (<em>string</em>) – avatar of the user (i.e., location in disk).</p></li>
<li><p><strong>g-recaptcha-response</strong> (<em>Object</em>) – Google ReCaptcha response object.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – New user added.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to add user.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<div class="admonition important">
<p class="admonition-title">Important</p>
<p>On a production environment, please, do not post the password without SSL enabled.</p>
</div>
<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;new_user@user.com&quot;</span><span class="p">,</span>
   <span class="nt">&quot;psw&quot;</span><span class="p">:</span><span class="s2">&quot;123&quot;</span><span class="p">,</span>
   <span class="nt">&quot;firstname&quot;</span><span class="p">:</span><span class="s2">&quot;First Name&quot;</span><span class="p">,</span>
   <span class="nt">&quot;lastname&quot;</span><span class="p">:</span><span class="s2">&quot;Last Name&quot;</span><span class="p">,</span>
   <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="s2">&quot;new_user.png&quot;</span><span class="p">,</span>
   <span class="nt">&quot;g-recaptcha-response&quot;</span><span class="p">:</span> <span class="kc">null</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The g-recaptcha-response should not be <code class="docutils literal notranslate"><span class="pre">null</span></code>, a Google ReCaptcha response should be included in the JSON request object.</p>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/user&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="update-user">
<h2>Update User<a class="headerlink" href="#update-user" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/user/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">email</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Updates a user by <code class="docutils literal notranslate"><span class="pre">email</span></code></p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>email</strong> – The email of the user to be updated.</p></li>
</ul>
</dd>
<dt class="field-odd">Request JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>email</strong> (<em>string</em>) – User email.</p></li>
<li><p><strong>psw</strong> (<em>string</em>) – User password.</p></li>
<li><p><strong>firstname</strong> (<em>string</em>) – User first name.</p></li>
<li><p><strong>lastname</strong> (<em>string</em>) – User last name.</p></li>
<li><p><strong>avatar</strong> (<em>string</em>) – avatar of the user (i.e., location in disk).</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – User updated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to update user.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<div class="admonition important">
<p class="admonition-title">Important</p>
<p>On a production environment, please, do not post the password without SSL enabled.</p>
</div>
<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;new_user_updated@user.com&quot;</span><span class="p">,</span>
   <span class="nt">&quot;firstname&quot;</span><span class="p">:</span><span class="s2">&quot;First Name Updated&quot;</span><span class="p">,</span>
   <span class="nt">&quot;lastname&quot;</span><span class="p">:</span><span class="s2">&quot;Last Name Updated&quot;</span><span class="p">,</span>
   <span class="nt">&quot;psw&quot;</span><span class="p">:</span><span class="s2">&quot;1234&quot;</span><span class="p">,</span>
   <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="s2">&quot;new_user_updated.png&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/user&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="remove-user">
<h2>Remove User<a class="headerlink" href="#remove-user" title="Permalink to this headline"></a></h2>
<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/user/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">email</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Removes a user by <code class="docutils literal notranslate"><span class="pre">email</span></code></p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>email</strong> – The email of the user to be removed.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – User successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove user.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/user/new_user@user.com&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="group-services-api">
<h1>Group Services API<a class="headerlink" href="#group-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the group entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>group.py</i></a></summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  3</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  4</span><span class="sd">//</span>
<span class="linenos">  5</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  6</span><span class="sd">//</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  8</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  9</span><span class="sd">//</span>
<span class="linenos"> 10</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 11</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 12</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 13</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 14</span><span class="sd">//</span>
<span class="linenos"> 15</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 16</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 17</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 18</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 19</span><span class="sd">//</span>
<span class="linenos"> 20</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 21</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 22</span><span class="sd">// </span>
<span class="linenos"> 23</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 24</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 25</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 26</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 27</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos"> 29</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 31</span><span class="kn">import</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">views.answer</span> <span class="c1"># SAM&#39;s views</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 34</span><span class="sd">[Summary]: Adds a new question to the database.</span>
<span class="linenos"> 35</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 36</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 37</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/group&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 38</span><span class="k">def</span> <span class="nf">add_group</span><span class="p">():</span>
<span class="linenos"> 39</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 40</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 41</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 42</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 45</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 46</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 47</span>
<span class="linenos"> 48</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos"> 49</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;designation&quot;</span><span class="p">})):</span>
<span class="linenos"> 50</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>   
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>    <span class="n">designation</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;designation&#39;</span><span class="p">]</span>
<span class="linenos"> 53</span>    <span class="n">g_modules</span>   <span class="o">=</span> <span class="s2">&quot;modules&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 54</span>    <span class="n">g_users</span>     <span class="o">=</span> <span class="s2">&quot;users&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 55</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 56</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 57</span>    
<span class="linenos"> 58</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos"> 59</span>    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">designation</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos"> 60</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO sam.group&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;designation&quot;</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 61</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [POST]/api/group - &quot;</span> <span class="o">+</span> <span class="n">sql</span><span class="p">)</span>
<span class="linenos"> 62</span>
<span class="linenos"> 63</span>    <span class="nb">print</span><span class="p">(</span><span class="n">g_modules</span><span class="p">)</span>
<span class="linenos"> 64</span>    <span class="nb">print</span><span class="p">(</span><span class="n">g_users</span><span class="p">)</span>
<span class="linenos"> 65</span>    
<span class="linenos"> 66</span>    <span class="c1"># Add</span>
<span class="linenos"> 67</span>    <span class="n">n_id</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 68</span>    <span class="k">if</span> <span class="p">(</span><span class="n">n_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 69</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>  
<span class="linenos"> 70</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 71</span>        <span class="c1"># If any, link the list of provided users or modules to this group</span>
<span class="linenos"> 72</span>        <span class="k">if</span> <span class="p">(</span><span class="n">g_users</span><span class="p">):</span>
<span class="linenos"> 73</span>            <span class="k">for</span> <span class="n">g_user</span> <span class="ow">in</span> <span class="n">g_users</span><span class="p">:</span>
<span class="linenos"> 74</span>                <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">n_id</span><span class="p">)</span>
<span class="linenos"> 75</span>                <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO user_group&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;userID&quot;</span><span class="p">,</span> <span class="s2">&quot;groupID&quot;</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 76</span>                <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 77</span>        <span class="k">if</span> <span class="p">(</span><span class="n">g_modules</span><span class="p">):</span>
<span class="linenos"> 78</span>            <span class="k">for</span> <span class="n">g_module</span> <span class="ow">in</span> <span class="n">g_modules</span><span class="p">:</span>
<span class="linenos"> 79</span>                <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_module</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">n_id</span><span class="p">)</span>
<span class="linenos"> 80</span>                <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO module_group&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;moduleID&quot;</span><span class="p">,</span> <span class="s2">&quot;groupID&quot;</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 81</span>                <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 82</span>        
<span class="linenos"> 83</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">n_id</span><span class="p">}))</span>  
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 86</span><span class="sd">[Summary]: Updates a group.</span>
<span class="linenos"> 87</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 88</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 89</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/group&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos"> 90</span><span class="k">def</span> <span class="nf">update_group</span><span class="p">():</span>
<span class="linenos"> 91</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 92</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 93</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 94</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 97</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 98</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 99</span>
<span class="linenos">100</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos">101</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">})):</span>
<span class="linenos">102</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos">103</span>
<span class="linenos">104</span>    <span class="n">group_id</span>    <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos">105</span>    <span class="n">designation</span> <span class="o">=</span> <span class="s2">&quot;designation&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;designation&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">106</span>    <span class="n">g_modules</span>   <span class="o">=</span> <span class="s2">&quot;modules&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">107</span>    <span class="n">g_users</span>     <span class="o">=</span> <span class="s2">&quot;users&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">108</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">109</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">110</span>
<span class="linenos">111</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">112</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">113</span>
<span class="linenos">114</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos">115</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">designation</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos">116</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">designation</span> <span class="ow">and</span> <span class="s2">&quot;designation&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedOn&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">117</span>    <span class="n">where</span>   <span class="o">=</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
<span class="linenos">118</span>    <span class="c1"># Check if there is anything to update (i.e. frontend developer has not sent any values to update).</span>
<span class="linenos">119</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">120</span>
<span class="linenos">121</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE sam.group&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
<span class="linenos">122</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [PUT]/api/group - &quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos">123</span>
<span class="linenos">124</span>    <span class="c1"># Update Recommendation</span>
<span class="linenos">125</span>    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">126</span>    
<span class="linenos">127</span>    <span class="c1"># Check if there are any user flagged to be removed, what is removed is not the user but the mapping of a user to the current group.</span>
<span class="linenos">128</span>    <span class="k">if</span> <span class="n">g_users</span><span class="p">:</span>
<span class="linenos">129</span>        <span class="k">for</span> <span class="n">g_user</span> <span class="ow">in</span> <span class="n">g_users</span><span class="p">:</span>
<span class="linenos">130</span>            <span class="n">flag_remove</span> <span class="o">=</span> <span class="s2">&quot;to_remove&quot;</span> <span class="ow">in</span> <span class="n">g_user</span> <span class="ow">and</span> <span class="n">g_user</span><span class="p">[</span><span class="s1">&#39;to_remove&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">131</span>            <span class="c1"># Remove the link between the user and the group</span>
<span class="linenos">132</span>            <span class="k">if</span> <span class="p">(</span><span class="n">flag_remove</span><span class="p">):</span>
<span class="linenos">133</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">134</span>                    <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">135</span>                    <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">136</span>                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM user_group WHERE userID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">g_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">137</span>                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">138</span>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">139</span>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;entrou&quot;</span><span class="p">)</span>
<span class="linenos">140</span>                    <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">141</span>                <span class="k">finally</span><span class="p">:</span>
<span class="linenos">142</span>                    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">143</span>                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">144</span>            <span class="c1"># Add a new user mapping</span>
<span class="linenos">145</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">146</span>                <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">group_id</span><span class="p">)</span>
<span class="linenos">147</span>                <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO user_group&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;userID&quot;</span><span class="p">,</span> <span class="s2">&quot;groupID&quot;</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">148</span>                <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">149</span>    
<span class="linenos">150</span>    <span class="c1"># Do as above, but for modules.</span>
<span class="linenos">151</span>    <span class="k">if</span> <span class="n">g_modules</span><span class="p">:</span>
<span class="linenos">152</span>        <span class="k">for</span> <span class="n">g_module</span> <span class="ow">in</span> <span class="n">g_modules</span><span class="p">:</span>
<span class="linenos">153</span>            <span class="n">flag_remove</span> <span class="o">=</span> <span class="s2">&quot;to_remove&quot;</span> <span class="ow">in</span> <span class="n">g_module</span> <span class="ow">and</span> <span class="n">g_module</span><span class="p">[</span><span class="s1">&#39;to_remove&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">154</span>            <span class="c1"># Remove the link between the user and the group</span>
<span class="linenos">155</span>            <span class="k">if</span> <span class="p">(</span><span class="n">flag_remove</span><span class="p">):</span>
<span class="linenos">156</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">157</span>                    <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">158</span>                    <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">159</span>                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM module_group WHERE moduleID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">g_module</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">160</span>                    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">161</span>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">162</span>                    <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">163</span>                <span class="k">finally</span><span class="p">:</span>
<span class="linenos">164</span>                    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">165</span>                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">166</span>            <span class="c1"># Add a new module mapping</span>
<span class="linenos">167</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">168</span>                <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_module</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">group_id</span><span class="p">)</span>
<span class="linenos">169</span>                <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO module_group&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;moduleID&quot;</span><span class="p">,</span> <span class="s2">&quot;groupID&quot;</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">170</span>                <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">171</span>
<span class="linenos">172</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">173</span>
<span class="linenos">174</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">175</span><span class="sd">[Summary]: Get Groups.</span>
<span class="linenos">176</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">177</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">178</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/groups&#39;</span><span class="p">)</span>
<span class="linenos">179</span><span class="k">def</span> <span class="nf">get_groups</span><span class="p">():</span>
<span class="linenos">180</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">181</span>
<span class="linenos">182</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">183</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">184</span>
<span class="linenos">185</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">186</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">187</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">188</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">189</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, designation, createdon, updatedon FROM sam.group&quot;</span><span class="p">)</span>
<span class="linenos">190</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">191</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">192</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">193</span>    
<span class="linenos">194</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">195</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">196</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">197</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">198</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">199</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">200</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">201</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">202</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">203</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">204</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;designation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">205</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">find_modules_of_group</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">206</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">find_users_of_group</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">207</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">208</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">209</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">210</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">211</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">212</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">213</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">214</span>
<span class="linenos">215</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">216</span><span class="sd">[Summary]: Finds the list of modules linked to a type.</span>
<span class="linenos">217</span><span class="sd">[Returns]: A list of modules or an empty array if None are found.</span>
<span class="linenos">218</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">219</span><span class="k">def</span> <span class="nf">find_modules_of_group</span><span class="p">(</span><span class="n">group_id</span><span class="p">):</span>
<span class="linenos">220</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">221</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">222</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">223</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT moduleID FROM module_group WHERE groupID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
<span class="linenos">224</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">225</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">226</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">227</span>    
<span class="linenos">228</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">229</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">230</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">231</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">232</span>        <span class="k">return</span><span class="p">([])</span> 
<span class="linenos">233</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">234</span>        <span class="n">modules</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">235</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">236</span>            <span class="n">module</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">237</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>
<span class="linenos">238</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>
<span class="linenos">239</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span>
<span class="linenos">240</span>            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos">241</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">242</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">243</span>       
<span class="linenos">244</span>        <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">245</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
<span class="linenos">246</span>
<span class="linenos">247</span><span class="k">def</span> <span class="nf">find_users_of_group</span><span class="p">(</span><span class="n">group_id</span><span class="p">):</span>
<span class="linenos">248</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">249</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">250</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">251</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT user_email FROM view_user_group WHERE group_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span>
<span class="linenos">252</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">253</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">254</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">255</span>    
<span class="linenos">256</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">257</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">258</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">259</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">260</span>        <span class="k">return</span><span class="p">([])</span> 
<span class="linenos">261</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">262</span>        <span class="n">users</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">263</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">264</span>            <span class="n">user</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">265</span>            <span class="n">users</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="linenos">266</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">267</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">268</span>       
<span class="linenos">269</span>        <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">270</span>        <span class="k">return</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
<span class="linenos">271</span>
<span class="linenos">272</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">273</span><span class="sd">[Summary]: Finds Question.</span>
<span class="linenos">274</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">275</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">276</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/group/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">277</span><span class="k">def</span> <span class="nf">find_group</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
<span class="linenos">278</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">279</span>
<span class="linenos">280</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">281</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">282</span>
<span class="linenos">283</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">284</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">285</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">286</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">287</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, designation, createdon, updatedon FROM sam.group WHERE id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">288</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">289</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">290</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">291</span>    
<span class="linenos">292</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">293</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">294</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">295</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">296</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">297</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">298</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">299</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">300</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">301</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">302</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;designation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">303</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">find_modules_of_group</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">304</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;users&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">find_users_of_group</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">305</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">306</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">307</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">308</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">309</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">310</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">311</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">312</span>
<span class="linenos">313</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">314</span><span class="sd">[Summary]: Delete a Group.</span>
<span class="linenos">315</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">316</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">317</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/group/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos">318</span><span class="k">def</span> <span class="nf">delete_group</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
<span class="linenos">319</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">320</span>    <span class="c1"># 1. Check if the user has permissions to access this resource.</span>
<span class="linenos">321</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">322</span>
<span class="linenos">323</span>    <span class="c1"># 2. Connect to the database and delete the resource.</span>
<span class="linenos">324</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">325</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">326</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">327</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM sam.group WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">328</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">329</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">330</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">331</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">332</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">333</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">334</span>
<span class="linenos">335</span>    <span class="c1"># 3. The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">336</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
</pre></div>
</div>
</details><section id="get-groups">
<h2>Get Groups<a class="headerlink" href="#get-groups" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/group</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get all groups.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the group.</p></li>
<li><p><strong>designation</strong> (<em>string</em>) – Description of the group.</p></li>
<li><p><strong>modules</strong> (<em>array</em>) – Array of modules mapped to the group.</p></li>
<li><p><strong>users</strong> (<em>array</em>) – Array of users.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Groups successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve groups.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/groups&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Thu, 18 Nov 2021 12:38:43 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;designation&quot;</span><span class="p">:</span><span class="s2">&quot;Administrators&quot;</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;modules&quot;</span><span class="p">:[],</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Thu, 18 Nov 2021 12:38:43 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;users&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                  <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;admin@sam.pt&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="s2">&quot;Administrator&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="kc">null</span>
               <span class="p">}</span>
            <span class="p">]</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/group/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get a group by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of the group to be retrieved.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the group.</p></li>
<li><p><strong>designation</strong> (<em>string</em>) – Description of the group.</p></li>
<li><p><strong>modules</strong> (<em>array</em>) – Array of modules mapped to the group.</p></li>
<li><p><strong>users</strong> (<em>array</em>) – Array of users.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Groups successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve groups.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/groups&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Thu, 18 Nov 2021 12:38:43 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;designation&quot;</span><span class="p">:</span><span class="s2">&quot;Administrators&quot;</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;modules&quot;</span><span class="p">:[],</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Thu, 18 Nov 2021 12:38:43 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;users&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                  <span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;admin@sam.pt&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;firstName&quot;</span><span class="p">:</span><span class="s2">&quot;Administrator&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;lastName&quot;</span><span class="p">:</span><span class="kc">null</span>
               <span class="p">}</span>
            <span class="p">]</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="add-group">
<h2>Add Group<a class="headerlink" href="#add-group" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/group</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Adds a new group.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>designation</strong> (<em>string</em>) – The name of the group.</p></li>
<li><p><strong>users</strong> (<em>array</em>) – The id of each user that will belong to the new group.</p></li>
<li><p><strong>modules</strong> (<em>array</em>) – The id of each module that will belong to the new group.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id assigned to the new group.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – New group added with <cite>id</cite> (see <strong>example response</strong>).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to add a new group.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;designation&quot;</span><span class="p">:</span><span class="s2">&quot;New Group&quot;</span><span class="p">,</span><span class="nt">&quot;users&quot;</span><span class="p">:[{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}],</span><span class="nt">&quot;modules&quot;</span><span class="p">:[{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}]}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/group&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="edit-group">
<h2>Edit Group<a class="headerlink" href="#edit-group" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/group</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Updates the information of a group.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the group you want to update.</p></li>
<li><p><strong>designation</strong> (<em>string</em>) – The new name of the group.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Group successfully updated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to update group.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="nt">&quot;designation&quot;</span><span class="p">:</span><span class="s2">&quot;New Group Updated&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/group&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="remove-group">
<h2>Remove Group<a class="headerlink" href="#remove-group" title="Permalink to this headline"></a></h2>
<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/group/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Remove a group by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of the group to be removed.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Group successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove group.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/group/3&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
</section>
<section id="file-services-api">
<h1>File Services API<a class="headerlink" href="#file-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the file entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>file.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 3</span><span class="sd">//</span>
<span class="linenos"> 4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos"> 5</span><span class="sd">//</span>
<span class="linenos"> 6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos"> 7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos"> 8</span><span class="sd">//</span>
<span class="linenos"> 9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos">10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos">11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos">12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos">13</span><span class="sd">//</span>
<span class="linenos">14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos">15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos">16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos">17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos">18</span><span class="sd">//</span>
<span class="linenos">19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos">20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos">21</span><span class="sd">// </span>
<span class="linenos">22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos">23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos">24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos">25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">27</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span>
<span class="linenos">28</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">send_from_directory</span>
<span class="linenos">29</span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">modules.utils</span>
<span class="linenos">30</span><span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
<span class="linenos">31</span>
<span class="linenos">32</span><span class="n">UPLOAD_DIRECTORY</span><span class="o">=</span><span class="s2">&quot;./external/&quot;</span>
<span class="linenos">33</span>
<span class="linenos">34</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/file/&lt;path:path&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">35</span><span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="linenos">36</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">37</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">38</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">39</span>    
<span class="linenos">40</span>    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">UPLOAD_DIRECTORY</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/files&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">43</span><span class="k">def</span> <span class="nf">list_files</span><span class="p">():</span>
<span class="linenos">44</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">45</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">46</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">47</span>
<span class="linenos">48</span>    <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">49</span>    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">UPLOAD_DIRECTORY</span><span class="p">):</span>
<span class="linenos">50</span>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_DIRECTORY</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
<span class="linenos">51</span>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<span class="linenos">52</span>            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="linenos">53</span>    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
<span class="linenos">54</span>
<span class="linenos">55</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/file/&lt;filename&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="linenos">56</span><span class="k">def</span> <span class="nf">post_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="linenos">57</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">58</span>    <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
<span class="linenos">59</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">60</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">61</span>
<span class="linenos">62</span>    <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
<span class="linenos">63</span>        <span class="c1"># Return 400 BAD REQUEST</span>
<span class="linenos">64</span>        <span class="n">abort</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;no subdirectories directories allowed&quot;</span><span class="p">)</span>
<span class="linenos">65</span>
<span class="linenos">66</span>    <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
<span class="linenos">67</span>        <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="linenos">68</span>        <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">UPLOAD_DIRECTORY</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span>
<span class="linenos">69</span>
<span class="linenos">70</span>    <span class="c1"># Return 201 CREATED</span>
<span class="linenos">71</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">201</span><span class="p">))</span>
<span class="linenos">72</span>
<span class="linenos">73</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/file/module/&lt;module_name&gt;/session/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">74</span><span class="k">def</span> <span class="nf">download_recommendations_zip</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
<span class="linenos">75</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">76</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">77</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">78</span>    
<span class="linenos">79</span>    <span class="n">file_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_session_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.zip&#39;</span>
<span class="linenos">80</span>    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="s1">&#39;./temp/&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</details><section id="upload-file">
<h2>Upload File<a class="headerlink" href="#upload-file" title="Permalink to this headline"></a></h2>
<span class="target" id="upload"></span><dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/file/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">filename</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Uploads a file to the predefined <code class="docutils literal notranslate"><span class="pre">UPLOAD_DIRECTORY</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – multipart/form-data</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>filename</strong> – The name of the file.</p></li>
</ul>
</dd>
<dt class="field-odd">Form Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>file</strong> – The file to be uploaded.</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a></span> – The file was successfully uploaded.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – Fail to upload file.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/file/example.md&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">201</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="request-file">
<h2>Request File<a class="headerlink" href="#request-file" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/file/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">filename</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Returns a file from the predefined <code class="docutils literal notranslate"><span class="pre">UPLOAD_DIRECTORY</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>filename</strong> – The name of the file.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.2">201 Created</a></span> – The file was successfully uploaded.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – Fail to upload file.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
<section id="get-files">
<h2>Get Files<a class="headerlink" href="#get-files" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/file/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">filename</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Returns the list of files available on the predefined <code class="docutils literal notranslate"><span class="pre">UPLOAD_DIRECTORY</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>filename</strong> – The name of the file.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – The list of files was successfully retrieved.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s2">&quot;example.md&quot;</span><span class="p">,</span><span class="s2">&quot;example_2.md&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="get-session-files">
<h2>Get Session Files<a class="headerlink" href="#get-session-files" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/file/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">shortname</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/session/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Returns a zip containing all recommendations for a specific session <code class="docutils literal notranslate"><span class="pre">id</span></code> and module identified by <code class="docutils literal notranslate"><span class="pre">shortname</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>shortname</strong> – The short name of the module.</p></li>
<li><p><strong>id</strong> – The id of the session.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – The zip file was successfully created.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="types-services-api">
<h1>Types Services API<a class="headerlink" href="#types-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the type entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>type.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">views.user</span> <span class="c1"># SAM&#39;s views</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 33</span><span class="sd">[Summary]: Adds a new type to the database.</span>
<span class="linenos"> 34</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 35</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 36</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/type&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 37</span><span class="k">def</span> <span class="nf">add_type</span><span class="p">():</span>
<span class="linenos"> 38</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 39</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 40</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 41</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 44</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 45</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos"> 48</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">})):</span>
<span class="linenos"> 49</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos"> 50</span>
<span class="linenos"> 51</span>    <span class="n">name</span>        <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="linenos"> 52</span>    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 53</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 54</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 55</span>    
<span class="linenos"> 56</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos"> 57</span>    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos"> 58</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO type&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">description</span> <span class="ow">and</span> <span class="s2">&quot;description&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 59</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [POST]/api/type - &quot;</span> <span class="o">+</span> <span class="n">sql</span><span class="p">)</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span>    <span class="c1"># Add</span>
<span class="linenos"> 62</span>    <span class="n">n_id</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 63</span>    <span class="k">if</span> <span class="p">(</span><span class="n">n_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 64</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>  
<span class="linenos"> 65</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 66</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">n_id</span><span class="p">}))</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 69</span><span class="sd">[Summary]: Updates a type.</span>
<span class="linenos"> 70</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 71</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 72</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/type&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos"> 73</span><span class="k">def</span> <span class="nf">update_type</span><span class="p">():</span>
<span class="linenos"> 74</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 75</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 76</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 77</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 78</span>
<span class="linenos"> 79</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 80</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 81</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos"> 84</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">})):</span>
<span class="linenos"> 85</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos"> 86</span>
<span class="linenos"> 87</span>    <span class="n">name</span>        <span class="o">=</span> <span class="s2">&quot;name&quot;</span>        <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 88</span>    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 89</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 90</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 91</span>
<span class="linenos"> 92</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 93</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos"> 96</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos"> 97</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">description</span> <span class="ow">and</span> <span class="s2">&quot;description&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedOn&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos"> 98</span>    <span class="n">where</span>   <span class="o">=</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos"> 99</span>    <span class="c1"># Check if there is anything to update (i.e. frontend developer has not sent any values to update).</span>
<span class="linenos">100</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">101</span>
<span class="linenos">102</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE type&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
<span class="linenos">103</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [PUT]/api/type - &quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos">104</span>
<span class="linenos">105</span>    <span class="c1"># Update Recommendation</span>
<span class="linenos">106</span>    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">107</span>
<span class="linenos">108</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">109</span>
<span class="linenos">110</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">111</span><span class="sd">[Summary]: Get Questions.</span>
<span class="linenos">112</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">113</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">114</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/types&#39;</span><span class="p">)</span>
<span class="linenos">115</span><span class="k">def</span> <span class="nf">get_types</span><span class="p">():</span>
<span class="linenos">116</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">117</span>
<span class="linenos">118</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">119</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">120</span>
<span class="linenos">121</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">122</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">123</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">124</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">125</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, name, description, createdOn, updatedOn FROM type&quot;</span><span class="p">)</span>
<span class="linenos">126</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">127</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">128</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">129</span>    
<span class="linenos">130</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">131</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">132</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">133</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">134</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">135</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">136</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">137</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">138</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">139</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">140</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">141</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">142</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">find_modules_of_type</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">143</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">144</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">145</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">146</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">147</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">148</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">149</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">150</span>
<span class="linenos">151</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">152</span><span class="sd">[Summary]: Finds the list of modules linked to a type.</span>
<span class="linenos">153</span><span class="sd">[Returns]: A list of modules or an empty array if None are found.</span>
<span class="linenos">154</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">155</span><span class="k">def</span> <span class="nf">find_modules_of_type</span><span class="p">(</span><span class="n">type_id</span><span class="p">):</span>
<span class="linenos">156</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">157</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">158</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">159</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM module WHERE typeID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">type_id</span><span class="p">)</span>
<span class="linenos">160</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">161</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">162</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">163</span>    
<span class="linenos">164</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">165</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">166</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">167</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">168</span>        <span class="k">return</span><span class="p">([])</span> 
<span class="linenos">169</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">170</span>        <span class="n">modules</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">171</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">172</span>            <span class="n">module</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">173</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>
<span class="linenos">174</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>
<span class="linenos">175</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span>
<span class="linenos">176</span>            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos">177</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">178</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">179</span>       
<span class="linenos">180</span>        <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">181</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
<span class="linenos">182</span>
<span class="linenos">183</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">184</span><span class="sd">[Summary]: Finds a Type.</span>
<span class="linenos">185</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">186</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">187</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/type/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">188</span><span class="k">def</span> <span class="nf">find_type</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
<span class="linenos">189</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">190</span>
<span class="linenos">191</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">192</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">193</span>
<span class="linenos">194</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">195</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">196</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">197</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">198</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, name, description, createdOn, updatedOn FROM type WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">199</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">200</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">201</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">202</span>    
<span class="linenos">203</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">204</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">205</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">206</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">207</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">208</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">209</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">210</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">211</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">212</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">213</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">214</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">215</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">216</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">217</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">218</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">219</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">220</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">221</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">222</span>
<span class="linenos">223</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">224</span><span class="sd">[Summary]: Delete a type.</span>
<span class="linenos">225</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">226</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">227</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/type/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos">228</span><span class="k">def</span> <span class="nf">delete_type</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
<span class="linenos">229</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">230</span>    <span class="c1"># 1. Check if the user has permissions to access this resource.</span>
<span class="linenos">231</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">232</span>
<span class="linenos">233</span>    <span class="c1"># 2. Connect to the database and delete the resource.</span>
<span class="linenos">234</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">235</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">236</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">237</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM type WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">238</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">239</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">240</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">241</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">242</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">243</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">244</span>
<span class="linenos">245</span>    <span class="c1"># 3. The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">246</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
</pre></div>
</div>
</details><section id="get-types">
<h2>Get Types<a class="headerlink" href="#get-types" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/types</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get types.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the type.</p></li>
<li><p><strong>name</strong> (<em>string</em>) – Name of the type.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Description of the type.</p></li>
<li><p><strong>modules</strong> (<em>array</em>) – Array of modules mapped to the current type.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Types successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve types.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/types&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Test Type&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test Type Description&quot;</span><span class="p">,</span>
            <span class="nt">&quot;modules&quot;</span><span class="p">:[],</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Mon, 20 Sep 2021 09:00:00 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Mon, 20 Sep 2021 09:00:00 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/type/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get a type identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – id of the type.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the type.</p></li>
<li><p><strong>name</strong> (<em>string</em>) – Name of the type.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Description of the type.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Type successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve type.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/type/1&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Test Type&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test Type Description&quot;</span><span class="p">,</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Mon, 20 Sep 2021 09:00:00 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Mon, 20 Sep 2021 09:00:00 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="add-type">
<h2>Add Type<a class="headerlink" href="#add-type" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/type</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Add a new type.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>name</strong> (<em>string</em>) – Name of the type.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Description of the type.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Type successfully added.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to add type.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Test Type&quot;</span><span class="p">,</span>
   <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test Type Description&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/type&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="edit-type">
<h2>Edit Type<a class="headerlink" href="#edit-type" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/type</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Update a type.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module to update.</p></li>
<li><p><strong>name</strong> (<em>string</em>) – Name of the type.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Description of the type.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Type successfully updated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to update type.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
   <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Test Type Updated&quot;</span><span class="p">,</span>
   <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test Type Updated&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/type&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="remove-type">
<h2>Remove Type<a class="headerlink" href="#remove-type" title="Permalink to this headline"></a></h2>
<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/type/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Remove a type identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of the type to be removed.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Type successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove type.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/type/1&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
</section>
<section id="module-services-api">
<h1>Module Services API<a class="headerlink" href="#module-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the module entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>module.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">   2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">   3</span><span class="sd">//</span>
<span class="linenos">   4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">   5</span><span class="sd">//</span>
<span class="linenos">   6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">   7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">   8</span><span class="sd">//</span>
<span class="linenos">   9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos">  10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos">  11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos">  12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos">  13</span><span class="sd">//</span>
<span class="linenos">  14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos">  15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos">  16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos">  17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos">  18</span><span class="sd">//</span>
<span class="linenos">  19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos">  20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos">  21</span><span class="sd">// </span>
<span class="linenos">  22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos">  23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos">  24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos">  25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  27</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos">  28</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos">  29</span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="linenos">  30</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos">  31</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos">  32</span><span class="kn">import</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">views.recommendation</span><span class="o">,</span> <span class="nn">views.question</span><span class="o">,</span> <span class="nn">views.dependency</span> <span class="c1"># SAM&#39;s views</span>
<span class="linenos">  33</span>
<span class="linenos">  34</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  35</span><span class="sd">[Summary]: Adds a new Module.</span>
<span class="linenos">  36</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">  37</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  38</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos">  39</span><span class="k">def</span> <span class="nf">add_module</span><span class="p">():</span>
<span class="linenos">  40</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">  41</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">  42</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">  43</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos">  46</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">  47</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">  48</span>
<span class="linenos">  49</span>    <span class="c1"># Validate if the necessary data is on the provided JSON</span>
<span class="linenos">  50</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;shortname&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="s2">&quot;displayname&quot;</span><span class="p">})):</span>
<span class="linenos">  51</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos">  52</span>    
<span class="linenos">  53</span>    <span class="n">shortname</span>       <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span>
<span class="linenos">  54</span>    <span class="n">fullname</span>        <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span>
<span class="linenos">  55</span>    <span class="n">displayname</span>     <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;displayname&#39;</span><span class="p">]</span>
<span class="linenos">  56</span>
<span class="linenos">  57</span>    <span class="c1"># Check if module&#39;s short name and display name are unique</span>
<span class="linenos">  58</span>    <span class="n">shortnames</span><span class="p">,</span> <span class="n">displaynames</span> <span class="o">=</span> <span class="n">get_modules_short_displaynames</span><span class="p">()</span>
<span class="linenos">  59</span>    <span class="k">if</span> <span class="n">shortname</span> <span class="ow">in</span> <span class="n">shortnames</span><span class="p">:</span>
<span class="linenos">  60</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;&#39;Abbreviation&#39; already in use.&quot;</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">  61</span>    <span class="k">if</span> <span class="n">displayname</span> <span class="ow">in</span> <span class="n">displaynames</span><span class="p">:</span>
<span class="linenos">  62</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;&#39;Display Name&#39; already in use.&quot;</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">  63</span>
<span class="linenos">  64</span>    <span class="n">tree</span>            <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">  65</span>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;tree&#39;</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">):</span> 
<span class="linenos">  66</span>        <span class="n">tree</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>
<span class="linenos">  67</span>    <span class="n">recommendations</span> <span class="o">=</span> <span class="s2">&quot;recommendations&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">  68</span>    <span class="n">dependencies</span>    <span class="o">=</span> <span class="s2">&quot;dependencies&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">  69</span>    <span class="n">avatar</span>      <span class="o">=</span> <span class="s2">&quot;avatar&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">  70</span>    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">  71</span>    <span class="n">type_id</span>     <span class="o">=</span> <span class="s2">&quot;type_id&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">  72</span>    <span class="n">logic</span>       <span class="o">=</span> <span class="s2">&quot;logic_filename&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">  73</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">  74</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">  75</span>    
<span class="linenos">  76</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos">  77</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;shortname&quot;</span><span class="p">,</span> <span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="s2">&quot;displayname&quot;</span><span class="p">,</span> <span class="n">type_id</span> <span class="ow">and</span> <span class="s2">&quot;typeID&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">avatar</span> <span class="ow">and</span> <span class="s2">&quot;avatar&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">description</span> <span class="ow">and</span> <span class="s2">&quot;description&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">  78</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">shortname</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">displayname</span><span class="p">,</span> <span class="n">type_id</span><span class="p">,</span> <span class="n">avatar</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos">  79</span>    
<span class="linenos">  80</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO module&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">  81</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [POST]/api/module - &quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; =&gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos">  82</span>
<span class="linenos">  83</span>    <span class="c1"># Add Module and iterate the tree of the module in order to create the questions and answers mapped to the current module.</span>
<span class="linenos">  84</span>    <span class="n">module_id</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">  85</span>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;tree&#39;</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">):</span>
<span class="linenos">  86</span>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span> 
<span class="linenos">  87</span>            <span class="n">iterate_tree_nodes</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">,</span> <span class="n">module_id</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="linenos">  88</span>    
<span class="linenos">  89</span>    <span class="c1"># Store the mapping of question_answer and recommendations (DB table Recommendation_Question_Answer)</span>
<span class="linenos">  90</span>    <span class="c1"># Get the question_answer id primary key value, through [question_id] and [answer_id]</span>
<span class="linenos">  91</span>    <span class="k">if</span> <span class="n">recommendations</span><span class="p">:</span>
<span class="linenos">  92</span>        <span class="k">for</span> <span class="n">recommendation</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">:</span>
<span class="linenos">  93</span>            <span class="k">for</span> <span class="n">question_answer</span> <span class="ow">in</span> <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;questions_answers&#39;</span><span class="p">]:</span>
<span class="linenos">  94</span>                <span class="n">qa_res</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">find_question_answers_2</span><span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">],</span> <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">  95</span>                <span class="k">if</span> <span class="p">(</span><span class="n">qa_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">  96</span>                <span class="n">qa_res</span> <span class="o">=</span> <span class="n">qa_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">  97</span>                <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API] [POST]/api/module - question_id = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;, answer_id=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; =&gt; Question_Answer_id =&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">qa_res</span><span class="p">[</span><span class="s1">&#39;question_answer_id&#39;</span><span class="p">]))</span>
<span class="linenos">  98</span>                <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qa_res</span><span class="p">[</span><span class="s1">&#39;question_answer_id&#39;</span><span class="p">]</span>
<span class="linenos">  99</span>    
<span class="linenos"> 100</span>        <span class="c1"># Add the recommendation with the link between questions and answers</span>
<span class="linenos"> 101</span>        <span class="k">for</span> <span class="n">recommendation</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">:</span>
<span class="linenos"> 102</span>            <span class="n">views</span><span class="o">.</span><span class="n">recommendation</span><span class="o">.</span><span class="n">add_recommendation</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
<span class="linenos"> 103</span>    
<span class="linenos"> 104</span>    <span class="c1"># Add dependencies, only if the current module depends on another module.</span>
<span class="linenos"> 105</span>    <span class="k">if</span> <span class="p">(</span><span class="n">module_id</span> <span class="ow">and</span> <span class="n">dependencies</span><span class="p">):</span>
<span class="linenos"> 106</span>        <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
<span class="linenos"> 107</span>                <span class="n">views</span><span class="o">.</span><span class="n">dependency</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">({</span><span class="s2">&quot;module_id&quot;</span><span class="p">:</span> <span class="n">module_id</span><span class="p">,</span> <span class="s2">&quot;depends_on&quot;</span><span class="p">:</span> <span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]},</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 108</span>
<span class="linenos"> 109</span>    <span class="c1"># If availabe, set the logic filename after knowing the database id of the module</span>
<span class="linenos"> 110</span>    <span class="k">if</span> <span class="n">logic</span> <span class="ow">and</span> <span class="n">module_id</span><span class="p">:</span>
<span class="linenos"> 111</span>        <span class="n">final_logic_filename</span> <span class="o">=</span> <span class="s2">&quot;logic_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.py&quot;</span>
<span class="linenos"> 112</span>        <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE module&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;logicFilename&quot;</span><span class="p">],</span> <span class="n">final_logic_filename</span><span class="p">,</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">module_id</span><span class="p">))</span>
<span class="linenos"> 113</span>        <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 114</span>
<span class="linenos"> 115</span>    <span class="c1"># &#39;Do, or do not, there is no try.&#39;</span>
<span class="linenos"> 116</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">module_id</span><span class="p">,</span> <span class="s2">&quot;tree&quot;</span><span class="p">:</span> <span class="n">tree</span><span class="p">}))</span>  
<span class="linenos"> 117</span>
<span class="linenos"> 118</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 119</span><span class="sd">[Summary]: Delete logic file linked to a module.</span>
<span class="linenos"> 120</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos"> 121</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 122</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;/logic&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos"> 123</span><span class="k">def</span> <span class="nf">delete_module_logic</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 124</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 125</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 126</span>    
<span class="linenos"> 127</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 128</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 129</span>
<span class="linenos"> 130</span>    <span class="c1"># Get information about module and remove logic file</span>
<span class="linenos"> 131</span>    <span class="n">module</span> <span class="o">=</span> <span class="n">find_module</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 132</span>
<span class="linenos"> 133</span>    <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">]):</span>
<span class="linenos"> 134</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 135</span>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;/external/&quot;</span> <span class="o">+</span> <span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">])</span>
<span class="linenos"> 136</span>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 137</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 138</span>
<span class="linenos"> 139</span>    <span class="c1"># The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos"> 140</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 141</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos"> 142</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 143</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 144</span>
<span class="linenos"> 145</span>
<span class="linenos"> 146</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 147</span><span class="sd">[Summary]: Delete questions linked to a module.</span>
<span class="linenos"> 148</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos"> 149</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 150</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;/questions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos"> 151</span><span class="k">def</span> <span class="nf">delete_module_questions</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 152</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 153</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 154</span>    
<span class="linenos"> 155</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 156</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 157</span>
<span class="linenos"> 158</span>    <span class="c1"># Get the set of questions linked to this module.</span>
<span class="linenos"> 159</span>    <span class="n">questions</span> <span class="o">=</span> <span class="n">find_module_questions</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 160</span>    <span class="k">if</span> <span class="p">(</span><span class="n">questions</span><span class="p">):</span>
<span class="linenos"> 161</span>        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">questions</span><span class="p">:</span>
<span class="linenos"> 162</span>            <span class="n">views</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">delete_question</span><span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 163</span>    
<span class="linenos"> 164</span>    <span class="c1"># Delete the module itself and all the sessions linked to him.</span>
<span class="linenos"> 165</span>    <span class="c1"># delete_module(ID, True)</span>
<span class="linenos"> 166</span>
<span class="linenos"> 167</span>    <span class="c1"># The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos"> 168</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 169</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos"> 170</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 171</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 172</span>
<span class="linenos"> 173</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 174</span><span class="sd">[Summary]: Delete answers linked to a module.</span>
<span class="linenos"> 175</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos"> 176</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 177</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;/answers&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos"> 178</span><span class="k">def</span> <span class="nf">delete_module_answers</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 179</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos"> 180</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 181</span>
<span class="linenos"> 182</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 183</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 184</span>
<span class="linenos"> 185</span>    <span class="c1"># Get the set of answers linked to this module.</span>
<span class="linenos"> 186</span>        <span class="c1"># Get the set of questions linked to this module.</span>
<span class="linenos"> 187</span>    <span class="n">answers</span> <span class="o">=</span> <span class="n">find_module_answers</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 188</span>    <span class="k">if</span> <span class="p">(</span><span class="n">answers</span><span class="p">):</span>
<span class="linenos"> 189</span>        <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">:</span>
<span class="linenos"> 190</span>            <span class="n">views</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="n">delete_answer</span><span class="p">(</span><span class="n">answer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 191</span>    
<span class="linenos"> 192</span>    <span class="c1"># Delete the module itself and all the sessions linked to him.</span>
<span class="linenos"> 193</span>    <span class="c1"># delete_module(ID, True)</span>
<span class="linenos"> 194</span>    
<span class="linenos"> 195</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 196</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos"> 197</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 198</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 199</span>
<span class="linenos"> 200</span>
<span class="linenos"> 201</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 202</span><span class="sd">[Summary]: Delete a module (partial delete - Linked questions and answers are not deleted)</span>
<span class="linenos"> 203</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos"> 204</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 205</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos"> 206</span><span class="k">def</span> <span class="nf">delete_module_partial</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 207</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 208</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 209</span>    
<span class="linenos"> 210</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos"> 211</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 212</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 213</span>
<span class="linenos"> 214</span>    <span class="c1"># 2. Delete logic file associated</span>
<span class="linenos"> 215</span>    <span class="n">delete_module_logic</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 216</span>
<span class="linenos"> 217</span>    <span class="c1"># 3. Connect to the database and delete the resource</span>
<span class="linenos"> 218</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 219</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 220</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 221</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM module WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos"> 222</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos"> 223</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 224</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos"> 225</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos"> 226</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 227</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 228</span>
<span class="linenos"> 229</span>    <span class="c1"># 4. The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos"> 230</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos"> 231</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos"> 232</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 233</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 234</span>
<span class="linenos"> 235</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 236</span><span class="sd">[Summary]: Fully delete a module (including sessions, linked questions and answers)</span>
<span class="linenos"> 237</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos"> 238</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 239</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;/full&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos"> 240</span><span class="k">def</span> <span class="nf">delete_module_full</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 241</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos"> 242</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 243</span>
<span class="linenos"> 244</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 245</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 246</span>
<span class="linenos"> 247</span>    <span class="c1"># Get and delete the set of answers and questions linked to this module.</span>
<span class="linenos"> 248</span>    <span class="n">delete_module_answers</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 249</span>    <span class="n">delete_module_questions</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 250</span>    
<span class="linenos"> 251</span>    <span class="c1"># Delete the module itself and all the sessions linked to him.</span>
<span class="linenos"> 252</span>    <span class="n">delete_module_partial</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 253</span>    
<span class="linenos"> 254</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 255</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos"> 256</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 257</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 258</span>
<span class="linenos"> 259</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 260</span><span class="sd">[Summary]: Updates a Module.</span>
<span class="linenos"> 261</span><span class="sd">[Returns]: returns 200 if the operation was a success, 500 otherwise.</span>
<span class="linenos"> 262</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 263</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos"> 264</span><span class="k">def</span> <span class="nf">update_module</span><span class="p">():</span>
<span class="linenos"> 265</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos"> 266</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 267</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticatedAdmin</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 268</span>    <span class="c1"># Delete the module but not to forget to preserve the session related to this module that  is being delete just for the sake of being easier to update is info based on the tree parsed</span>
<span class="linenos"> 269</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 270</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 271</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 272</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 273</span>
<span class="linenos"> 274</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos"> 275</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">})):</span>
<span class="linenos"> 276</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos"> 277</span>
<span class="linenos"> 278</span>    <span class="n">module_id</span>       <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos"> 279</span>    <span class="n">tree</span>            <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 280</span>    <span class="c1"># If there is a tree to update</span>
<span class="linenos"> 281</span>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;tree&#39;</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">):</span>
<span class="linenos"> 282</span>        <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;[PUT]/api/module&quot;</span><span class="p">,</span> <span class="s2">&quot;Tree exists&quot;</span><span class="p">)</span>
<span class="linenos"> 283</span>        <span class="n">tree</span>        <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>
<span class="linenos"> 284</span>    <span class="c1"># If the user has choosen to erase all questions</span>
<span class="linenos"> 285</span>    <span class="k">if</span> <span class="p">(</span><span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 286</span>        <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;[PUT]/api/module&quot;</span><span class="p">,</span> <span class="s2">&quot;No tree exists&quot;</span><span class="p">)</span>
<span class="linenos"> 287</span>        <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;DELETE FROM module_question WHERE moduleID=</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="linenos"> 288</span>        <span class="n">values</span>  <span class="o">=</span> <span class="n">module_id</span>
<span class="linenos"> 289</span>        <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 290</span>
<span class="linenos"> 291</span>    <span class="c1">#</span>
<span class="linenos"> 292</span>    <span class="n">dependencies</span>    <span class="o">=</span> <span class="s2">&quot;dependencies&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 293</span>    <span class="n">recommendations</span> <span class="o">=</span> <span class="s2">&quot;recommendations&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 294</span>    <span class="n">shortname</span>       <span class="o">=</span> <span class="s2">&quot;shortname&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 295</span>    <span class="n">fullname</span>        <span class="o">=</span> <span class="s2">&quot;fullname&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 296</span>    <span class="n">displayname</span>     <span class="o">=</span> <span class="s2">&quot;displayname&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;displayname&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 297</span>    <span class="n">avatar</span>          <span class="o">=</span> <span class="s2">&quot;avatar&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 298</span>    <span class="n">description</span>     <span class="o">=</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 299</span>    <span class="n">type_id</span>         <span class="o">=</span> <span class="s2">&quot;type_id&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 300</span>    <span class="n">logic</span>           <span class="o">=</span> <span class="s2">&quot;logic_filename&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="s2">&quot;logic_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">module_id</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.py&quot;</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 301</span>    <span class="n">createdon</span>       <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 302</span>    <span class="n">updatedon</span>       <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="linenos"> 303</span>    
<span class="linenos"> 304</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos"> 305</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">shortname</span> <span class="ow">and</span> <span class="s2">&quot;shortname&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fullname</span> <span class="ow">and</span> <span class="s2">&quot;fullname&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">displayname</span> <span class="ow">and</span> <span class="s2">&quot;displayname&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">type_id</span> <span class="ow">and</span> <span class="s2">&quot;typeID&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">logic</span> <span class="ow">and</span> <span class="s2">&quot;logicFilename&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">avatar</span> <span class="ow">and</span> <span class="s2">&quot;avatar&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">description</span> <span class="ow">and</span> <span class="s2">&quot;description&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos"> 306</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">shortname</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">displayname</span><span class="p">,</span> <span class="n">type_id</span><span class="p">,</span> <span class="n">logic</span><span class="p">,</span> <span class="n">avatar</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos"> 307</span>    <span class="n">where</span>   <span class="o">=</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">module_id</span><span class="p">)</span>
<span class="linenos"> 308</span>
<span class="linenos"> 309</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE module&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
<span class="linenos"> 310</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;[PUT]/api/module&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; =&gt; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">where</span><span class="p">))</span>
<span class="linenos"> 311</span>
<span class="linenos"> 312</span>    <span class="c1"># Update </span>
<span class="linenos"> 313</span>    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 314</span>    
<span class="linenos"> 315</span>    <span class="c1"># Iterate the tree of module in order to update questions an answers of the module</span>
<span class="linenos"> 316</span>    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;tree&#39;</span> <span class="ow">in</span> <span class="n">json_data</span><span class="p">):</span>
<span class="linenos"> 317</span>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>   
<span class="linenos"> 318</span>            <span class="n">iterate_tree_nodes</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">,</span> <span class="n">module_id</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
<span class="linenos"> 319</span>
<span class="linenos"> 320</span>    <span class="c1"># Update the dependency</span>
<span class="linenos"> 321</span>    <span class="k">if</span> <span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
<span class="linenos"> 322</span>        <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
<span class="linenos"> 323</span>            <span class="n">flag_remove</span> <span class="o">=</span> <span class="s2">&quot;to_remove&quot;</span> <span class="ow">in</span> <span class="n">dependency</span> <span class="ow">and</span> <span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;to_remove&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 324</span>            <span class="c1"># Remove the dependency</span>
<span class="linenos"> 325</span>            <span class="k">if</span> <span class="p">(</span><span class="n">flag_remove</span><span class="p">):</span>
<span class="linenos"> 326</span>                <span class="n">views</span><span class="o">.</span><span class="n">dependency</span><span class="o">.</span><span class="n">delete_dependency</span><span class="p">(</span><span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 327</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 328</span>                <span class="n">views</span><span class="o">.</span><span class="n">dependency</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">({</span><span class="s2">&quot;module_id&quot;</span><span class="p">:</span> <span class="n">module_id</span><span class="p">,</span> <span class="s2">&quot;depends_on&quot;</span><span class="p">:</span> <span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]},</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 329</span>
<span class="linenos"> 330</span>    <span class="k">if</span> <span class="p">(</span><span class="n">recommendations</span><span class="p">):</span>
<span class="linenos"> 331</span>        <span class="c1"># Check if there are any recommendation flagged to be removed, what is removed is not the recommentation but the mapping of a recommendation to the current module</span>
<span class="linenos"> 332</span>        <span class="k">for</span> <span class="n">recommendation</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">:</span>
<span class="linenos"> 333</span>            <span class="n">flag_remove</span> <span class="o">=</span> <span class="s2">&quot;to_remove&quot;</span> <span class="ow">in</span> <span class="n">recommendation</span> <span class="ow">and</span> <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;to_remove&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 334</span>            <span class="c1"># Remove the recommendation</span>
<span class="linenos"> 335</span>            <span class="k">if</span> <span class="p">(</span><span class="n">flag_remove</span><span class="p">):</span>
<span class="linenos"> 336</span>                <span class="n">views</span><span class="o">.</span><span class="n">recommendation</span><span class="o">.</span><span class="n">remove_recommendation_of_module</span><span class="p">(</span><span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">module_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 337</span>            <span class="c1"># Add a new recommendation</span>
<span class="linenos"> 338</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 339</span>                <span class="c1"># Store the mapping of question_answer and recommendations (DB table Recommendation_Question_Answer)</span>
<span class="linenos"> 340</span>                <span class="c1"># Get the question_answer id primary key value, through [question_id] and [answer_id]    </span>
<span class="linenos"> 341</span>                <span class="k">for</span> <span class="n">question_answer</span> <span class="ow">in</span> <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;questions_answers&#39;</span><span class="p">]:</span>
<span class="linenos"> 342</span>                    <span class="n">qa_res</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">find_question_answers_2</span><span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">],</span> <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 343</span>                    <span class="k">if</span> <span class="p">(</span><span class="n">qa_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 344</span>                    <span class="n">qa_res</span> <span class="o">=</span> <span class="n">qa_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 345</span>                    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API] [POST]/api/module - question_id = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;, answer_id=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; =&gt; Question_Answer_id =&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">qa_res</span><span class="p">[</span><span class="s1">&#39;question_answer_id&#39;</span><span class="p">]))</span>
<span class="linenos"> 346</span>                    <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qa_res</span><span class="p">[</span><span class="s1">&#39;question_answer_id&#39;</span><span class="p">]</span>
<span class="linenos"> 347</span>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!----&gt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
<span class="linenos"> 348</span>                
<span class="linenos"> 349</span>                <span class="c1"># Add the recommendation with the link between questions and answers</span>
<span class="linenos"> 350</span>                <span class="n">views</span><span class="o">.</span><span class="n">recommendation</span><span class="o">.</span><span class="n">add_recommendation</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
<span class="linenos"> 351</span>    
<span class="linenos"> 352</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">module_id</span><span class="p">}))</span>  
<span class="linenos"> 353</span>
<span class="linenos"> 354</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 355</span><span class="sd">[Summary]: Get modules.</span>
<span class="linenos"> 356</span><span class="sd">[Returns]: Returns a set of modules.</span>
<span class="linenos"> 357</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 358</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/modules&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 359</span><span class="k">def</span> <span class="nf">get_modules</span><span class="p">():</span>
<span class="linenos"> 360</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 361</span>
<span class="linenos"> 362</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos"> 363</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 364</span>
<span class="linenos"> 365</span>    <span class="c1"># 2. Let&#39;s get the modules from the database.</span>
<span class="linenos"> 366</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 367</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 368</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 369</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, typeID, shortname, fullname, displayname, logicfilename, description, avatar, createdon, updatedon FROM module WHERE disable = 0&quot;</span><span class="p">)</span>
<span class="linenos"> 370</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 371</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 372</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 373</span>    
<span class="linenos"> 374</span>    <span class="c1"># 2.1. Check for empty results. </span>
<span class="linenos"> 375</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 376</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 377</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 378</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos"> 379</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 380</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos"> 381</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 382</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 383</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 384</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 385</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos"> 386</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos"> 387</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;displayname&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos"> 388</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos"> 389</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;plugin&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">check_plugin</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 390</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos"> 391</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="linenos"> 392</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="linenos"> 393</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<span class="linenos"> 394</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos"> 395</span>
<span class="linenos"> 396</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 397</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 398</span>        <span class="c1"># 3. &#39;May the Force be with you, young padawan&#39;.</span>
<span class="linenos"> 399</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos"> 400</span>
<span class="linenos"> 401</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 402</span><span class="sd">[Summary]: Get questions of each module.</span>
<span class="linenos"> 403</span><span class="sd">[Returns]: Returns a set of modules.</span>
<span class="linenos"> 404</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 405</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/modules/questions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 406</span><span class="k">def</span> <span class="nf">get_modules_questions</span><span class="p">():</span>
<span class="linenos"> 407</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 408</span>
<span class="linenos"> 409</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 410</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 411</span>
<span class="linenos"> 412</span>    <span class="c1"># Let&#39;s get the resource from the DB</span>
<span class="linenos"> 413</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 414</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 415</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 416</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT DISTINCT module_id FROM view_module_questions_answers&quot;</span><span class="p">)</span>
<span class="linenos"> 417</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 418</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 419</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 420</span>    
<span class="linenos"> 421</span>    <span class="c1"># Check for empty results. </span>
<span class="linenos"> 422</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 423</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 424</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 425</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos"> 426</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 427</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 428</span>        <span class="c1"># Module IDs first</span>
<span class="linenos"> 429</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 430</span>            <span class="n">module</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 431</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 432</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">find_module_questions</span><span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 433</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 434</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 435</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 436</span>    
<span class="linenos"> 437</span>    <span class="c1"># &#39;May the Force be with you, young padawan&#39;.</span>
<span class="linenos"> 438</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos"> 439</span>
<span class="linenos"> 440</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 441</span><span class="sd">[Summary]: Get answers of each module.</span>
<span class="linenos"> 442</span><span class="sd">[Returns]: Returns a set of modules.</span>
<span class="linenos"> 443</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 444</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/modules/answers&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 445</span><span class="k">def</span> <span class="nf">get_modules_answers</span><span class="p">():</span>
<span class="linenos"> 446</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 447</span>
<span class="linenos"> 448</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 449</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 450</span>
<span class="linenos"> 451</span>    <span class="c1"># Let&#39;s get the resource from the DB</span>
<span class="linenos"> 452</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 453</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 454</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 455</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT DISTINCT module_id FROM view_module_questions_answers&quot;</span><span class="p">)</span>
<span class="linenos"> 456</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 457</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 458</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 459</span>    
<span class="linenos"> 460</span>    <span class="c1"># Check for empty results. </span>
<span class="linenos"> 461</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 462</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 463</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 464</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos"> 465</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 466</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 467</span>        <span class="c1"># Module IDs first</span>
<span class="linenos"> 468</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 469</span>            <span class="n">module</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 470</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 471</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;answers&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">find_module_answers</span><span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 472</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos"> 473</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 474</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 475</span>    
<span class="linenos"> 476</span>    <span class="c1"># &#39;May the Force be with you, young padawan&#39;.</span>
<span class="linenos"> 477</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos"> 478</span>
<span class="linenos"> 479</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 480</span><span class="sd">[Summary]: Get shortName and displayName of each module.</span>
<span class="linenos"> 481</span><span class="sd">[Returns]: Returns a set of modules.</span>
<span class="linenos"> 482</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 483</span><span class="k">def</span> <span class="nf">get_modules_short_displaynames</span><span class="p">():</span>
<span class="linenos"> 484</span>    <span class="c1"># Let&#39;s get the resource from the DB</span>
<span class="linenos"> 485</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 486</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 487</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 488</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT shortname, displayName FROM module&quot;</span><span class="p">)</span>
<span class="linenos"> 489</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 490</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 491</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 492</span>    
<span class="linenos"> 493</span>    <span class="n">short_names</span>   <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 494</span>    <span class="n">display_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 495</span>    <span class="c1"># Module IDs first</span>
<span class="linenos"> 496</span>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 497</span>        <span class="n">short_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 498</span>        <span class="n">display_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos"> 499</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 500</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 501</span>    
<span class="linenos"> 502</span>    <span class="k">return</span> <span class="n">short_names</span><span class="p">,</span> <span class="n">display_names</span>   
<span class="linenos"> 503</span>
<span class="linenos"> 504</span>
<span class="linenos"> 505</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 506</span><span class="sd">[Summary]: Finds a module.</span>
<span class="linenos"> 507</span><span class="sd">[Returns]: Returns a module.</span>
<span class="linenos"> 508</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 509</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 510</span><span class="k">def</span> <span class="nf">find_module</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 511</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 512</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 513</span>
<span class="linenos"> 514</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 515</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos"> 516</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 517</span>    
<span class="linenos"> 518</span>    <span class="c1"># Get the tree of the module and other relevant information.</span>
<span class="linenos"> 519</span>    <span class="n">tree</span>            <span class="o">=</span> <span class="p">(</span><span class="n">get_module_tree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">),</span> <span class="kc">True</span><span class="p">))</span>
<span class="linenos"> 520</span>    <span class="n">recommendations</span> <span class="o">=</span> <span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">recommendation</span><span class="o">.</span><span class="n">find_recommendations_of_module</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
<span class="linenos"> 521</span>    <span class="n">dependencies</span>    <span class="o">=</span> <span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">dependency</span><span class="o">.</span><span class="n">find_dependency_of_module</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
<span class="linenos"> 522</span>    
<span class="linenos"> 523</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dependencies</span><span class="p">):</span> <span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 524</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">recommendations</span><span class="p">):</span> <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 525</span>
<span class="linenos"> 526</span>    <span class="c1"># Let&#39;s get the modules from the database.</span>
<span class="linenos"> 527</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 528</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 529</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 530</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, typeID, shortname, fullname, displayname, logicfilename, description, avatar, createdon, updatedon FROM module WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos"> 531</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 532</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 533</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 534</span>    
<span class="linenos"> 535</span>    <span class="c1"># Check for empty results. </span>
<span class="linenos"> 536</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 537</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 538</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 539</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 540</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos"> 541</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 542</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 543</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 544</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos"> 545</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 546</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 547</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 548</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 549</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos"> 550</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos"> 551</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;displayname&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos"> 552</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos"> 553</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos"> 554</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;avatar&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="linenos"> 555</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="linenos"> 556</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
<span class="linenos"> 557</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>            <span class="o">=</span> <span class="n">tree</span>
<span class="linenos"> 558</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span> <span class="ow">and</span> <span class="n">recommendations</span> <span class="ow">or</span> <span class="p">[]</span>
<span class="linenos"> 559</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">dependencies</span>
<span class="linenos"> 560</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos"> 561</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 562</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 563</span>
<span class="linenos"> 564</span>        <span class="c1"># &#39;May the Force be with you, young padawan&#39;.</span>
<span class="linenos"> 565</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 566</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
<span class="linenos"> 567</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 568</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos"> 569</span>
<span class="linenos"> 570</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 571</span><span class="sd">[Summary]: Finds questions linked to a module.</span>
<span class="linenos"> 572</span><span class="sd">[Returns]: Returns a module.</span>
<span class="linenos"> 573</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 574</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;/questions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 575</span><span class="k">def</span> <span class="nf">find_module_questions</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 576</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 577</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 578</span>
<span class="linenos"> 579</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 580</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 581</span>
<span class="linenos"> 582</span>
<span class="linenos"> 583</span>    <span class="c1"># Let&#39;s get the questions of the module</span>
<span class="linenos"> 584</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 585</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 586</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 587</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT DISTINCT question_id, question, createdon, updatedon FROM view_module_question WHERE module_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos"> 588</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 589</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 590</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 591</span>    
<span class="linenos"> 592</span>    <span class="c1"># Check for empty results. </span>
<span class="linenos"> 593</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 594</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 595</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 596</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 597</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos"> 598</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 599</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 600</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 601</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array to be populated with data from the DB.</span>
<span class="linenos"> 602</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 603</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 604</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 605</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 606</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos"> 607</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos"> 608</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos"> 609</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 610</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 611</span>
<span class="linenos"> 612</span>        <span class="c1"># &#39;May the Force be with you, young padawan&#39;.</span>
<span class="linenos"> 613</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 614</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
<span class="linenos"> 615</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 616</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos"> 617</span>
<span class="linenos"> 618</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 619</span><span class="sd">[Summary]: Finds answers linked to a module.</span>
<span class="linenos"> 620</span><span class="sd">[Returns]: Returns a module.</span>
<span class="linenos"> 621</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 622</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;/answers&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 623</span><span class="k">def</span> <span class="nf">find_module_answers</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 624</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 625</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 626</span>
<span class="linenos"> 627</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 628</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 629</span>
<span class="linenos"> 630</span>    <span class="c1"># Let&#39;s get the answers linked to the current module.</span>
<span class="linenos"> 631</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 632</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 633</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 634</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT DISTINCT answer_id, answer, createdon, updatedon FROM view_module_answers WHERE module_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos"> 635</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 636</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 637</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 638</span>    
<span class="linenos"> 639</span>    <span class="c1"># Check for empty results. </span>
<span class="linenos"> 640</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 641</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 642</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 643</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 644</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos"> 645</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 646</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 647</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 648</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array to be populated with data from the DB.</span>
<span class="linenos"> 649</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 650</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 651</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 652</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 653</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos"> 654</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos"> 655</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos"> 656</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 657</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 658</span>
<span class="linenos"> 659</span>        <span class="c1"># &#39;May the Force be with you, young padawan&#39;.</span>
<span class="linenos"> 660</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 661</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
<span class="linenos"> 662</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 663</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos"> 664</span>
<span class="linenos"> 665</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 666</span><span class="sd">[Summary]: Get the tree of the module. This tree contains all the questions and answers.</span>
<span class="linenos"> 667</span><span class="sd">[Returns]: A set of questions, its children, and its answers.</span>
<span class="linenos"> 668</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 669</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;pID&gt;/tree&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos"> 670</span><span class="k">def</span> <span class="nf">get_module_tree</span><span class="p">(</span><span class="n">pID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 671</span>    <span class="c1"># Do you want to add recommendations to the tree? For example, if an answer is X than the recommendation is Y, and so on. This feature is still experimental.</span>
<span class="linenos"> 672</span>    <span class="n">add_recommendations_to_tree</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 673</span>    <span class="n">IDS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 674</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 675</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 676</span>
<span class="linenos"> 677</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos"> 678</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 679</span>
<span class="linenos"> 680</span>    <span class="c1"># 1.1. Check if the user needs information about all modules available on the database.</span>
<span class="linenos"> 681</span>    <span class="k">if</span> <span class="p">(</span><span class="n">pID</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">):</span>
<span class="linenos"> 682</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 683</span>            <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 684</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 685</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM Module ORDER BY ID ASC&quot;</span><span class="p">)</span>
<span class="linenos"> 686</span>            <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 687</span>            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 688</span>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 689</span>                    <span class="n">IDS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="linenos"> 690</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 691</span>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 692</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 693</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 694</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 695</span>        <span class="n">IDS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pID</span><span class="p">)</span>
<span class="linenos"> 696</span>
<span class="linenos"> 697</span>    <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 698</span>    <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">IDS</span><span class="p">:</span>
<span class="linenos"> 699</span>        <span class="c1"># print(&quot; Processing Data of Module &quot; + str(ID))</span>
<span class="linenos"> 700</span>        <span class="c1"># 2. Let&#39;s get the main questions of the module.</span>
<span class="linenos"> 701</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 702</span>            <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 703</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 704</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT module_id, module_displayname, question_id, question, questionorder, multipleAnswers FROM view_module_question WHERE module_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos"> 705</span>            <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 706</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 707</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 708</span>        
<span class="linenos"> 709</span>        <span class="c1"># 2.2. Check for empty results - &#39;Fasten your seatbelts. It&#39;s going to be a bumpy night&#39;.</span>
<span class="linenos"> 710</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 711</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 712</span>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 713</span>            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IDS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 714</span>                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 715</span>                    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos"> 716</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 717</span>                    <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 718</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 719</span>                <span class="k">continue</span>
<span class="linenos"> 720</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 721</span>            <span class="c1"># 2.2.1. The initial set of the information about the module.</span>
<span class="linenos"> 722</span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span> 
<span class="linenos"> 723</span>                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
<span class="linenos"> 724</span>                <span class="k">break</span>
<span class="linenos"> 725</span>            <span class="c1"># 2.2.2. Map questions of the module to a JSON Python Object (dic).</span>
<span class="linenos"> 726</span>            <span class="n">questions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 727</span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 728</span>                <span class="n">question</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;question&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;multipleAnswers&quot;</span> <span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;children&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="linenos"> 729</span>                <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="linenos"> 730</span>            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;tree&quot;</span><span class="p">:</span>  <span class="n">questions</span><span class="p">})</span>
<span class="linenos"> 731</span>
<span class="linenos"> 732</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 733</span>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 734</span>        
<span class="linenos"> 735</span>        <span class="c1"># 3. Recursively get each question child and corresponding data (question, answer, and so on).</span>
<span class="linenos"> 736</span>        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span> 
<span class="linenos"> 737</span>            <span class="n">get_children</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">add_recommendations_to_tree</span><span class="p">)</span>
<span class="linenos"> 738</span>             
<span class="linenos"> 739</span>
<span class="linenos"> 740</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">IDS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>    
<span class="linenos"> 741</span>            <span class="c1"># 4. &#39;May the Force be with you&#39;.</span>
<span class="linenos"> 742</span>            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 743</span>                <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos"> 744</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 745</span>                <span class="c1">#del data[request.path]</span>
<span class="linenos"> 746</span>                <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">])</span>
<span class="linenos"> 747</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 748</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos"> 749</span>    
<span class="linenos"> 750</span>    <span class="c1"># 4. &#39;May the Force be with you&#39;.</span>
<span class="linenos"> 751</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 752</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
<span class="linenos"> 753</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 754</span>        <span class="k">del</span> <span class="n">datas</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>
<span class="linenos"> 755</span>        <span class="c1"># print(&quot;### = &quot; + str(datas[&#39;tree&#39;]))</span>
<span class="linenos"> 756</span>        <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">])</span>
<span class="linenos"> 757</span>
<span class="linenos"> 758</span>
<span class="linenos"> 759</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 760</span><span class="sd">[Summary]: Auxiliary function to check if a subquestion is no longer linked to parent one. </span>
<span class="linenos"> 761</span><span class="sd">[Arguments]:</span>
<span class="linenos"> 762</span><span class="sd">    - $parent$: Parent id.</span>
<span class="linenos"> 763</span><span class="sd">    - $values$: Child id.</span>
<span class="linenos"> 764</span><span class="sd">    - $trigger$; Answer id. </span>
<span class="linenos"> 765</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 766</span><span class="k">def</span> <span class="nf">subquestion_parent_changed</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">trigger</span><span class="p">):</span>
<span class="linenos"> 767</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 768</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 769</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 770</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM question_has_child WHERE parent=</span><span class="si">%s</span><span class="s2"> AND child=</span><span class="si">%s</span><span class="s2"> AND ontrigger=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">trigger</span><span class="p">))</span>
<span class="linenos"> 771</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM question_has_child WHERE parent=</span><span class="si">%s</span><span class="s2"> AND child=</span><span class="si">%s</span><span class="s2"> AND ontrigger=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">trigger</span><span class="p">))</span>
<span class="linenos"> 772</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 773</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 774</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 775</span>
<span class="linenos"> 776</span>    <span class="c1"># 2.1. Check for empty results. </span>
<span class="linenos"> 777</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 778</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 779</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 780</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>    
<span class="linenos"> 781</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 782</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 783</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 784</span>        <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 785</span>
<span class="linenos"> 786</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 787</span><span class="sd">[Summary]: Auxiliary functions to check if an answer or question is no longer is parent or child.</span>
<span class="linenos"> 788</span><span class="sd">[Arguments]:</span>
<span class="linenos"> 789</span><span class="sd">    - $question_id$: Parent id.</span>
<span class="linenos"> 790</span><span class="sd">    - $answer_id$: Child id.</span>
<span class="linenos"> 791</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 792</span><span class="k">def</span> <span class="nf">parent_changed</span><span class="p">(</span><span class="n">question_id</span><span class="p">,</span> <span class="n">answer_id</span><span class="p">):</span>
<span class="linenos"> 793</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 794</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 795</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 796</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM question_answer WHERE questionID=</span><span class="si">%s</span><span class="s2"> AND answerID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">question_id</span><span class="p">,</span> <span class="n">answer_id</span><span class="p">))</span>
<span class="linenos"> 797</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID FROM question_answer WHERE questionID=</span><span class="si">%s</span><span class="s2"> AND answerID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">question_id</span><span class="p">,</span> <span class="n">answer_id</span><span class="p">))</span>
<span class="linenos"> 798</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 799</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 800</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 801</span>
<span class="linenos"> 802</span>    <span class="c1"># 2.1. Check for empty results. </span>
<span class="linenos"> 803</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 804</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 805</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 806</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>    
<span class="linenos"> 807</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 808</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 809</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 810</span>        <span class="k">return</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 811</span>
<span class="linenos"> 812</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 813</span><span class="sd">[Summary]: When a new question or answer is added on the client side an ID is generated for each one. After that, the user is required to add recommendations. </span>
<span class="linenos"> 814</span><span class="sd">           These recommendations will be given taking into account if the user has selected a set of answers to a set of questions. The mapping of questions and </span>
<span class="linenos"> 815</span><span class="sd">           answers temporarily uses the previous generated ID. After the process of adding each question and answer to the database, that temporary ID needs to be </span>
<span class="linenos"> 816</span><span class="sd">           updated to the new one (i.e., the ID that identifies each question and answer on the database). </span>
<span class="linenos"> 817</span><span class="sd">[Arguments]:</span>
<span class="linenos"> 818</span><span class="sd">    - $client_id$: The id temporary assigned (on the client side) to a question or answer.</span>
<span class="linenos"> 819</span><span class="sd">    - $database_id$: The &#39;real&#39; id of the question or answer that is used to update a recommendation.</span>
<span class="linenos"> 820</span><span class="sd">    - $recommendations$: The list of recommendations.</span>
<span class="linenos"> 821</span><span class="sd">    - $is_question$: Flag to ascertain if the mapping operation of client_id =&gt; database_id is to be performed on a question or an answer.</span>
<span class="linenos"> 822</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 823</span><span class="k">def</span> <span class="nf">update_questions_answers_ids</span><span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">database_id</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">,</span> <span class="n">is_question</span><span class="p">):</span>
<span class="linenos"> 824</span>    <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 825</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span>
<span class="linenos"> 826</span>        <span class="k">if</span> <span class="p">(</span><span class="n">is_question</span><span class="p">):</span>
<span class="linenos"> 827</span>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API] update_questions_answers_ids() =&gt; Trying to find client_question_id = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in recommendations list.&quot;</span><span class="p">)</span>
<span class="linenos"> 828</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 829</span>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API] update_questions_answers_ids() =&gt; Trying to find client_question_id = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in recommendations list.&quot;</span><span class="p">)</span>
<span class="linenos"> 830</span>    
<span class="linenos"> 831</span>    <span class="k">if</span> <span class="p">(</span><span class="n">recommendations</span><span class="p">):</span>
<span class="linenos"> 832</span>        <span class="k">for</span> <span class="n">recommendation</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">:</span>
<span class="linenos"> 833</span>            <span class="c1"># if (&quot;questions_answers&quot; not in recommendation): continue</span>
<span class="linenos"> 834</span>            <span class="k">for</span> <span class="n">question_answer</span> <span class="ow">in</span> <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;questions_answers&#39;</span><span class="p">]:</span>
<span class="linenos"> 835</span>                <span class="c1"># Update the questions to the real ID</span>
<span class="linenos"> 836</span>                <span class="k">if</span> <span class="p">(</span><span class="n">is_question</span><span class="p">):</span>
<span class="linenos"> 837</span>                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;client_question_id&quot;</span> <span class="ow">in</span> <span class="n">question_answer</span><span class="p">):</span>
<span class="linenos"> 838</span>                        <span class="k">if</span> <span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;client_question_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">client_id</span><span class="p">):</span>
<span class="linenos"> 839</span>                            <span class="k">del</span> <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;client_question_id&#39;</span><span class="p">]</span>
<span class="linenos"> 840</span>                            <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">database_id</span>
<span class="linenos"> 841</span>                            <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API] update_questions_answers_ids() =&gt; Found it, updating node = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">question_answer</span><span class="p">))</span>
<span class="linenos"> 842</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 843</span>                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;client_answer_id&quot;</span> <span class="ow">in</span> <span class="n">question_answer</span><span class="p">):</span>
<span class="linenos"> 844</span>                        <span class="k">if</span> <span class="p">(</span><span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;client_answer_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">client_id</span><span class="p">):</span>
<span class="linenos"> 845</span>                            <span class="k">del</span> <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;client_answer_id&#39;</span><span class="p">]</span>
<span class="linenos"> 846</span>                            <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">database_id</span>
<span class="linenos"> 847</span>                            <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API] update_questions_answers_ids() =&gt; Found it, updating node = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">question_answer</span><span class="p">))</span>
<span class="linenos"> 848</span>
<span class="linenos"> 849</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 850</span><span class="sd">[Summary]: Iterates the module tree that contains the mapping of questions and answers. This is an auxiliary function of add_module() and update_module().</span>
<span class="linenos"> 851</span><span class="sd">[Arguments]:</span>
<span class="linenos"> 852</span><span class="sd">    - $module_id$: Id of the newly created module.</span>
<span class="linenos"> 853</span><span class="sd">    - $node$:  current node of the tree being processed. </span>
<span class="linenos"> 854</span><span class="sd">    - $p_node$: Previous node or parent node.</span>
<span class="linenos"> 855</span><span class="sd">    - $p_p_node$: Parent of the parent node.</span>
<span class="linenos"> 856</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 857</span><span class="k">def</span> <span class="nf">iterate_tree_nodes</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">module_id</span><span class="p">,</span> <span class="n">c_node</span><span class="p">,</span> <span class="n">p_node</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">p_p_node</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 858</span>    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos"> 859</span>    <span class="c1"># print(&quot;[SAM-API] Processing current node = &#39;&quot;+ str(c_node[&#39;name&#39;])+&quot;&#39;&quot;)</span>
<span class="linenos"> 860</span>    <span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="linenos"> 861</span>
<span class="linenos"> 862</span>    <span class="c1"># In the case of an UPDATE operation, we need to check if this question is available on the database; if not, </span>
<span class="linenos"> 863</span>    <span class="c1"># this means that the user has added a new question/answer and the values are in need of being processed with an INSERT operation.</span>
<span class="linenos"> 864</span>    <span class="c1"># ---&gt; We need to change the operation from UPDATE TO INSERT after encountering this situation. </span>
<span class="linenos"> 865</span>    <span class="c1"># ---&gt; We can check if a question/answer is NOT available on the database if c_node[&#39;id&#39;] == null</span>
<span class="linenos"> 866</span>    <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;UPDATE&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])):</span> 
<span class="linenos"> 867</span>        <span class="n">operation</span> <span class="o">=</span> <span class="s2">&quot;INSERT&quot;</span>
<span class="linenos"> 868</span>
<span class="linenos"> 869</span>    <span class="c1"># 1. Check if the current node is a question or an answer.</span>
<span class="linenos"> 870</span>    <span class="k">if</span> <span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;question&quot;</span><span class="p">):</span> 
<span class="linenos"> 871</span>        
<span class="linenos"> 872</span>        <span class="c1"># 1.1. Add or update question - Table [Question].</span>
<span class="linenos"> 873</span>        <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">):</span>
<span class="linenos"> 874</span>            <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;INSERT INTO question (content, multipleAnswers) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="linenos"> 875</span>            <span class="n">values</span>  <span class="o">=</span>  <span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;multipleAnswers&#39;</span><span class="p">])</span>
<span class="linenos"> 876</span>            <span class="n">exists_flag</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 877</span>            <span class="c1"># Check if the question already exists (i.e. if c_node[&#39;id&#39;] == null)</span>
<span class="linenos"> 878</span>            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]):</span>
<span class="linenos"> 879</span>                <span class="n">c_node</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)})</span>
<span class="linenos"> 880</span>                <span class="c1"># By knowing the client_id update recommendations questions and answers to the database id (c_node[&#39;id&#39;]).</span>
<span class="linenos"> 881</span>                <span class="n">update_questions_answers_ids</span><span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">recommendations</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 882</span>
<span class="linenos"> 883</span>            <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 884</span>        <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">):</span>
<span class="linenos"> 885</span>            <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;UPDATE question SET content=</span><span class="si">%s</span><span class="s2">, multipleAnswers=</span><span class="si">%s</span><span class="s2"> WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="linenos"> 886</span>            <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;multipleAnswers&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos"> 887</span>            <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 888</span>            <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 889</span>
<span class="linenos"> 890</span>        
<span class="linenos"> 891</span>        <span class="c1"># 1.2. Add link to table [Module_Question] - Link question and the module together.</span>
<span class="linenos"> 892</span>        <span class="c1"># Be aware, that child questions are not added to this table. That is, only questions are mapped to modules.</span>
<span class="linenos"> 893</span>        <span class="k">if</span> <span class="p">(</span><span class="n">p_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 894</span>            <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">):</span>
<span class="linenos"> 895</span>                <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;INSERT INTO module_question (moduleID, questionID, questionOrder) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="linenos"> 896</span>                <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span><span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 897</span>                <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 898</span>                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [?] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 899</span>
<span class="linenos"> 900</span>        <span class="c1"># 1.3. Add Sub question to table [Question_has_Child] - Link question and subquestions by a trigger (i.e., answer).</span>
<span class="linenos"> 901</span>        <span class="c1"># Knowing that the current node is a parent, this is accomplish by checking if the parent was an answer. </span>
<span class="linenos"> 902</span>        <span class="k">if</span> <span class="p">(</span><span class="n">p_node</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 903</span>            <span class="k">if</span> <span class="p">(</span><span class="n">p_node</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;answer&quot;</span><span class="p">):</span> 
<span class="linenos"> 904</span>
<span class="linenos"> 905</span>                <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">):</span>
<span class="linenos"> 906</span>                    <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;INSERT INTO question_has_child (parent, child, ontrigger, questionOrder) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="linenos"> 907</span>                    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p_p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 908</span>                    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 909</span>                    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [?] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 910</span>                
<span class="linenos"> 911</span>                <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">):</span>
<span class="linenos"> 912</span>                    <span class="k">if</span> <span class="p">(</span><span class="n">subquestion_parent_changed</span><span class="p">(</span><span class="n">p_p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])):</span>
<span class="linenos"> 913</span>                        <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [?] New Link detected&quot;</span><span class="p">)</span>
<span class="linenos"> 914</span>                        <span class="c1"># Remove the previous link</span>
<span class="linenos"> 915</span>                        <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;DELETE FROM question_has_child WHERE child=</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="linenos"> 916</span>                        <span class="n">values</span>  <span class="o">=</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos"> 917</span>                        <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     -&gt; &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 918</span>                        <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 919</span>                        <span class="c1"># Add the new link</span>
<span class="linenos"> 920</span>                        <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;INSERT INTO question_has_child (parent, child, ontrigger, questionOrder) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="linenos"> 921</span>                        <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p_p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 922</span>                        <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     -&gt; &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 923</span>                        <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 924</span>    <span class="k">else</span><span class="p">:</span> 
<span class="linenos"> 925</span>        <span class="c1"># 1.1. Add or update answer - Table [Answer].</span>
<span class="linenos"> 926</span>        <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">):</span>
<span class="linenos"> 927</span>            <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;INSERT INTO answer (content) VALUES (</span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="linenos"> 928</span>            <span class="n">values</span>  <span class="o">=</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
<span class="linenos"> 929</span>            <span class="n">exists_flag</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 930</span>            <span class="c1"># Check if the answer already exists (i.e. if c_node[&#39;id&#39;] == null)</span>
<span class="linenos"> 931</span>            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]):</span>
<span class="linenos"> 932</span>                <span class="c1"># Check if the answer is similar or equal to one already available on the database, if so, use the id of the one that is equal</span>
<span class="linenos"> 933</span>                <span class="c1"># This is performed by checking the contents of an answer. No need to create a new answer on the database if one similar is already available.</span>
<span class="linenos"> 934</span>                <span class="n">node_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_already_exists</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="s2">&quot;SELECT id, content FROM answer WHERE content LIKE </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
<span class="linenos"> 935</span>                <span class="nb">print</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
<span class="linenos"> 936</span>                <span class="k">if</span> <span class="p">(</span><span class="n">node_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 937</span>                    <span class="n">c_node</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)})</span> <span class="c1"># Store the ID of the newly created answer.</span>
<span class="linenos"> 938</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 939</span>                    <span class="n">c_node</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">node_id</span><span class="p">})</span> <span class="c1"># Store the ID of an answer that was previsouly inserted on the database. </span>
<span class="linenos"> 940</span>
<span class="linenos"> 941</span>                <span class="c1"># By knowing the client_id update recommendations questions and answers to the database id (c_node[&#39;id&#39;]).</span>
<span class="linenos"> 942</span>                <span class="n">update_questions_answers_ids</span><span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;client_id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">recommendations</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<span class="linenos"> 943</span>
<span class="linenos"> 944</span>            <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 945</span>        
<span class="linenos"> 946</span>        <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">):</span>
<span class="linenos"> 947</span>            <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;UPDATE answer SET content=</span><span class="si">%s</span><span class="s2"> WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span>
<span class="linenos"> 948</span>            <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos"> 949</span>            <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 950</span>            <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 951</span>        
<span class="linenos"> 952</span>        <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">):</span>
<span class="linenos"> 953</span>            <span class="c1"># 1.2. Add link to table [Question_Answer] - Link question and answer together.</span>
<span class="linenos"> 954</span>            <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;INSERT INTO question_answer (questionID, answerID) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="linenos"> 955</span>            <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos"> 956</span>            <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 957</span>            <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [?] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 958</span>        
<span class="linenos"> 959</span>        <span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="s2">&quot;UPDATE&quot;</span><span class="p">):</span>
<span class="linenos"> 960</span>            <span class="c1"># Check if the link between the current answer node and a question was changed (i.e., parent change).</span>
<span class="linenos"> 961</span>            <span class="c1"># If true remove the previous link and assigned the new one</span>
<span class="linenos"> 962</span>            <span class="k">if</span> <span class="p">(</span><span class="n">parent_changed</span><span class="p">(</span><span class="n">p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])):</span>
<span class="linenos"> 963</span>                <span class="c1"># Remove the previous one</span>
<span class="linenos"> 964</span>                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; [?] New Link detected&quot;</span><span class="p">)</span>
<span class="linenos"> 965</span>                <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;DELETE FROM question_answer WHERE answerID=</span><span class="si">%s</span><span class="s2"> AND questionID IN (SELECT questionID From question_answer WHRE answerID=</span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="linenos"> 966</span>                <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos"> 967</span>                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    -&gt; [?] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 968</span>                <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 969</span>                <span class="c1"># Add new updated link</span>
<span class="linenos"> 970</span>                <span class="n">sql</span>     <span class="o">=</span> <span class="s2">&quot;INSERT INTO question_answer (questionID, answerID) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span>
<span class="linenos"> 971</span>                <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">p_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos"> 972</span>                <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 973</span>                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    -&gt; [?] = &#39;&quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 974</span>
<span class="linenos"> 975</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 976</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 977</span>        <span class="c1"># Recursively iterate </span>
<span class="linenos"> 978</span>        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">c_node</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
<span class="linenos"> 979</span>            <span class="n">iterate_tree_nodes</span><span class="p">(</span><span class="n">recommendations</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">module_id</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">c_node</span><span class="p">,</span> <span class="n">p_node</span><span class="p">)</span>
<span class="linenos"> 980</span>    <span class="k">except</span><span class="p">:</span>
<span class="linenos"> 981</span>        <span class="k">pass</span>
<span class="linenos"> 982</span>    <span class="k">return</span>
<span class="linenos"> 983</span>
<span class="linenos"> 984</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 985</span><span class="sd">[Summary]: Auxiliary function to get the sub-questions of a set of questions, and the sub-questions of </span>
<span class="linenos"> 986</span><span class="sd">           those, and so on. This is accomplished through our &#39;friendly neighbor&#39; - recursivity. </span>
<span class="linenos"> 987</span><span class="sd">[Arguments]:</span>
<span class="linenos"> 988</span><span class="sd">    - $initial$:  This flag must be set to true if it is the initial call of the recursive function.</span>
<span class="linenos"> 989</span><span class="sd">    - $c_childs$: Array that contains the childs of a question ($question_js$ Python object), this must be initially empty.</span>
<span class="linenos"> 990</span><span class="sd">    - $question$: Current question being analysed (has childs ?).</span>
<span class="linenos"> 991</span><span class="sd">    - $question_js$: The JSON Python object being populate with data (question information, answers, and so on.)</span>
<span class="linenos"> 992</span><span class="sd">[Returns]: Returns a JSON object with the mapping of all childs of a set of questions.</span>
<span class="linenos"> 993</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 994</span><span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">add_recommendations_to_tree</span><span class="p">):</span>
<span class="linenos"> 995</span>    <span class="n">children</span> <span class="o">=</span> <span class="n">question</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span>
<span class="linenos"> 996</span>    <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 997</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Parsing question [</span><span class="si">%s</span><span class="s2">] - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">question</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
<span class="linenos"> 998</span>    <span class="c1"># 1. Get answers of the parent question.</span>
<span class="linenos"> 999</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">1000</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">1001</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">1002</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT answer_id, answer FROM view_question_answer WHERE question_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">1003</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">1004</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">1005</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">1006</span>    
<span class="linenos">1007</span>    <span class="c1"># 1.2. Store, if available, answers of the parent question - An answer is a child of a parent question.</span>
<span class="linenos">1008</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">1009</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">1010</span>            <span class="n">answer</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;children&quot;</span> <span class="p">:</span> <span class="p">[]}</span>
<span class="linenos">1011</span>            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span>     
<span class="linenos">1012</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># Clean the house nice &amp; tidy.</span>
<span class="linenos">1013</span>
<span class="linenos">1014</span>    <span class="c1"># 2. Check if the current question has children; IF not, return.</span>
<span class="linenos">1015</span>    <span class="c1">#    This is the illusive break/return condition of this recursive function - &#39;Elementary, my dear Watson.&#39;</span>
<span class="linenos">1016</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">1017</span>
<span class="linenos">1018</span>    <span class="c1"># Get recommendation(s) for the current answer and question.</span>
<span class="linenos">1019</span>    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
<span class="linenos">1020</span>        <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;question&#39;</span><span class="p">):</span> <span class="k">continue</span>
<span class="linenos">1021</span>
<span class="linenos">1022</span>
<span class="linenos">1023</span>    <span class="c1"># 3. Get sub-questions triggered by an answer </span>
<span class="linenos">1024</span>    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
<span class="linenos">1025</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">1026</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">1027</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT child_id, question, questionOrder, ontrigger, multipleAnswers FROM view_question_childs WHERE parent_id=</span><span class="si">%s</span><span class="s2"> AND ontrigger=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">child</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
<span class="linenos">1028</span>            <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">1029</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">1030</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">1031</span>        
<span class="linenos">1032</span>        <span class="c1"># 3.1. Store it!</span>
<span class="linenos">1033</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">1034</span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">1035</span>                <span class="n">s_question</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;multipleAnswers&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;question&quot;</span><span class="p">,</span><span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="s2">&quot;trigger&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="s2">&quot;children&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="linenos">1036</span>                <span class="n">child</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_question</span><span class="p">)</span>
<span class="linenos">1037</span>        
<span class="linenos">1038</span>        <span class="c1"># 3.2. If requested, and a sub-question is no where to be found for the current child, the list of recommendations will be added as children to the current answer.</span>
<span class="linenos">1039</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1040</span>            <span class="k">if</span> <span class="p">(</span><span class="n">add_recommendations_to_tree</span><span class="p">):</span>
<span class="linenos">1041</span>                <span class="n">recommendations</span> <span class="o">=</span> <span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">recommendation</span><span class="o">.</span><span class="n">find_recommendations_of_question_answer</span><span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">child</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span><span class="o">.</span><span class="n">json</span>
<span class="linenos">1042</span>                <span class="c1"># print(str(recommendations))</span>
<span class="linenos">1043</span>                <span class="k">if</span> <span class="p">(</span><span class="n">recommendations</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span> <span class="n">child</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span>
<span class="linenos">1044</span>            
<span class="linenos">1045</span>            
<span class="linenos">1046</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">1047</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">1048</span>
<span class="linenos">1049</span>    <span class="c1"># Debug</span>
<span class="linenos">1050</span>    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span>
<span class="linenos">1051</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;!&gt; Question [</span><span class="si">%s</span><span class="s2">] (&#39;</span><span class="si">%s</span><span class="s2">&#39;) has the following answers:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">question</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
<span class="linenos">1052</span>        <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
<span class="linenos">1053</span>            <span class="k">if</span> <span class="p">(</span><span class="n">answer</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;answer&quot;</span><span class="p">):</span>
<span class="linenos">1054</span>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  -&gt; Answer ID[</span><span class="si">%d</span><span class="s2">] - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">answer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">answer</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
<span class="linenos">1055</span>                <span class="k">for</span> <span class="n">s_question</span> <span class="ow">in</span> <span class="n">answer</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
<span class="linenos">1056</span>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     -&gt; Question ID[</span><span class="si">%d</span><span class="s2">] - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s_question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">s_question</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
<span class="linenos">1057</span>
<span class="linenos">1058</span>    <span class="c1"># 4. Recursive calls and python JSON object construction</span>
<span class="linenos">1059</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span> <span class="n">question</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;expanded&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<span class="linenos">1060</span>    <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
<span class="linenos">1061</span>        <span class="n">t_answer</span> <span class="o">=</span> <span class="n">answer</span>
<span class="linenos">1062</span>        <span class="c1"># We need to go deeper in order to find the questions to be parsed to this recursive function.</span>
<span class="linenos">1063</span>        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="n">answer</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]:</span>
<span class="linenos">1064</span>            <span class="n">t_answer</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;expanded&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<span class="linenos">1065</span>            <span class="k">if</span> <span class="p">(</span><span class="n">question</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;recommendation&#39;</span><span class="p">):</span>
<span class="linenos">1066</span>                <span class="n">get_children</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">question</span><span class="p">,</span> <span class="n">add_recommendations_to_tree</span><span class="p">)</span>
<span class="linenos">1067</span> 
<span class="linenos">1068</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1069</span><span class="sd">[Summary]: Checks if a module is a plugin.</span>
<span class="linenos">1070</span><span class="sd">[Returns]: Returns a Boolean.</span>
<span class="linenos">1071</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">1072</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/module/&lt;ID&gt;/type&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">1073</span><span class="k">def</span> <span class="nf">check_plugin</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">1074</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">1075</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">1076</span>
<span class="linenos">1077</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">1078</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">1079</span>
<span class="linenos">1080</span>    <span class="n">tree</span> <span class="o">=</span> <span class="n">get_module_tree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">1081</span>
<span class="linenos">1082</span>    <span class="k">if</span> <span class="p">(</span><span class="n">tree</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">1083</span>        <span class="n">plugin</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1084</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">1085</span>        <span class="n">plugin</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1086</span>
<span class="linenos">1087</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">1088</span>        <span class="k">return</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
<span class="linenos">1089</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">1090</span>        <span class="k">return</span> <span class="n">plugin</span>
</pre></div>
</div>
</details><section id="get-modules">
<h2>Get Modules<a class="headerlink" href="#get-modules" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/module</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of modules installed in the platform.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module.</p></li>
<li><p><strong>type_id</strong> (<em>int</em>) – Module type id.</p></li>
<li><p><strong>shortname</strong> (<em>string</em>) – Unique short name or abbreviation.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Module description.</p></li>
<li><p><strong>fullname</strong> (<em>string</em>) – Full name of the module.</p></li>
<li><p><strong>displayname</strong> (<em>string</em>) – Module display name that can be used by a frontend.</p></li>
<li><p><strong>avatar</strong> (<em>string</em>) – Avatar of the user (i.e., location in disk).</p></li>
<li><p><strong>logic_filename</strong> (<em>string</em>) – Filename of the file containing the dynamic logic of the module.</p></li>
<li><p><strong>plugin</strong> (<em>boolean</em>) – A flag that sets if the current module is a plugin.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve module.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/modules&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;type_id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="s2">&quot;SRE&quot;</span><span class="p">,</span>
            <span class="nt">&quot;fullname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Elicitation&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements&quot;</span><span class="p">,</span>
            <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;logic_filename&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;plugin&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Tue, 28 Sep 2021 13:42:48 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Tue, 28 Sep 2021 13:48:19 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get a module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module.</p></li>
<li><p><strong>type_id</strong> (<em>int</em>) – Module type id.</p></li>
<li><p><strong>dependencies</strong> (<em>array</em>) – An array that contains the set of modules that the current module depends on.</p></li>
<li><p><strong>shortname</strong> (<em>string</em>) – Unique short name or abbreviation.</p></li>
<li><p><strong>displayname</strong> (<em>string</em>) – Module display name that can be used by a frontend.</p></li>
<li><p><strong>fullname</strong> (<em>string</em>) – Full name of the module.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Module description.</p></li>
<li><p><strong>logic_filename</strong> (<em>string</em>) – Filename of the file containing the dynamic logic of the module.</p></li>
<li><p><strong>avatar</strong> (<em>string</em>) – Avatar of the user (i.e., location in disk).</p></li>
<li><p><strong>recommendations</strong> (<em>array</em>) – Set of recommendations mapped to this module.</p></li>
<li><p><strong>tree</strong> (<em>array</em>) – An array that contains the set of questions and answers mapped for the current module.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve module.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/module/1&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;type_id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;dependencies&quot;</span><span class="p">:[],</span>
            <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="s2">&quot;SRE&quot;</span><span class="p">,</span>
            <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements&quot;</span><span class="p">,</span>
            <span class="nt">&quot;fullname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Elicitation&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;logic_filename&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;recommendations&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;questions_answers&quot;</span><span class="p">:[</span>
                     <span class="p">{</span>
                        <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                        <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                        <span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                        <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 12:54:49 GMT&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 12:54:49 GMT&quot;</span>
                     <span class="p">}</span>
                  <span class="p">],</span>
                  <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 12:54:49 GMT&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 12:54:49 GMT&quot;</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;tree&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;order&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                  <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;multipleAnswers&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                  <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;question&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;children&quot;</span><span class="p">:[</span>
                     <span class="p">{</span>
                        <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;children&quot;</span><span class="p">:[],</span>
                     <span class="p">},</span>
                     <span class="p">{</span>
                        <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;children&quot;</span><span class="p">:[]</span>
                     <span class="p">}</span>
                  <span class="p">],</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 12:54:49 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 12:54:49 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="get-module-type">
<h2>Get Module Type<a class="headerlink" href="#get-module-type" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/type</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the type of module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>boolean</em>) – A flag that sets if the current module is a plugin, true if the correct module is a plugin, false otherwise.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module type successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve module type information.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A module plugin comprises questions and answers, while a module that is not a plugin fully depends on other modules to produce output.</p>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/module/1/type&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="kc">false</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="get-questions-answers-of-a-module">
<h2>Get Questions/Answers of a Module<a class="headerlink" href="#get-questions-answers-of-a-module" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/tree</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the <code class="docutils literal notranslate"><span class="pre">tree</span></code> array of questions and answers of a module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the current question or answer in the array depending of the <code class="docutils literal notranslate"><span class="pre">type</span></code>.</p></li>
<li><p><strong>order</strong> (<em>int</em>) – The sequencial number of the question.</p></li>
<li><p><strong>children</strong> (<em>array</em>) – The current module has a set of questions or answers that are mapped to this array.</p></li>
<li><p><strong>name</strong> (<em>string</em>) – The content/text of the current question.</p></li>
<li><p><strong>type</strong> (<em>string</em>) – Defines if the current element in the tree array is a <code class="docutils literal notranslate"><span class="pre">question</span></code> or an <code class="docutils literal notranslate"><span class="pre">answer</span></code>.</p></li>
<li><p><strong>multipleAnswers</strong> (<em>boolean</em>) – Defines if the user can select multiple answers for the current question.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module tree successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve tree of the module.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please, consider using something like, for example, the <a class="reference external" href="https://github.com/frontend-collective/react-sortable-tree/">react-sortable-tree</a> react component to develop a proper user interface to interact and manage the data returned by this service.</p>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/module/1/tree&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;tree&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;order&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
            <span class="nt">&quot;multipleAnswers&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="nt">&quot;question&quot;</span>
            <span class="nt">&quot;children&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;children&quot;</span><span class="p">:[]</span>
               <span class="p">},</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                  <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;children&quot;</span><span class="p">:[]</span>
               <span class="p">}</span>
            <span class="p">],</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="get-questions-of-modules">
<h2>Get Questions of Modules<a class="headerlink" href="#get-questions-of-modules" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/module/questions</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of questions mapped to each module.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Module or question id.</p></li>
<li><p><strong>questions</strong> (<em>array</em>) – Array of questions.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module’s questions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve module’s questions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/modules/questions&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">[</span>
         <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nt">&quot;questions&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
               <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
               <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
               <span class="nt">&quot;createdon&quot;</span><span class="p">:</span> <span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
               <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span> <span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
            <span class="p">}</span>
         <span class="p">]</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/questions</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of questions mapped to a module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Module or question id.</p></li>
<li><p><strong>questions</strong> (<em>array</em>) – Array of questions.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module’s questions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve module’s questions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/modules/questions&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="p">[</span>
         <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
         <span class="nt">&quot;questions&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
               <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
               <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
               <span class="nt">&quot;createdon&quot;</span><span class="p">:</span> <span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
               <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span> <span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
            <span class="p">}</span>
         <span class="p">]</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="get-modules-answers">
<h2>Get Modules Answers<a class="headerlink" href="#get-modules-answers" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/module/answers</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of answers mapped to each module.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Module or answer id.</p></li>
<li><p><strong>answers</strong> (<em>array</em>) – Array of answers.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module’s answers successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve module’s answers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/modules/answers&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span>
            <span class="nt">&quot;answers&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
               <span class="p">},</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
               <span class="p">}</span>
            <span class="p">]</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/answers</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of answers mapped to a module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Module or answer id.</p></li>
<li><p><strong>answers</strong> (<em>array</em>) – Array of answers.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module’s answers successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve module’s answers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/modules/answers&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span>
            <span class="nt">&quot;answers&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
               <span class="p">},</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
               <span class="p">}</span>
            <span class="p">]</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="add-module">
<h2>Add Module<a class="headerlink" href="#add-module" title="Permalink to this headline"></a></h2>
<span class="target" id="addmodule"></span><dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/module</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Add a new module.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>shortname</strong> (<em>string</em>) – Unique short name or abbreviation of the module.</p></li>
<li><p><strong>fullname</strong> (<em>string</em>) – Full name of the module.</p></li>
<li><p><strong>displayname</strong> (<em>string</em>) – Module display name that can be used by a frontend.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Module description.</p></li>
<li><p><strong>tree</strong> (<em>array</em>) – Array of questions and answers mapped to the module.</p></li>
<li><p><strong>recommendations</strong> (<em>array</em>) – Array of recommendations mapped to a question <code class="docutils literal notranslate"><span class="pre">id</span></code> and answer <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p></li>
<li><p><strong>dependencies</strong> (<em>array</em>) – An array that contains the set of modules that the current module depends on.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module successfully added.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to add module.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <code class="docutils literal notranslate"><span class="pre">client_id</span></code> field is a temporary id for a question or an answer that may not yet exist in the database – This temporary id is assigned by a client. An identical situation exists for <code class="docutils literal notranslate"><span class="pre">client_question_id</span></code> and <code class="docutils literal notranslate"><span class="pre">client_answer_id</span></code>:</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each question can trigger a set of answers or questions (<code class="docutils literal notranslate"><span class="pre">tree</span></code> field).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each module can only be triggered if a module dependency was satisfied (i.e., the module described in the field <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> was previously executed by the user).</p>
</div>
<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="s2">&quot;SRE&quot;</span><span class="p">,</span>
   <span class="nt">&quot;fullname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Elicitation&quot;</span><span class="p">,</span>
   <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements&quot;</span><span class="p">,</span>
   <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Module description&quot;</span><span class="p">,</span>
   <span class="nt">&quot;tree&quot;</span><span class="p">:[</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
         <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
         <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;question&quot;</span><span class="p">,</span>
         <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
         <span class="nt">&quot;multipleAnswers&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
         <span class="nt">&quot;children&quot;</span><span class="p">:[</span>
            <span class="p">{</span>
               <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
               <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
               <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
               <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
               <span class="nt">&quot;multipleAnswers&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
               <span class="nt">&quot;children&quot;</span><span class="p">:[</span>
                  <span class="p">{</span>
                     <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                     <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                     <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Will the sytem have a user LogIn ?&quot;</span><span class="p">,</span>
                     <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;question&quot;</span><span class="p">,</span>
                     <span class="nt">&quot;children&quot;</span><span class="p">:[</span>
                        <span class="p">{</span>
                           <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                           <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                           <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Yes&quot;</span><span class="p">,</span>
                           <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                           <span class="nt">&quot;children&quot;</span><span class="p">:[</span>

                           <span class="p">]</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                           <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                           <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                           <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;No&quot;</span><span class="p">,</span>
                           <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                           <span class="nt">&quot;children&quot;</span><span class="p">:[</span>

                           <span class="p">]</span>
                        <span class="p">}</span>
                     <span class="p">]</span>
                  <span class="p">}</span>
               <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
               <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
               <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
               <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span>
               <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
               <span class="nt">&quot;multipleAnswers&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
               <span class="nt">&quot;children&quot;</span><span class="p">:[</span>
                  <span class="p">{</span>
                     <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                     <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span>
                     <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Yes&quot;</span><span class="p">,</span>
                     <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                     <span class="nt">&quot;children&quot;</span><span class="p">:[</span>

                     <span class="p">]</span>
                  <span class="p">},</span>
                  <span class="p">{</span>
                     <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                     <span class="nt">&quot;client_id&quot;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span>
                     <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;No&quot;</span><span class="p">,</span>
                     <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                     <span class="nt">&quot;children&quot;</span><span class="p">:[</span>

                     <span class="p">]</span>
                  <span class="p">}</span>
               <span class="p">]</span>
            <span class="p">}</span>
         <span class="p">]</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&quot;recommendations&quot;</span><span class="p">:[</span>
      <span class="p">{</span>
         <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
         <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
         <span class="nt">&quot;questions_answers&quot;</span><span class="p">:[</span>
            <span class="p">{</span>
               <span class="nt">&quot;client_question_id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
               <span class="nt">&quot;client_answer_id&quot;</span><span class="p">:</span><span class="mi">1</span>
            <span class="p">}</span>
         <span class="p">]</span>
      <span class="p">}</span>
   <span class="p">],</span>
   <span class="nt">&quot;dependencies&quot;</span><span class="p">:[</span>
      <span class="p">{</span>
         <span class="nt">&quot;module&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="edit-module">
<h2>Edit Module<a class="headerlink" href="#edit-module" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/module</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Edit a module.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module to edit.</p></li>
<li><p><strong>shortname</strong> (<em>string</em>) – Unique short name or abbreviation of the module.</p></li>
<li><p><strong>fullname</strong> (<em>string</em>) – Full name of the module.</p></li>
<li><p><strong>displayname</strong> (<em>string</em>) – Module display name that can be used by a frontend.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – Status code</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module successfully updated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to update module.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
   <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="s2">&quot;SREU&quot;</span><span class="p">,</span>
   <span class="nt">&quot;fullname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Elicitation Updated&quot;</span><span class="p">,</span>
   <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Updated&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Questions, answers, recommendations and dependencies of the module can also be updated using this service by following the same JSON object provide as example in the <code class="docutils literal notranslate"><span class="pre">/api/module</span></code> (add module) service.</p>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/module&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="remove-module">
<h2>Remove Module<a class="headerlink" href="#remove-module" title="Permalink to this headline"></a></h2>
<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Performs a partial delete of a Module. That is, only the module and those sessions linked are deleted - Linked questions and associated answers are not delete.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module to partially delete.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove module.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/full</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Fully removes a module (including sessions, linked questions, and answers).</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module to fully delete.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove module.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/questions</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Removes all questions mapped to the module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module questions successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove module questions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/answers</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Removes all answers mapped to the module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module answers successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove module answers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/logic</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Removes the logic file mapped to the module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Module answers successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove module answers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>
<section id="dependencies-services-api">
<h1>Dependencies Services API<a class="headerlink" href="#dependencies-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the dependency entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>dependency.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">views.module</span> <span class="c1"># SAM&#39;s views</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 33</span><span class="sd">[Summary]: Adds a new dependency to the database.</span>
<span class="linenos"> 34</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 35</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 36</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/dependency&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 37</span><span class="k">def</span> <span class="nf">add_dependency</span><span class="p">(</span><span class="n">json_internal_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 38</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 39</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 40</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 41</span>    
<span class="linenos"> 42</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 43</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 46</span>        <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 47</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 48</span>        <span class="n">json_data</span> <span class="o">=</span> <span class="n">json_internal_data</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 51</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> 
<span class="linenos"> 52</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 53</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
<span class="linenos"> 54</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 55</span>            <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;[POST]/api/dependency&quot;</span><span class="p">,</span> <span class="s2">&quot;json_data is None&quot;</span><span class="p">)</span>
<span class="linenos"> 56</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 57</span>   
<span class="linenos"> 58</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos"> 59</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;module_id&quot;</span><span class="p">,</span> <span class="s2">&quot;depends_on&quot;</span><span class="p">})):</span>
<span class="linenos"> 60</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 61</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos"> 62</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 63</span>            <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;[POST]/api/dependency&quot;</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">)</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span>    <span class="n">module_id</span>   <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>
<span class="linenos"> 66</span>    <span class="n">depends_on</span>  <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;depends_on&#39;</span><span class="p">]</span>
<span class="linenos"> 67</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 68</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 69</span>    
<span class="linenos"> 70</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos"> 71</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">depends_on</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos"> 72</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;moduleID&quot;</span><span class="p">,</span> <span class="s2">&quot;dependsOn&quot;</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos"> 73</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO dependency&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 74</span>    
<span class="linenos"> 75</span>    <span class="c1"># Add</span>
<span class="linenos"> 76</span>    <span class="n">n_id</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 77</span>
<span class="linenos"> 78</span>    <span class="k">if</span> <span class="p">(</span><span class="n">n_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 79</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 80</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
<span class="linenos"> 81</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 82</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 83</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 84</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 85</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">n_id</span><span class="p">}))</span>
<span class="linenos"> 86</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 87</span>            <span class="k">return</span><span class="p">(</span><span class="n">n_id</span><span class="p">)</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 90</span><span class="sd">[Summary]: Updates a dependency.</span>
<span class="linenos"> 91</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 92</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 93</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/dependency&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos"> 94</span><span class="k">def</span> <span class="nf">update_dependency</span><span class="p">(</span><span class="n">json_internal_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 95</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 96</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 97</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 98</span>    
<span class="linenos"> 99</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">100</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">101</span>
<span class="linenos">102</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">103</span>        <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos">104</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">105</span>        <span class="n">json_data</span> <span class="o">=</span> <span class="n">json_internal_data</span>
<span class="linenos">106</span>    
<span class="linenos">107</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">108</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> 
<span class="linenos">109</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">110</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">111</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">112</span>            <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;[PUT]/api/dependency&quot;</span><span class="p">,</span> <span class="s2">&quot;json_data is None&quot;</span><span class="p">)</span>
<span class="linenos">113</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">114</span>
<span class="linenos">115</span>    <span class="n">dependency_id_available</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">116</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos">117</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">})):</span>
<span class="linenos">118</span>        <span class="n">dependency_id_available</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">119</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;module_id&quot;</span><span class="p">,</span> <span class="s2">&quot;depends_on&quot;</span><span class="p">,</span> <span class="s2">&quot;p_depends_on&quot;</span><span class="p">})):</span>
<span class="linenos">120</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos">121</span>        
<span class="linenos">122</span>
<span class="linenos">123</span>    <span class="n">module_id</span>     <span class="o">=</span> <span class="s2">&quot;module_id&quot;</span>     <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">124</span>    <span class="n">depends_on</span>    <span class="o">=</span> <span class="s2">&quot;depends_on&quot;</span>    <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;depends_on&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>     <span class="c1"># New dependency</span>
<span class="linenos">125</span>    <span class="n">p_depends_on</span>  <span class="o">=</span> <span class="s2">&quot;p_depends_on&quot;</span>  <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;p_depends_on&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>   <span class="c1"># Previous dependency</span>
<span class="linenos">126</span>    <span class="n">createdon</span>     <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span>     <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">127</span>    <span class="n">updatedon</span>     <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span>     <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">128</span>
<span class="linenos">129</span>    <span class="c1"># IF required, get the ID of the dependency taking into account the id of the module and the id of the module that it depends on.</span>
<span class="linenos">130</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dependency_id_available</span><span class="p">):</span>
<span class="linenos">131</span>        <span class="n">json_tmp</span> <span class="o">=</span> <span class="n">find_dependency_of_module_2</span><span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">p_depends_on</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">132</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">json_tmp</span><span class="p">):</span>
<span class="linenos">133</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the temporary JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos">134</span>        <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_tmp</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos">135</span>    
<span class="linenos">136</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos">137</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">depends_on</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos">138</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">module_id</span> <span class="ow">and</span> <span class="s2">&quot;moduleID&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">depends_on</span> <span class="ow">and</span> <span class="s2">&quot;dependsOn&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedOn&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">139</span>    <span class="n">where</span>   <span class="o">=</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">140</span>
<span class="linenos">141</span>    <span class="c1"># Check if there is anything to update (i.e. frontend developer has not sent any values to update).</span>
<span class="linenos">142</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">143</span>
<span class="linenos">144</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE dependency&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
<span class="linenos">145</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;[PUT]/api/dependency&quot;</span><span class="p">,</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos">146</span>
<span class="linenos">147</span>    <span class="c1"># Update resource</span>
<span class="linenos">148</span>    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">149</span>
<span class="linenos">150</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">151</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">152</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">153</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">154</span>
<span class="linenos">155</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">156</span><span class="sd">[Summary]: Get dependencies.</span>
<span class="linenos">157</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">158</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">159</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/dependencies&#39;</span><span class="p">)</span>
<span class="linenos">160</span><span class="k">def</span> <span class="nf">get_dependency</span><span class="p">():</span>
<span class="linenos">161</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">162</span>
<span class="linenos">163</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">164</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">165</span>
<span class="linenos">166</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">167</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">168</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">169</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">170</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, moduleID, dependsOn, createdOn, UpdatedOn FROM dependency&quot;</span><span class="p">)</span>
<span class="linenos">171</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">172</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">173</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">174</span>    
<span class="linenos">175</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">176</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">177</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">178</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">179</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">180</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">181</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">182</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">183</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">184</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">185</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">186</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;depends_on&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">187</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">188</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">189</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">190</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">191</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">192</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">193</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">194</span>
<span class="linenos">195</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">196</span><span class="sd">[Summary]: Finds a dependency.</span>
<span class="linenos">197</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">198</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">199</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/dependency/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">200</span><span class="k">def</span> <span class="nf">find_dependency</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
<span class="linenos">201</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">202</span>
<span class="linenos">203</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">204</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">205</span>
<span class="linenos">206</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">207</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">208</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">209</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">210</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, moduleID, dependsOn, createdOn, UpdatedOn FROM dependency WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">211</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">212</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">213</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">214</span>    
<span class="linenos">215</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">216</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">217</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">218</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">219</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">220</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">221</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">222</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">223</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">224</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">225</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">226</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;depends_on&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">227</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">228</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">229</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">230</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">231</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">232</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">233</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">234</span>
<span class="linenos">235</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">236</span><span class="sd">[Summary]: Finds a dependency of a module</span>
<span class="linenos">237</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">238</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">239</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/dependency/module/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">240</span><span class="k">def</span> <span class="nf">find_dependency_of_module</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">241</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">242</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">243</span>
<span class="linenos">244</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">245</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">246</span>
<span class="linenos">247</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">248</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">249</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">250</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">251</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT dependency_id, depends_module_id, createdOn, updatedOn FROM view_module_dependency WHERE module_ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">252</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">253</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">254</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">255</span>    
<span class="linenos">256</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">257</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">258</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">259</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">260</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">261</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span> 
<span class="linenos">262</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">263</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">264</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">265</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">266</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">267</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">268</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>                      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">269</span>            <span class="n">t_module</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">270</span>            <span class="n">module</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">271</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="n">t_module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos">272</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span>              <span class="o">=</span> <span class="n">t_module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span>
<span class="linenos">273</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;displayname&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">t_module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;displayname&#39;</span><span class="p">]</span>
<span class="linenos">274</span>            <span class="n">module</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">t_module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shortname&#39;</span><span class="p">]</span>
<span class="linenos">275</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span>                  <span class="o">=</span> <span class="n">module</span>
<span class="linenos">276</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">277</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">278</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">279</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">280</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">281</span>        
<span class="linenos">282</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">283</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">284</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">285</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">286</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos">287</span>
<span class="linenos">288</span>
<span class="linenos">289</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">290</span><span class="sd">[Summary]: Finds a dependency of a module, taking as arguments the id of the current module and the id of the module that it depends on.</span>
<span class="linenos">291</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">292</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">293</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/dependency/module/&lt;module_id&gt;/depends/&lt;depends_on_module_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">294</span><span class="k">def</span> <span class="nf">find_dependency_of_module_2</span><span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">depends_on_module_id</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">295</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">296</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">297</span>
<span class="linenos">298</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">299</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">300</span>
<span class="linenos">301</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">302</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">303</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">304</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">305</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;SELECT dependency_id, module_id, depends_module_id, createdOn, updatedOn FROM view_module_dependency WHERE module_ID=</span><span class="si">%s</span><span class="s2"> AND depends_module_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">depends_on_module_id</span><span class="p">))</span>
<span class="linenos">306</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT dependency_id, module_id, depends_module_id, createdOn, updatedOn FROM view_module_dependency WHERE module_ID=</span><span class="si">%s</span><span class="s2"> AND depends_module_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">depends_on_module_id</span><span class="p">))</span>
<span class="linenos">307</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">308</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">309</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">310</span>    
<span class="linenos">311</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">312</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">313</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">314</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">315</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">316</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span> 
<span class="linenos">317</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">318</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos">319</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">320</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">321</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">322</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>                      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">323</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">324</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;depends_on_module_id&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">325</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">326</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">327</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">328</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">329</span>        
<span class="linenos">330</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">331</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">332</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> 
<span class="linenos">333</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">334</span>            <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">335</span>
<span class="linenos">336</span>
<span class="linenos">337</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">338</span><span class="sd">[Summary]: Delete a dependency by id.</span>
<span class="linenos">339</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">340</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">341</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/dependency/&lt;dependency_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos">342</span><span class="k">def</span> <span class="nf">delete_dependency</span><span class="p">(</span><span class="n">dependency_id</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">343</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">344</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">345</span>
<span class="linenos">346</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">347</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">348</span>
<span class="linenos">349</span>    <span class="c1"># Connect to the database and delete the resource</span>
<span class="linenos">350</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">351</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">352</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">353</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM dependency WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dependency_id</span><span class="p">)</span>
<span class="linenos">354</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">355</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">356</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">357</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">358</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">359</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">360</span>
<span class="linenos">361</span>    <span class="c1"># The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">362</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">363</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">364</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">365</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</details><section id="get-dependencies">
<h2>Get Dependencies<a class="headerlink" href="#get-dependencies" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/dependencies</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get dependencies of a <code class="docutils literal notranslate"><span class="pre">module</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the dependency.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module.</p></li>
<li><p><strong>depends_on</strong> (<em>int</em>) – Id of the module that the <code class="docutils literal notranslate"><span class="pre">module_id</span></code> depends on.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Dependencies successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve dependencies.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/dependencies&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;depends_on&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:00:50 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:00:50 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">depends_on</span></code> parameter describes the id of the module that the current <code class="docutils literal notranslate"><span class="pre">module_id</span></code> depends on.</p>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/dependency/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get dependency identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the dependency.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the dependency.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module.</p></li>
<li><p><strong>depends_on</strong> (<em>int</em>) – Id of the module that the <code class="docutils literal notranslate"><span class="pre">module_id</span></code> depends on.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Dependency successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve dependency.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/dependency/1&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;depends_on&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:00:50 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:00:50 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">depends_on</span></code> parameter describes the id of the module that the current <code class="docutils literal notranslate"><span class="pre">module_id</span></code> depends on.</p>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/dependency/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get dependencies of a module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the dependency and dependecy module.</p></li>
<li><p><strong>module</strong> (<em>object</em>) – Information of the module that module <code class="docutils literal notranslate"><span class="pre">id</span></code> depends on.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Dependencies successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve dependencies.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/dependency/module/2&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;module&quot;</span><span class="p">:{</span>
               <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
               <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="s2">&quot;SRE&quot;</span><span class="p">,</span>
               <span class="nt">&quot;fullname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Elicitation&quot;</span><span class="p">,</span>
               <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Wed, 17 Nov 2021 14:14:26 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Wed, 17 Nov 2021 14:14:26 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/dependency/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/depends/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get dependency information of a module <code class="docutils literal notranslate"><span class="pre">id</span></code> that depends on module <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module or id of the module it depends on.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the dependency.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module.</p></li>
<li><p><strong>depends_on_module_id</strong> (<em>int</em>) – Id of the module that the <code class="docutils literal notranslate"><span class="pre">module_id</span></code> depends on.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Dependency successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve dependency.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/dependency/module/2/depends/1&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
      <span class="nt">&quot;depends_on_module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:00:50 GMT&quot;</span><span class="p">,</span>
      <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:00:50 GMT&quot;</span><span class="p">,</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="add-dependency">
<h2>Add Dependency<a class="headerlink" href="#add-dependency" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/dependency</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Add a new dependency.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the dependency.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module.</p></li>
<li><p><strong>depends_on</strong> (<em>int</em>) – Id of the module that the <code class="docutils literal notranslate"><span class="pre">module_id</span></code> depends on.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of new dependency.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Dependency successfully added.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to add dependency.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;depends_on&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/dependency&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="edit-dependency">
<h2>Edit Dependency<a class="headerlink" href="#edit-dependency" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/dependency</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Updated a dependency identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the dependency.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module.</p></li>
<li><p><strong>depends_on</strong> (<em>int</em>) – Id of the module that the <code class="docutils literal notranslate"><span class="pre">module_id</span></code> depends on.</p></li>
<li><p><strong>depends_on_p</strong> (<em>int</em>) – Id of the module that the <code class="docutils literal notranslate"><span class="pre">module_id</span></code> previously depended on.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of new dependency.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Dependency successfully updated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to updated dependency.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;depends_on&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="nt">&quot;p_depends_on&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/dependency&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="remove-dependency">
<h2>Remove Dependency<a class="headerlink" href="#remove-dependency" title="Permalink to this headline"></a></h2>
<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/dependency/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Remove a dependency identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Form Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of dependency to remove.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Dependency successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove dependency.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/dependency&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
</section>
<section id="questions-services-api">
<h1>Questions Services API<a class="headerlink" href="#questions-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the question entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>question.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">views.answer</span><span class="o">,</span> <span class="nn">views.module</span> <span class="c1"># SAM&#39;s views</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 33</span><span class="sd">[Summary]: Adds a new question to the database.</span>
<span class="linenos"> 34</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 35</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 36</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/question&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 37</span><span class="k">def</span> <span class="nf">add_question</span><span class="p">():</span>
<span class="linenos"> 38</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 39</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 40</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 41</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 44</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 45</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos"> 48</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">})):</span>
<span class="linenos"> 49</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos"> 50</span>
<span class="linenos"> 51</span>    <span class="n">content</span>     <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
<span class="linenos"> 52</span>    <span class="n">description</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
<span class="linenos"> 53</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 54</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 55</span>    
<span class="linenos"> 56</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos"> 57</span>    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos"> 58</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO question&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 59</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [POST]/api/question - &quot;</span> <span class="o">+</span> <span class="n">sql</span><span class="p">)</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span>    <span class="c1"># Add</span>
<span class="linenos"> 62</span>    <span class="n">n_id</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 63</span>    <span class="k">if</span> <span class="p">(</span><span class="n">n_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 64</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>  
<span class="linenos"> 65</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 66</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">n_id</span><span class="p">}))</span>  
<span class="linenos"> 67</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 70</span><span class="sd">[Summary]: Delete a question</span>
<span class="linenos"> 71</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos"> 72</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 73</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/question/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos"> 74</span><span class="k">def</span> <span class="nf">delete_question</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 75</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 76</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 77</span>    
<span class="linenos"> 78</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos"> 79</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span>    <span class="c1"># 2. Connect to the database and delete the resource</span>
<span class="linenos"> 82</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 83</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 84</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 85</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM question WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos"> 86</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos"> 87</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 88</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos"> 89</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos"> 90</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 91</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span>    <span class="c1"># 3. The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos"> 94</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 95</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos"> 96</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 97</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">100</span><span class="sd">[Summary]: Updates a question.</span>
<span class="linenos">101</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">102</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">103</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/question&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos">104</span><span class="k">def</span> <span class="nf">update_question</span><span class="p">():</span>
<span class="linenos">105</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">106</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">107</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">108</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">109</span>
<span class="linenos">110</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos">111</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">112</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">113</span>
<span class="linenos">114</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos">115</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">})):</span>
<span class="linenos">116</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos">117</span>
<span class="linenos">118</span>    <span class="n">content</span>     <span class="o">=</span> <span class="s2">&quot;content&quot;</span>     <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">119</span>    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">120</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">121</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">122</span>
<span class="linenos">123</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">124</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">125</span>
<span class="linenos">126</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos">127</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos">128</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">content</span> <span class="ow">and</span> <span class="s2">&quot;content&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">description</span> <span class="ow">and</span> <span class="s2">&quot;description&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedOn&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">129</span>    <span class="n">where</span>   <span class="o">=</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">130</span>    <span class="c1"># Check if there is anything to update (i.e. frontend developer has not sent any values to update).</span>
<span class="linenos">131</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">132</span>
<span class="linenos">133</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE question&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
<span class="linenos">134</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [PUT]/api/question - &quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos">135</span>
<span class="linenos">136</span>    <span class="c1"># Update Recommendation</span>
<span class="linenos">137</span>    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">138</span>
<span class="linenos">139</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">140</span>
<span class="linenos">141</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">142</span><span class="sd">[Summary]: Get Questions.</span>
<span class="linenos">143</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">144</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">145</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/questions&#39;</span><span class="p">)</span>
<span class="linenos">146</span><span class="k">def</span> <span class="nf">get_questions</span><span class="p">():</span>
<span class="linenos">147</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">148</span>
<span class="linenos">149</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">150</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">151</span>
<span class="linenos">152</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">153</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">154</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">155</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">156</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, content, description, createdOn, updatedOn FROM question&quot;</span><span class="p">)</span>
<span class="linenos">157</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">158</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">159</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">160</span>    
<span class="linenos">161</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">162</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">163</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">164</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">165</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">166</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">167</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">168</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">169</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">170</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">171</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">172</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">173</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="s1">&#39;question&#39;</span>
<span class="linenos">174</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_modules_of_question</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">175</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">176</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">177</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">178</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">179</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">180</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">181</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">182</span>
<span class="linenos">183</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">184</span><span class="sd">[Summary]: Finds the list of modules linked to a question</span>
<span class="linenos">185</span><span class="sd">[Returns]: A list of modules or an empty array if None are found.</span>
<span class="linenos">186</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">187</span><span class="k">def</span> <span class="nf">find_modules_of_question</span><span class="p">(</span><span class="n">question_id</span><span class="p">):</span>
<span class="linenos">188</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">189</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">190</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">191</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT module_id FROM view_module_question WHERE question_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">question_id</span><span class="p">)</span>
<span class="linenos">192</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">193</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">194</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">195</span>    
<span class="linenos">196</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">197</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">198</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">199</span>        <span class="c1"># Check if this question is a child of another question, triggered by an answer, were the parent belongs to a module.</span>
<span class="linenos">200</span>        <span class="c1"># We need to do this because sub-questions, triggered by an answer, are not directly linked to a module. </span>
<span class="linenos">201</span>        <span class="c1"># In order to find the module that the sub-question belongs, we need to find its parent.</span>
<span class="linenos">202</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">203</span>            <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">204</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">205</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT parent FROM question_has_child WHERE child=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">question_id</span><span class="p">)</span>
<span class="linenos">206</span>            <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">207</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">208</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">209</span>        
<span class="linenos">210</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">211</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">212</span>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">213</span>            <span class="k">return</span><span class="p">([])</span> 
<span class="linenos">214</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">215</span>            <span class="n">l_modules</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">216</span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">217</span>                <span class="n">modules</span> <span class="o">=</span> <span class="n">find_modules_of_question</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">218</span>                <span class="n">l_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
<span class="linenos">219</span>            <span class="c1">#</span>
<span class="linenos">220</span>            <span class="n">f_list_modules</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">221</span>            <span class="k">for</span> <span class="n">modules</span> <span class="ow">in</span> <span class="n">l_modules</span><span class="p">:</span>
<span class="linenos">222</span>                <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
<span class="linenos">223</span>                    <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f_list_modules</span><span class="p">:</span>
<span class="linenos">224</span>                        <span class="n">f_list_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos">225</span>            <span class="k">return</span><span class="p">(</span><span class="n">f_list_modules</span><span class="p">)</span>
<span class="linenos">226</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">227</span>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">228</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">229</span>        <span class="n">modules</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">230</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">231</span>            <span class="n">module</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">232</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>
<span class="linenos">233</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>
<span class="linenos">234</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span>
<span class="linenos">235</span>            <span class="n">modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos">236</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">237</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">238</span>       
<span class="linenos">239</span>        <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">240</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="p">)</span>
<span class="linenos">241</span>
<span class="linenos">242</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">243</span><span class="sd">[Summary]: Finds Question.</span>
<span class="linenos">244</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">245</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">246</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/question/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">247</span><span class="k">def</span> <span class="nf">find_question</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">248</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">249</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">250</span>
<span class="linenos">251</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">252</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">253</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">254</span>
<span class="linenos">255</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">256</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">257</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">258</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">259</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID as question_id, content, description, createdOn, updatedOn FROM question WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">260</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">261</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">262</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">263</span>    
<span class="linenos">264</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">265</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">266</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">267</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">268</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">269</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">270</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">271</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">272</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">273</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">274</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">275</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="s1">&#39;question&#39;</span>
<span class="linenos">276</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">277</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">278</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">279</span>        
<span class="linenos">280</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">281</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">282</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">283</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">284</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos">285</span>
<span class="linenos">286</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">287</span><span class="sd">[Summary]: Finds Answers of a Question by question ID ans answerID- [Question_Answer] Table.</span>
<span class="linenos">288</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">289</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">290</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/question/&lt;question_id&gt;/answer/&lt;answer_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">291</span><span class="k">def</span> <span class="nf">find_question_answers_2</span><span class="p">(</span><span class="n">question_id</span><span class="p">,</span> <span class="n">answer_id</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">292</span>    <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="k">return</span>
<span class="linenos">293</span>
<span class="linenos">294</span>    
<span class="linenos">295</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">296</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">297</span>
<span class="linenos">298</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">299</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">300</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">301</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">302</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT question_answer_id, question_id, question, answer_id, answer FROM view_question_answer where question_id=</span><span class="si">%s</span><span class="s2"> and answer_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">question_id</span><span class="p">,</span> <span class="n">answer_id</span><span class="p">))</span>
<span class="linenos">303</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">304</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">305</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">306</span>    
<span class="linenos">307</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">308</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">309</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">310</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">311</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">312</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">313</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">314</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">315</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">316</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">317</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">318</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">319</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_answer_id&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">320</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">321</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_content&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">322</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">323</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;answer_content&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">324</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">325</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">326</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">327</span>        
<span class="linenos">328</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">329</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">330</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
<span class="linenos">331</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">332</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos">333</span>
<span class="linenos">334</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">335</span><span class="sd">[Summary]: Finds Answers of a Question - [Question_Answer] Table.</span>
<span class="linenos">336</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">337</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">338</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/question/&lt;ID&gt;/answers&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">339</span><span class="k">def</span> <span class="nf">find_question_answers</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
<span class="linenos">340</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">341</span>
<span class="linenos">342</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">343</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">344</span>
<span class="linenos">345</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">346</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">347</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">348</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">349</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT question_answer_id, question_id, question, answer_id, answer FROM view_question_answer where question_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">350</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">351</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">352</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">353</span>    
<span class="linenos">354</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">355</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">356</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">357</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">358</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">359</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">360</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">361</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">362</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">363</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_answer_id&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">364</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">365</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_content&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">366</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">367</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;answer_content&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">368</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">369</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">370</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">371</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">372</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos">373</span>
<span class="linenos">374</span>
<span class="linenos">375</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">376</span><span class="sd">[Summary]: Gets Answers of a Questions - [Question_Answer] Table.</span>
<span class="linenos">377</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">378</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">379</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/questions/answers&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">380</span><span class="k">def</span> <span class="nf">get_questions_answers</span><span class="p">():</span>
<span class="linenos">381</span>   
<span class="linenos">382</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">383</span>
<span class="linenos">384</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">385</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">386</span>
<span class="linenos">387</span>    <span class="c1"># 2. Let&#39;s get the questions from the database </span>
<span class="linenos">388</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">389</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">390</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">391</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT question_answer_id, question_id, question, answer_id, answer FROM view_question_answer&quot;</span><span class="p">)</span>
<span class="linenos">392</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">393</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">394</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">395</span>    
<span class="linenos">396</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">397</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">398</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">399</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">400</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">401</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">402</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">403</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">404</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">405</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_answer_id&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">406</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">407</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;question_content&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">408</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">409</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;answer_content&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">410</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">411</span>    
<span class="linenos">412</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">413</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">414</span>    <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">415</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
</pre></div>
</div>
</details><section id="get-questions">
<h2>Get Questions<a class="headerlink" href="#get-questions" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/questions</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get all questions.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the current question.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The question.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Question description.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Questions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve questions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/questions&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the name of ... ?&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test question description&quot;</span><span class="p">,</span>
            <span class="nt">&quot;modules&quot;</span><span class="p">:[],</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sun, 20 Sep 2020 09:00:00 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sun, 20 Sep 2020 09:00:00 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/question/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get a question identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – id of the question.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the question.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The question.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Question successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve question.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/question/1&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="get-questions-answers">
<h2>Get Questions Answers<a class="headerlink" href="#get-questions-answers" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/questions/answers</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of answers mapped to questions</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>question_id</strong> (<em>int</em>) – The id of the question.</p></li>
<li><p><strong>question_content</strong> (<em>string</em>) – The question content.</p></li>
<li><p><strong>answer_id</strong> (<em>int</em>) – The id of que answer mapped to that question.</p></li>
<li><p><strong>answer_content</strong> (<em>string</em>) – The answer content.</p></li>
<li><p><strong>question_answer_id</strong> – The relation id between question and answer.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Questions answers successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve questions answers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/questions/answers&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span>
            <span class="nt">&quot;question_content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
            <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;answer_content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
            <span class="nt">&quot;question_answer_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
         <span class="p">},</span>
         <span class="p">{</span>
            <span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span>
            <span class="nt">&quot;question_content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
            <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;answer_content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span>
            <span class="nt">&quot;question_answer_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/question/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/answers</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of answers mapped to question identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – id of the question.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>question_id</strong> (<em>int</em>) – The id of the question.</p></li>
<li><p><strong>question_content</strong> (<em>string</em>) – The question content.</p></li>
<li><p><strong>answer_id</strong> (<em>int</em>) – The id of que answer mapped to that question.</p></li>
<li><p><strong>answer_content</strong> (<em>string</em>) – The answer content.</p></li>
<li><p><strong>question_answer_id</strong> – The relation id between question and answer.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Question answers successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve question answers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/question/1/answers&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;question_content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
            <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;answer_content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
            <span class="nt">&quot;question_answer_id&quot;</span><span class="p">:</span><span class="mi">1</span>
         <span class="p">},</span>
         <span class="p">{</span>
            <span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;question_content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
            <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;answer_content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span>
            <span class="nt">&quot;question_answer_id&quot;</span><span class="p">:</span><span class="mi">2</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="add-question">
<h2>Add Question<a class="headerlink" href="#add-question" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/question</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Add a new question.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>content</strong> (<em>string</em>) – The question content.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – The question description.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the new question.</p></li>
<li><p><strong>status</strong> (<em>string</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Question successfully added.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to add question.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Test Question&quot;</span><span class="p">,</span>
   <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test question description&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/question&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="edit-question">
<h2>Edit Question<a class="headerlink" href="#edit-question" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/question</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Update a question identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the question to update.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The question content.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – The question description.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>string</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Question successfully updated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to update question.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
   <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Test Question Updated&quot;</span><span class="p">,</span>
   <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test question description updated&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/question&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="remove-question">
<h2>Remove Question<a class="headerlink" href="#remove-question" title="Permalink to this headline"></a></h2>
<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/question/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Removes a question identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the question to remove.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>string</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Question successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove question.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/question&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
</section>
<section id="answers-services-api">
<h1>Answers Services API<a class="headerlink" href="#answers-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the answer entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>answer.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">views.question</span> <span class="c1"># SAM&#39;s views</span>
<span class="linenos"> 31</span>
<span class="linenos"> 32</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 33</span><span class="sd">[Summary]: Adds a new question to the database.</span>
<span class="linenos"> 34</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 35</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 36</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/answer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 37</span><span class="k">def</span> <span class="nf">add_answer</span><span class="p">():</span>
<span class="linenos"> 38</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos"> 39</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 40</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 41</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 42</span>
<span class="linenos"> 43</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 44</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 45</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos"> 48</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">})):</span>
<span class="linenos"> 49</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos"> 50</span>
<span class="linenos"> 51</span>    <span class="n">content</span>     <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
<span class="linenos"> 52</span>    <span class="n">description</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
<span class="linenos"> 53</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 54</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 55</span>    
<span class="linenos"> 56</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos"> 57</span>    <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos"> 58</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO answer&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 59</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [POST]/api/answer - &quot;</span> <span class="o">+</span> <span class="n">sql</span><span class="p">)</span>
<span class="linenos"> 60</span>
<span class="linenos"> 61</span>    <span class="c1"># Add</span>
<span class="linenos"> 62</span>    <span class="n">n_id</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 63</span>    <span class="k">if</span> <span class="p">(</span><span class="n">n_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 64</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>  
<span class="linenos"> 65</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 66</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">n_id</span><span class="p">}))</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span>
<span class="linenos"> 69</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 70</span><span class="sd">[Summary]: Delete an answer.</span>
<span class="linenos"> 71</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos"> 72</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 73</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/answer/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos"> 74</span><span class="k">def</span> <span class="nf">delete_answer</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 75</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 76</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 77</span>    
<span class="linenos"> 78</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos"> 79</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 80</span>
<span class="linenos"> 81</span>    <span class="c1"># 2. Connect to the database and delete the resource</span>
<span class="linenos"> 82</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 83</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 84</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 85</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM answer WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos"> 86</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos"> 87</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 88</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos"> 89</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos"> 90</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 91</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 92</span>
<span class="linenos"> 93</span>    <span class="c1"># 3. The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos"> 94</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos"> 95</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos"> 96</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 97</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 98</span>
<span class="linenos"> 99</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">100</span><span class="sd">[Summary]: Updates a question.</span>
<span class="linenos">101</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">102</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">103</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/answer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos">104</span><span class="k">def</span> <span class="nf">update_answer</span><span class="p">():</span>
<span class="linenos">105</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">True</span>
<span class="linenos">106</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">107</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">108</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">109</span>
<span class="linenos">110</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos">111</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">112</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">113</span>
<span class="linenos">114</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos">115</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">})):</span>
<span class="linenos">116</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos">117</span>
<span class="linenos">118</span>    <span class="n">content</span>     <span class="o">=</span> <span class="s2">&quot;content&quot;</span>     <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">119</span>    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">120</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">121</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">122</span>
<span class="linenos">123</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">124</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">125</span>
<span class="linenos">126</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos">127</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos">128</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">content</span> <span class="ow">and</span> <span class="s2">&quot;content&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">description</span> <span class="ow">and</span> <span class="s2">&quot;description&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedOn&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">129</span>    <span class="n">where</span>   <span class="o">=</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">130</span>    <span class="c1"># Check if there is anything to update (i.e. frontend developer has not sent any values to update).</span>
<span class="linenos">131</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">132</span>
<span class="linenos">133</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE answer&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
<span class="linenos">134</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [PUT]/api/answer - &quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos">135</span>
<span class="linenos">136</span>    <span class="c1"># Update Recommendation</span>
<span class="linenos">137</span>    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">138</span>
<span class="linenos">139</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">140</span>
<span class="linenos">141</span>
<span class="linenos">142</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">143</span><span class="sd">[Summary]: Get Answers.</span>
<span class="linenos">144</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">145</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">146</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/answers&#39;</span><span class="p">)</span>
<span class="linenos">147</span><span class="k">def</span> <span class="nf">get_answers</span><span class="p">():</span>
<span class="linenos">148</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">149</span>
<span class="linenos">150</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">151</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">152</span>
<span class="linenos">153</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">154</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">155</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">156</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">157</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, content, description, createdon, updatedon FROM answer&quot;</span><span class="p">)</span>
<span class="linenos">158</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">159</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">160</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">161</span>    
<span class="linenos">162</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">163</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">164</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">165</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">166</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">167</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">168</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">169</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">170</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">171</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">172</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">173</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">174</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">find_questions_of_answer</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos">175</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">176</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">177</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">178</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">179</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">180</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">181</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
<span class="linenos">182</span>
<span class="linenos">183</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">184</span><span class="sd">[Summary]: Finds the list of questions linked to an answer.</span>
<span class="linenos">185</span><span class="sd">[Returns]: A list of questions or an empty array if None are found.</span>
<span class="linenos">186</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">187</span><span class="k">def</span> <span class="nf">find_questions_of_answer</span><span class="p">(</span><span class="n">answer_id</span><span class="p">):</span>
<span class="linenos">188</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">189</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">190</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">191</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT questionID FROM question_answer WHERE answerID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">answer_id</span><span class="p">)</span>
<span class="linenos">192</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">193</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">194</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">195</span>    
<span class="linenos">196</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">197</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">198</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">199</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">200</span>        <span class="k">return</span><span class="p">([])</span> 
<span class="linenos">201</span>       
<span class="linenos">202</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">203</span>        <span class="n">questions</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">204</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">205</span>            <span class="n">question</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">find_question</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">206</span>            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="linenos">207</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">208</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">209</span>       
<span class="linenos">210</span>        <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">211</span>        <span class="k">return</span><span class="p">(</span><span class="n">questions</span><span class="p">)</span>
<span class="linenos">212</span>
<span class="linenos">213</span>
<span class="linenos">214</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">215</span><span class="sd">[Summary]: Finds Answer.</span>
<span class="linenos">216</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">217</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">218</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/answer/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">219</span><span class="k">def</span> <span class="nf">find_answer</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">220</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">221</span>
<span class="linenos">222</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">223</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">224</span>
<span class="linenos">225</span>    <span class="c1"># 2. Let&#39;s get the answeers for the question from the database.</span>
<span class="linenos">226</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">227</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">228</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">229</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, content, description, createdon, updatedon FROM answer WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">230</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">231</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">232</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">233</span>    
<span class="linenos">234</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">235</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">236</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">237</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">238</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">239</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">240</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">241</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">242</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">243</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">244</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">245</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">246</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">247</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">248</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">249</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">250</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">251</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">252</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
</pre></div>
</div>
</details><section id="get-answers">
<h2>Get Answers<a class="headerlink" href="#get-answers" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/answers</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get the list of answers mapped to questions.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the answer or question mapped to the current answer.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The answer or question content.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Description of the answer.</p></li>
<li><p><strong>questions</strong> (<em>array</em>) – Array of questions mapped to the current answer.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Answers successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve answers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/answers&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home description&quot;</span><span class="p">,</span>
            <span class="nt">&quot;questions&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
         <span class="p">},</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Smart healthcare description&quot;</span><span class="p">,</span>
            <span class="nt">&quot;questions&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/answers/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get an answer identify by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the answer.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The answer content.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Description of the answer.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Answers successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve answers.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/answer/1&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home description&quot;</span><span class="p">,</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="add-answer">
<h2>Add Answer<a class="headerlink" href="#add-answer" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/answer</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Add a new answer.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>content</strong> (<em>string</em>) – The answer content.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – The answer description.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the new answer.</p></li>
<li><p><strong>status</strong> (<em>string</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Answer successfully added.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to add answer.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Test Answer&quot;</span><span class="p">,</span>
        <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test answer description&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/answer&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="edit-answer">
<h2>Edit Answer<a class="headerlink" href="#edit-answer" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/answer</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Update an answer identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the answer to update.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The answer content.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – The answer description.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>string</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Answer successfully updated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to update answer.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
   <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Test Answer Updated&quot;</span><span class="p">,</span>
   <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Test answer description updated&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/answer&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="remove-answer">
<h2>Remove Answer<a class="headerlink" href="#remove-answer" title="Permalink to this headline"></a></h2>
<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/answer/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Removes a answer identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the answer to remove.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>string</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Answer successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to answer question.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/answer&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
</section>
<section id="recommendations-services-api">
<h1>Recommendations Services API<a class="headerlink" href="#recommendations-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the recommendation entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>recommendation.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 29</span><span class="kn">import</span> <span class="nn">os</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 31</span><span class="kn">import</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">views.module</span> <span class="c1"># SAM&#39;s views</span>
<span class="linenos"> 32</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 35</span><span class="sd">[Summary]: Adds a new recommendation to the database.</span>
<span class="linenos"> 36</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 37</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 38</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 39</span><span class="k">def</span> <span class="nf">add_recommendation</span><span class="p">(</span><span class="n">internal_json</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 40</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos"> 41</span>    <span class="k">if</span> <span class="p">(</span><span class="n">internal_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 42</span>        <span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">):</span> <span class="k">return</span>
<span class="linenos"> 43</span>    
<span class="linenos"> 44</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos"> 45</span>    <span class="k">if</span> <span class="p">(</span><span class="n">internal_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 46</span>   
<span class="linenos"> 47</span>    <span class="k">if</span> <span class="p">(</span><span class="n">internal_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 48</span>        <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos"> 49</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 50</span>        <span class="n">json_data</span> <span class="o">=</span> <span class="n">internal_json</span>
<span class="linenos"> 51</span>
<span class="linenos"> 52</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos"> 53</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> 
<span class="linenos"> 54</span>        <span class="k">if</span> <span class="p">(</span><span class="n">internal_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 55</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos"> 56</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 57</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos"> 58</span>    
<span class="linenos"> 59</span>    <span class="c1"># Validate if the necessary data is on the provided JSON</span>
<span class="linenos"> 60</span>    <span class="c1"># Check if the recommendation [id] is null. If not null, it means the recommendation was previsoulyed added and we just need to add the question_answers mapping to table [recommendation_question_answer].</span>
<span class="linenos"> 61</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 62</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;content&quot;</span><span class="p">})):</span>
<span class="linenos"> 63</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos"> 64</span>        
<span class="linenos"> 65</span>        <span class="n">content</span>         <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>
<span class="linenos"> 66</span>        <span class="n">description</span>     <span class="o">=</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>     <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 67</span>        <span class="n">guide</span>           <span class="o">=</span> <span class="s2">&quot;guide&quot;</span>     <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;guide&#39;</span><span class="p">]</span>     <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 68</span>        <span class="n">createdon</span>       <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 69</span>        <span class="n">updatedon</span>       <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos"> 70</span>    
<span class="linenos"> 71</span>        <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos"> 72</span>        <span class="n">values</span> <span class="o">=</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos"> 73</span>        <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO recommendation&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">description</span> <span class="ow">and</span> <span class="s2">&quot;description&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">guide</span> <span class="ow">and</span> <span class="s2">&quot;guidefilename&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">],</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 74</span>        <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [POST]/recomendation - &quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>        <span class="c1"># Add</span>
<span class="linenos"> 77</span>        <span class="n">recommendation_id</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos"> 78</span>        <span class="k">if</span> <span class="p">(</span><span class="n">recommendation_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> 
<span class="linenos"> 79</span>            <span class="k">if</span> <span class="p">(</span><span class="n">internal_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 80</span>                <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>  
<span class="linenos"> 81</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 82</span>                <span class="k">return</span><span class="p">(</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
<span class="linenos"> 83</span>        
<span class="linenos"> 84</span>        <span class="c1"># If availabe, set the final guide filename after knowing the database id of the new recommendation</span>
<span class="linenos"> 85</span>        <span class="k">if</span> <span class="n">guide</span> <span class="ow">and</span> <span class="n">recommendation_id</span><span class="p">:</span>
<span class="linenos"> 86</span>            <span class="c1"># Get the file extension of the guide uploaded (it can be txt or md) in order to create the final name of the file.</span>
<span class="linenos"> 87</span>            <span class="n">file_extension</span> <span class="o">=</span> <span class="n">guide</span><span class="p">[</span><span class="n">guide</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span> <span class="nb">len</span><span class="p">(</span><span class="n">guide</span><span class="p">)]</span>
<span class="linenos"> 88</span>            <span class="n">final_recommendation_filename</span> <span class="o">=</span> <span class="s2">&quot;recommendation_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">recommendation_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">file_extension</span>
<span class="linenos"> 89</span>            <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE recommendation&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;guideFileName&quot;</span><span class="p">],</span> <span class="n">final_recommendation_filename</span><span class="p">,</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">recommendation_id</span><span class="p">))</span>
<span class="linenos"> 90</span>            <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos"> 91</span>        
<span class="linenos"> 92</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 93</span>        <span class="n">recommendation_id</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos"> 94</span> 
<span class="linenos"> 95</span>
<span class="linenos"> 96</span>
<span class="linenos"> 97</span>    <span class="c1"># This recommendation is given if a question answer association is defined.</span>
<span class="linenos"> 98</span>    <span class="c1"># question_answer_id is a column in table &quot;Recommendation_Question_Answer&quot;</span>
<span class="linenos"> 99</span>    <span class="n">questions_answers</span> <span class="o">=</span> <span class="s2">&quot;questions_answers&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;questions_answers&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">100</span>    <span class="k">if</span> <span class="p">(</span><span class="n">questions_answers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> 
<span class="linenos">101</span>        <span class="k">if</span> <span class="p">(</span><span class="n">internal_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">102</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">recommendation_id</span><span class="p">}))</span>   
<span class="linenos">103</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">104</span>            <span class="k">return</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">recommendation_id</span><span class="p">})</span>
<span class="linenos">105</span>    
<span class="linenos">106</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos">107</span>    <span class="k">for</span> <span class="n">question_answer</span> <span class="ow">in</span> <span class="n">questions_answers</span><span class="p">:</span> 
<span class="linenos">108</span>        <span class="n">question_answer_id</span> <span class="o">=</span> <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos">109</span>        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;recommendationID&quot;</span><span class="p">,</span> <span class="s2">&quot;questionAnswerID&quot;</span><span class="p">]</span> 
<span class="linenos">110</span>        <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">recommendation_id</span><span class="p">,</span> <span class="n">question_answer_id</span><span class="p">)</span>
<span class="linenos">111</span>        <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;INSERT INTO recommendation_question_answer&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">112</span>        <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [POST]/recomendation - &quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos">113</span>        <span class="c1"># Add</span>
<span class="linenos">114</span>        <span class="n">rqa_id</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">115</span>
<span class="linenos">116</span>    <span class="k">if</span> <span class="p">(</span><span class="n">rqa_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">117</span>        <span class="k">if</span> <span class="p">(</span><span class="n">internal_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">118</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
<span class="linenos">119</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">120</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">121</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">122</span>        <span class="k">if</span> <span class="p">(</span><span class="n">internal_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">123</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">recommendation_id</span><span class="p">}))</span>   
<span class="linenos">124</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">125</span>            <span class="k">return</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">recommendation_id</span><span class="p">})</span>
<span class="linenos">126</span>
<span class="linenos">127</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">128</span><span class="sd">[Summary]: Delete a recommendation.</span>
<span class="linenos">129</span><span class="sd">[Returns]: Returns a success or error response</span>
<span class="linenos">130</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">131</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendation/&lt;recommendation_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos">132</span><span class="k">def</span> <span class="nf">delete_recommendation</span><span class="p">(</span><span class="n">recommendation_id</span><span class="p">):</span>
<span class="linenos">133</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">134</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">135</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">136</span>    
<span class="linenos">137</span>    <span class="c1"># 2. If any, get the filename of the guide linked to the recommendation.</span>
<span class="linenos">138</span>    <span class="n">recommendation_guide</span> <span class="o">=</span> <span class="n">find_recommendation</span><span class="p">(</span><span class="n">recommendation_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;guide&#39;</span><span class="p">]</span>
<span class="linenos">139</span>
<span class="linenos">140</span>    <span class="c1"># 3. Connect to the database and delete the resource</span>
<span class="linenos">141</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">142</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">143</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">144</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM recommendation WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">recommendation_id</span><span class="p">)</span>
<span class="linenos">145</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">146</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">147</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">148</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">149</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">150</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">151</span>        <span class="c1"># 3.1. If guide available, remove the file from the server.</span>
<span class="linenos">152</span>        <span class="k">if</span> <span class="p">(</span><span class="n">recommendation_guide</span><span class="p">):</span> 
<span class="linenos">153</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">154</span>                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">UPLOAD_DIRECTORY</span><span class="p">,</span> <span class="n">recommendation_guide</span><span class="p">))</span>
<span class="linenos">155</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">156</span>                <span class="k">pass</span> <span class="c1"># For some reason, the file may not exist.</span>
<span class="linenos">157</span>
<span class="linenos">158</span>    <span class="c1"># 4. The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">159</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">160</span>
<span class="linenos">161</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">162</span><span class="sd">[Summary]: Updates a recommendation</span>
<span class="linenos">163</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">164</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">165</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendation&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos">166</span><span class="k">def</span> <span class="nf">update_recommendation</span><span class="p">():</span>
<span class="linenos">167</span>    <span class="n">DEBUG</span><span class="o">=</span><span class="kc">False</span>
<span class="linenos">168</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">169</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">170</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">171</span>
<span class="linenos">172</span>    <span class="n">json_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
<span class="linenos">173</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">174</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">175</span>
<span class="linenos">176</span>    <span class="c1"># Validate if the necessary data is on the provided JSON </span>
<span class="linenos">177</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">})):</span>
<span class="linenos">178</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>    
<span class="linenos">179</span>
<span class="linenos">180</span>    <span class="n">content</span>     <span class="o">=</span> <span class="s2">&quot;content&quot;</span>     <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">181</span>    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">182</span>    <span class="n">guide</span>       <span class="o">=</span> <span class="s2">&quot;guide&quot;</span>       <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;guide&#39;</span><span class="p">]</span>     <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">183</span>    <span class="n">createdon</span>   <span class="o">=</span> <span class="s2">&quot;createdon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">184</span>    <span class="n">updatedon</span>   <span class="o">=</span> <span class="s2">&quot;updatedon&quot;</span>   <span class="ow">in</span> <span class="n">json_data</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">None</span>
<span class="linenos">185</span>
<span class="linenos">186</span>    <span class="c1"># If the mimetype does not indicate JSON (application/json, see is_json()), this returns None.</span>
<span class="linenos">187</span>    <span class="k">if</span> <span class="p">(</span><span class="n">json_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span> 
<span class="linenos">188</span>
<span class="linenos">189</span>    <span class="c1"># If availabe, set the final guide filename after knowing the database id of the new recommendation</span>
<span class="linenos">190</span>
<span class="linenos">191</span>    <span class="k">if</span> <span class="n">guide</span> <span class="ow">and</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
<span class="linenos">192</span>        <span class="c1"># Remove previous guide.</span>
<span class="linenos">193</span>        <span class="n">previous_guide</span> <span class="o">=</span> <span class="n">find_recommendation</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;guide&#39;</span><span class="p">]</span>
<span class="linenos">194</span>        <span class="k">if</span> <span class="p">(</span><span class="n">guide</span> <span class="o">!=</span> <span class="n">previous_guide</span><span class="p">):</span> 
<span class="linenos">195</span>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">UPLOAD_DIRECTORY</span><span class="p">,</span> <span class="n">previous_guide</span><span class="p">))</span>
<span class="linenos">196</span>
<span class="linenos">197</span>        <span class="c1"># Get the file extension of the guide uploaded (it can be txt or md) in order to create the final name of the file.</span>
<span class="linenos">198</span>        <span class="n">file_extension</span> <span class="o">=</span> <span class="n">guide</span><span class="p">[</span><span class="n">guide</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span> <span class="nb">len</span><span class="p">(</span><span class="n">guide</span><span class="p">)]</span>
<span class="linenos">199</span>        <span class="n">final_recommendation_filename</span> <span class="o">=</span> <span class="s2">&quot;recommendation_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">file_extension</span>
<span class="linenos">200</span>        <span class="n">guide</span> <span class="o">=</span> <span class="n">final_recommendation_filename</span>
<span class="linenos">201</span>
<span class="linenos">202</span>    <span class="c1"># Build the SQL instruction using our handy function to build sql instructions.</span>
<span class="linenos">203</span>    <span class="n">values</span>  <span class="o">=</span> <span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="n">createdon</span><span class="p">,</span> <span class="n">updatedon</span><span class="p">)</span>
<span class="linenos">204</span>    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">content</span> <span class="ow">and</span> <span class="s2">&quot;content&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">description</span> <span class="ow">and</span> <span class="s2">&quot;description&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">guide</span> <span class="ow">and</span> <span class="s2">&quot;guideFileName&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">createdon</span> <span class="ow">and</span> <span class="s2">&quot;createdon&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span> <span class="n">updatedon</span> <span class="ow">and</span> <span class="s2">&quot;updatedOn&quot;</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">]</span>
<span class="linenos">205</span>    <span class="n">where</span>   <span class="o">=</span> <span class="s2">&quot;WHERE id=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">206</span>    <span class="c1"># Check if there is anything to update (i.e. frontend developer has not sent any values to update).</span>
<span class="linenos">207</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">208</span>
<span class="linenos">209</span>    <span class="n">sql</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_sql_instruction</span><span class="p">(</span><span class="s2">&quot;UPDATE recommendation&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span>
<span class="linenos">210</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[SAM-API]: [PUT]/recomendation - &quot;</span> <span class="o">+</span> <span class="n">sql</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
<span class="linenos">211</span>
<span class="linenos">212</span>    <span class="c1"># Update Recommendation</span>
<span class="linenos">213</span>    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">db_execute_update_insert</span><span class="p">(</span><span class="n">mysql</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="linenos">214</span>
<span class="linenos">215</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>   
<span class="linenos">216</span>
<span class="linenos">217</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">218</span><span class="sd">[Summary]: Get recommendations.</span>
<span class="linenos">219</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">220</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">221</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendations&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">222</span><span class="k">def</span> <span class="nf">get_recommendations</span><span class="p">(</span><span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">223</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">224</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">225</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">226</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">227</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">228</span>
<span class="linenos">229</span>    <span class="c1"># 2. Let&#39;s get the set of available recommendations</span>
<span class="linenos">230</span>    <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">231</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">232</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">233</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">234</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, content, description, guideFileName, createdon, updatedon FROM recommendation&quot;</span><span class="p">)</span>
<span class="linenos">235</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">236</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">237</span>            <span class="n">recommendation</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">238</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">239</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">240</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">241</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;guide&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">242</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;createdOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">243</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;updatedOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">244</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">245</span>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
<span class="linenos">246</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">247</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">248</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">249</span>
<span class="linenos">250</span>        <span class="c1"># 3. Let&#39;s get the info about the modules linked to each recommendation.</span>
<span class="linenos">251</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">252</span>        <span class="k">for</span> <span class="n">recommendation</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">:</span>
<span class="linenos">253</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">254</span>                <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">255</span>                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT module_id FROM view_module_recommendations WHERE recommendation_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
<span class="linenos">256</span>                <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">257</span>                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">258</span>                    <span class="n">module</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">259</span>                    <span class="c1"># Remove unnecessary information from the object</span>
<span class="linenos">260</span>                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;tree&quot;</span> <span class="ow">in</span> <span class="n">module</span><span class="p">):</span> <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>
<span class="linenos">261</span>                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;recommendations&quot;</span> <span class="ow">in</span> <span class="n">module</span><span class="p">):</span> <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span>
<span class="linenos">262</span>                    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;dependencies&quot;</span> <span class="ow">in</span> <span class="n">module</span><span class="p">):</span> <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>
<span class="linenos">263</span>                    <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;modules&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
<span class="linenos">264</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">265</span>                <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">266</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">267</span>        
<span class="linenos">268</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">269</span>        <span class="c1"># 4. The request was a success, the user &#39;is in the rabbit hole&#39;</span>
<span class="linenos">270</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">271</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">))</span>
<span class="linenos">272</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">273</span>            <span class="k">return</span><span class="p">(</span><span class="n">recommendations</span><span class="p">)</span>
<span class="linenos">274</span>
<span class="linenos">275</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">276</span><span class="sd">[Summary]: Finds recommendation by ID.</span>
<span class="linenos">277</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">278</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">279</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendation/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">280</span><span class="k">def</span> <span class="nf">find_recommendation</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">281</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">282</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">283</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">284</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">285</span>
<span class="linenos">286</span>    <span class="c1"># 2. Let&#39;s get the set of available recommendations</span>
<span class="linenos">287</span>    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">288</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">289</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">290</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">291</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, content, description, guideFileName, createdon, updatedon FROM recommendation WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">292</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">293</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">294</span>            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">295</span>            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">296</span>            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">297</span>            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">298</span>            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;guide&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">299</span>            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;createdOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">300</span>            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;updatedOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">301</span>            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="linenos">302</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">303</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">304</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">305</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">306</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">307</span>        
<span class="linenos">308</span>        <span class="c1"># 3. The request was a success, the user &#39;is in the rabbit hole&#39;</span>
<span class="linenos">309</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">310</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">results</span><span class="p">))</span> 
<span class="linenos">311</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">312</span>            <span class="k">return</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="linenos">313</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">314</span><span class="sd">[Summary]: Finds the recommendations of question, answer association.</span>
<span class="linenos">315</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">316</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">317</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendations/question/&lt;question_id&gt;/answer/&lt;answer_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">318</span><span class="k">def</span> <span class="nf">find_recommendations_of_question_answer</span><span class="p">(</span><span class="n">question_id</span><span class="p">,</span> <span class="n">answer_id</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">319</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">320</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">321</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">322</span>    
<span class="linenos">323</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">324</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">325</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">326</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT recommendation_id as id, content, description, guide, createdon, updatedon FROM view_question_answer_recommendation WHERE question_id = </span><span class="si">%s</span><span class="s2"> AND answer_id = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">question_id</span><span class="p">,</span> <span class="n">answer_id</span><span class="p">))</span>
<span class="linenos">327</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">328</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">329</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">330</span>
<span class="linenos">331</span>    <span class="c1"># 2.2. Check for empty results </span>
<span class="linenos">332</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">333</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">334</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">335</span>        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>    
<span class="linenos">336</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">337</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">338</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">339</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">340</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">341</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">342</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">343</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;guide&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> 
<span class="linenos">344</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="s2">&quot;recommendation&quot;</span>
<span class="linenos">345</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;children&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">346</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">347</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">348</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">349</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">350</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">351</span>        <span class="c1"># 3. &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">352</span>        <span class="k">if</span> <span class="p">(</span><span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">353</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos">354</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">355</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">356</span>
<span class="linenos">357</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">358</span><span class="sd">[Summary]: Finds the recommendations of a module</span>
<span class="linenos">359</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">360</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">361</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendations/module/&lt;module_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">362</span><span class="k">def</span> <span class="nf">find_recommendations_of_module</span><span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">363</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">364</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> 
<span class="linenos">365</span>            <span class="k">return</span>
<span class="linenos">366</span>    
<span class="linenos">367</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">368</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">369</span>    
<span class="linenos">370</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">371</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">372</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">373</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT recommendation_ID, recommendation_content, createdon, updatedon FROM view_module_recommendations WHERE module_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">module_id</span><span class="p">)</span>
<span class="linenos">374</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">375</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">376</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">377</span>
<span class="linenos">378</span>    <span class="c1"># Check for empty results </span>
<span class="linenos">379</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">380</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">381</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">382</span>        <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>    
<span class="linenos">383</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">384</span>        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">385</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">386</span>            <span class="n">recommendation</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">387</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>                  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">388</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">389</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">390</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">391</span>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
<span class="linenos">392</span>    
<span class="linenos">393</span>    <span class="c1"># Find questions and answers associated or mapped to a particular recommendation and module</span>
<span class="linenos">394</span>    <span class="k">for</span> <span class="n">recommendation</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">:</span>
<span class="linenos">395</span>        <span class="n">recommendation_id</span> <span class="o">=</span> <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos">396</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">397</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">398</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT recommendation_question_answer_id, question_id, answer_id, createdon, updatedon FROM view_module_recommendations_questions_answers WHERE module_id=</span><span class="si">%s</span><span class="s2"> and recommendation_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">recommendation_id</span><span class="p">))</span>
<span class="linenos">399</span>            <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">400</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">401</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">402</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">403</span>            <span class="n">questions_answers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">404</span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">405</span>                <span class="n">question_answer</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">406</span>                <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">407</span>                <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">408</span>                <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">409</span>                <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">410</span>                <span class="n">question_answer</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">411</span>                <span class="n">questions_answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question_answer</span><span class="p">)</span>
<span class="linenos">412</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">413</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;questions_answers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">questions_answers</span>
<span class="linenos">414</span>    
<span class="linenos">415</span>    <span class="c1"># &#39;May the Force be with you, young master&#39;.</span>
<span class="linenos">416</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">417</span>    <span class="k">if</span> <span class="p">(</span><span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">418</span>        <span class="k">return</span><span class="p">(</span><span class="n">recommendations</span><span class="p">)</span>
<span class="linenos">419</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">420</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">))</span> 
<span class="linenos">421</span>
<span class="linenos">422</span>
<span class="linenos">423</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">424</span><span class="sd">[Summary]: Removes the mapping between a module and its recommendations.</span>
<span class="linenos">425</span><span class="sd">[Returns]: Returns a reponse object.</span>
<span class="linenos">426</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">427</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendations/module/&lt;module_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="linenos">428</span><span class="k">def</span> <span class="nf">remove_recommendations_of_module</span><span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">429</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">internal_call</span><span class="p">:</span>
<span class="linenos">430</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">431</span>
<span class="linenos">432</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">433</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">434</span>   
<span class="linenos">435</span>    <span class="c1"># 2. Connect to the database and delete the resource</span>
<span class="linenos">436</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">437</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">438</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">439</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM recommendation_question_answer WHERE ID IN (SELECT recommendation_question_answer_ID From view_module_recommendations_questions_answers where module_id=</span><span class="si">%s</span><span class="s2">);&quot;</span><span class="p">,</span> <span class="n">module_id</span><span class="p">)</span>
<span class="linenos">440</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">441</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">442</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">443</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">444</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">445</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">446</span>    
<span class="linenos">447</span>    <span class="c1"># The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">448</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">449</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">450</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">451</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">452</span>
<span class="linenos">453</span>
<span class="linenos">454</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">455</span><span class="sd">[Summary]: Removes the mapping of a module and a recommendation.</span>
<span class="linenos">456</span><span class="sd">[Returns]: Returns a reponse object.</span>
<span class="linenos">457</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">458</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/recommendation/&lt;recommendation_id&gt;/module/&lt;module_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="linenos">459</span><span class="k">def</span> <span class="nf">remove_recommendation_of_module</span><span class="p">(</span><span class="n">recommendation_id</span><span class="p">,</span> <span class="n">module_id</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">460</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">internal_call</span><span class="p">:</span>
<span class="linenos">461</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">462</span>
<span class="linenos">463</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">464</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">465</span>   
<span class="linenos">466</span>    <span class="c1"># 2. Connect to the database and delete the resource</span>
<span class="linenos">467</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">468</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">469</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">470</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM recommendation_question_answer WHERE ID IN (SELECT recommendation_question_answer_ID From view_module_recommendations_questions_answers where module_id=</span><span class="si">%s</span><span class="s2"> AND recommendation_id=</span><span class="si">%s</span><span class="s2">);&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">recommendation_id</span><span class="p">))</span>
<span class="linenos">471</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">472</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">473</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">474</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">475</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">476</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">477</span>    
<span class="linenos">478</span>    <span class="c1"># The Delete request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">479</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">480</span>        <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">481</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">482</span>        <span class="k">return</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">483</span>
</pre></div>
</div>
</details><section id="get-recommendations">
<h2>Get Recommendations<a class="headerlink" href="#get-recommendations" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/recommendations</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get recommendations.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the recommendation.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – Recommendation name.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Description of the recommendation.</p></li>
<li><p><strong>guide</strong> (<em>string</em>) – The filename of the recommendation guide.</p></li>
<li><p><strong>modules</strong> (<em>array</em>) – Array of modules mapped to the current recommendation.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Recommendations successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve recommendations.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/recommendations&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;guide&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;modules&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="s2">&quot;SRE&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;fullname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Elicitation&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                  <span class="nt">&quot;logic_filename&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                  <span class="nt">&quot;type_id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                  <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;createdOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/recommendation/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get recommendation identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Form Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of the recommendation.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the recommendation.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – Recommendation name.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Description of the recommendation.</p></li>
<li><p><strong>guide</strong> (<em>string</em>) – The filename of the recommendation guide.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Recommendation successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve recommendation.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/recommendation/1&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;guide&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;createdOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/recommendations/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Finds the set of recommendations for a module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Form Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the recommendation.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – Recommendation name.</p></li>
<li><p><strong>questions_answers</strong> (<em>array</em>) – An array that contains the mapping between questions and answers for the current recommendation and module.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Recommendations successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve recommendations.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/recommendations/module/1&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
            <span class="nt">&quot;questions_answers&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 13:29:49 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this example, for module 1 the recommendation 1 is given if for <code class="docutils literal notranslate"><span class="pre">question_id</span></code> the <code class="docutils literal notranslate"><span class="pre">answer_id</span></code> is given by a user.</p>
</div>
<hr/></section>
<section id="add-recommendation">
<h2>Add Recommendation<a class="headerlink" href="#add-recommendation" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/recommendation</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Add a new recommendation.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>content</strong> (<em>string</em>) – The name of the new recommendation.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – The description of the new recommendation.</p></li>
<li><p><strong>guide</strong> (<em>string</em>) – The filename of the recommendation guide.</p></li>
<li><p><strong>questions_answers</strong> (<em>array</em>) – An array that contains the mapping between questions and answers for the new recommendation.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – The id of the new recommendation.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Recommendation successfully added.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to add recommendation.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;New Recommendation&quot;</span><span class="p">,</span>
   <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;New Recommendation Description&quot;</span><span class="p">,</span>
   <span class="nt">&quot;guide&quot;</span><span class="p">:</span><span class="s2">&quot;new_recommendation.md&quot;</span><span class="p">,</span>
   <span class="nt">&quot;questions_answers&quot;</span><span class="p">:[</span>
      <span class="p">{</span>
         <span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
         <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">1</span>
      <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In order to upload a guide for the new recommendation you need to use this service in conjunction with the service detailed in <a class="reference internal" href="#upload"><span class="std std-ref">/api/file/(string:filename)</span></a>.</p>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/recommendation&quot;</span><span class="p">:{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="edit-recommendation">
<h2>Edit Recommendation<a class="headerlink" href="#edit-recommendation" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/recommendation</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Update a recommendation identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>string</em>) – The id of the recommendation to update.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The name of the new recommendation.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – The description of the new recommendation.</p></li>
<li><p><strong>guide</strong> (<em>string</em>) – The filename of the recommendation guide.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Recommendation successfully updated.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to update recommendation.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
   <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;New Recommendation updated&quot;</span><span class="p">,</span>
   <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;New recommendation description updated&quot;</span><span class="p">,</span>
   <span class="nt">&quot;guide&quot;</span><span class="p">:</span><span class="s2">&quot;recommendation_updated_guide.md&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In order to upload a new guide you need to use this service in conjunction with the service detailed in <a class="reference internal" href="#upload"><span class="std std-ref">/api/file/(string:filename)</span></a>.</p>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/recommendation&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="remove-recommendation">
<h2>Remove Recommendation<a class="headerlink" href="#remove-recommendation" title="Permalink to this headline"></a></h2>
<dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/recommendations/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Remove a recommendation identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Form Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of the recommendation to remove.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Recommendation successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove recommendation.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/recommendation&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
<hr/><dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/recommendations/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Removes the mapping between a module identified by <code class="docutils literal notranslate"><span class="pre">id</span></code> and its recommendations.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Form Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of the module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Mapping successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove mapping.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/recommendations/modules/1&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
<hr/><dl class="http delete">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">DELETE</span> </span><span class="sig-name descname"><span class="pre">/api/recommendations/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Removes the mapping between a module <code class="docutils literal notranslate"><span class="pre">id</span></code> and a recommendation <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Form Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> – The id of the recommendation or module.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Mapping successfully removed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to remove mapping.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/recommendations/1/modules/1&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
</section>
<section id="sessions-services-api">
<h1>Sessions Services API<a class="headerlink" href="#sessions-services-api" title="Permalink to this headline"></a></h1>
This section includes details concerning services developed for the session entity implemented in <details style="display:inline;margin-bottom:15px">
<summary style="list-style: none"><a><i>session.py</i></a>.</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos">  3</span><span class="sd">//</span>
<span class="linenos">  4</span><span class="sd">//	Security Advising Modules (SAM) for Cloud IoT and Mobile Ecosystem</span>
<span class="linenos">  5</span><span class="sd">//</span>
<span class="linenos">  6</span><span class="sd">//  Copyright (C) 2020 Instituto de Telecomunicações (www.it.pt)</span>
<span class="linenos">  7</span><span class="sd">//  Copyright (C) 2020 Universidade da Beira Interior (www.ubi.pt)</span>
<span class="linenos">  8</span><span class="sd">//</span>
<span class="linenos">  9</span><span class="sd">//  This program is free software: you can redistribute it and/or modify</span>
<span class="linenos"> 10</span><span class="sd">//  it under the terms of the GNU General Public License as published by</span>
<span class="linenos"> 11</span><span class="sd">//  the Free Software Foundation, either version 3 of the License, or</span>
<span class="linenos"> 12</span><span class="sd">//  (at your option) any later version.</span>
<span class="linenos"> 13</span><span class="sd">//</span>
<span class="linenos"> 14</span><span class="sd">//  This program is distributed in the hope that it will be useful,</span>
<span class="linenos"> 15</span><span class="sd">//  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="linenos"> 16</span><span class="sd">//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="linenos"> 17</span><span class="sd">//  GNU General Public License for more details.</span>
<span class="linenos"> 18</span><span class="sd">//</span>
<span class="linenos"> 19</span><span class="sd">//  You should have received a copy of the GNU General Public License</span>
<span class="linenos"> 20</span><span class="sd">//  along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="linenos"> 21</span><span class="sd">// </span>
<span class="linenos"> 22</span><span class="sd">//  This work was performed under the scope of Project SECURIoTESIGN with funding </span>
<span class="linenos"> 23</span><span class="sd">//  from FCT/COMPETE/FEDER (Projects with reference numbers UID/EEA/50008/2013 and </span>
<span class="linenos"> 24</span><span class="sd">//  POCI-01-0145-FEDER-030657) </span>
<span class="linenos"> 25</span><span class="sd">// ---------------------------------------------------------------------------</span>
<span class="linenos"> 26</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 27</span><span class="kn">import</span> <span class="nn">shutil</span>
<span class="linenos"> 28</span><span class="kn">from</span> <span class="nn">api</span> <span class="kn">import</span> <span class="n">app</span><span class="p">,</span> <span class="n">mysql</span>
<span class="linenos"> 29</span><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="linenos"> 30</span><span class="kn">import</span> <span class="nn">json</span><span class="o">,</span> <span class="nn">os</span>
<span class="linenos"> 31</span><span class="kn">import</span> <span class="nn">modules.error_handlers</span><span class="o">,</span> <span class="nn">modules.utils</span> <span class="c1"># SAM&#39;s modules</span>
<span class="linenos"> 32</span><span class="kn">import</span> <span class="nn">views.user</span><span class="o">,</span> <span class="nn">views.module</span><span class="o">,</span> <span class="nn">views.dependency</span> <span class="c1"># SAM&#39;s views</span>
<span class="linenos"> 33</span>
<span class="linenos"> 34</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 35</span><span class="sd">[Summary]: Adds a new session to a user.</span>
<span class="linenos"> 36</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos"> 37</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos"> 38</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/session&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="linenos"> 39</span><span class="k">def</span> <span class="nf">add_session</span><span class="p">():</span>
<span class="linenos"> 40</span>    <span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 41</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos"> 42</span>    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span>    <span class="c1"># 1. Check if the user has permissions to access this resource.</span>
<span class="linenos"> 45</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>    <span class="c1"># 2. Let&#39;s get our shiny new JSON object</span>
<span class="linenos"> 48</span>    <span class="c1">#    Always start by validating the structure of the json, if not valid send an invalid response.</span>
<span class="linenos"> 49</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 50</span>        <span class="n">obj</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<span class="linenos"> 51</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 52</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos"> 53</span>    
<span class="linenos"> 54</span>    <span class="c1"># 3. Let&#39;s validate the data of our JSON object with a custom function.</span>
<span class="linenos"> 55</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;module_id&quot;</span><span class="p">})):</span>
<span class="linenos"> 56</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="linenos"> 57</span>
<span class="linenos"> 58</span>    <span class="c1"># 4. Before starting a new session, let&#39;s just check if there are any dependencies. That is if the user needs to answer questions from any other module before the current one.</span>
<span class="linenos"> 59</span>    <span class="n">module_dependencies</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>
<span class="linenos"> 60</span>    
<span class="linenos"> 61</span>    <span class="k">if</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">):</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;[&#39;POST&#39;]/api/session&quot;</span><span class="p">,</span> <span class="s2">&quot;List of dependencies for module &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">module_dependencies</span><span class="p">))</span>
<span class="linenos"> 62</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">module_dependencies</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 63</span>        <span class="c1"># 4.1. Let&#39;s iterate the list of dependencies and check if the user answered the questions to that module (i.e., a closed session exists)</span>
<span class="linenos"> 64</span>        <span class="k">for</span> <span class="n">module_dependency</span> <span class="ow">in</span> <span class="n">module_dependencies</span><span class="p">:</span>
<span class="linenos"> 65</span>            <span class="n">dep_module_id</span> <span class="o">=</span> <span class="n">module_dependency</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos"> 66</span>            <span class="n">user_id</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">find_user</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span>            <span class="c1"># 4.2. Let&#39;s get the sesions of the current user for the dependency</span>
<span class="linenos"> 69</span>            <span class="n">user_sessions</span> <span class="o">=</span> <span class="n">count_sessions_of_user_module</span><span class="p">(</span><span class="n">dep_module_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="linenos"> 70</span>            <span class="k">if</span> <span class="p">(</span><span class="n">user_sessions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 71</span>                <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 72</span>                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="s2">&quot;A session was not created, the module dependencies are not fulfilled, the module is dependent on one or more modules.&quot;</span>
<span class="linenos"> 73</span>                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_dependencies</span>
<span class="linenos"> 74</span>                <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span>    <span class="c1"># 5. Check if there is an identical session closed, </span>
<span class="linenos"> 78</span>    <span class="c1">#    if true, notify the user on the return response object that a new session will be created; otherwise, </span>
<span class="linenos"> 79</span>    <span class="c1">#    delete all that of the previously opened session.</span>
<span class="linenos"> 80</span>    <span class="n">destroySessionID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="linenos"> 81</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 82</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 83</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos"> 84</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, ended FROM session WHERE userID=(SELECT ID FROM user WHERE email=</span><span class="si">%s</span><span class="s2">) AND moduleID=</span><span class="si">%s</span><span class="s2"> ORDER BY ID DESC LIMIT 1&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]))</span>
<span class="linenos"> 85</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos"> 86</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 87</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos"> 90</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos"> 91</span>            <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 92</span>                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;A session for this module was previously created and closed, a new one will be created.&quot;</span>
<span class="linenos"> 93</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 94</span>                <span class="n">destroySessionID</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="linenos"> 95</span>                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;A session for this module was previously created, but it is still open. The session will be deleted and recreated.&quot;</span>
<span class="linenos"> 96</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 97</span>
<span class="linenos"> 98</span>    <span class="k">if</span> <span class="p">(</span><span class="n">destroySessionID</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 99</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">100</span>            <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">101</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">102</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM session WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">destroySessionID</span><span class="p">)</span>
<span class="linenos">103</span>            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">104</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">105</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">106</span>        <span class="k">finally</span><span class="p">:</span>
<span class="linenos">107</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">108</span>
<span class="linenos">109</span>    
<span class="linenos">110</span>    <span class="c1"># 6. Connect to the database and add a new session.</span>
<span class="linenos">111</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">112</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">113</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO session (userID, moduleID) VALUES ((SELECT ID FROM user WHERE email=</span><span class="si">%s</span><span class="s2">), </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">],</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]))</span>
<span class="linenos">114</span>        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">insert_id</span><span class="p">()</span>
<span class="linenos">115</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">116</span>
<span class="linenos">117</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">118</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">119</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">120</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">121</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">122</span>
<span class="linenos">123</span>    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">124</span>
<span class="linenos">125</span>    <span class="c1"># 7. The request was a success, the user &#39;took the blue pill&#39;.</span>
<span class="linenos">126</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">127</span>
<span class="linenos">128</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">129</span><span class="sd">[Summary]: Updates the session with the set of answers given and the corresponding questions.</span>
<span class="linenos">130</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">131</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">132</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/session/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos">133</span><span class="k">def</span> <span class="nf">update_session</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
<span class="linenos">134</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">135</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">136</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">137</span>
<span class="linenos">138</span>    <span class="c1"># 2. Let&#39;s get our shiny new JSON object.</span>
<span class="linenos">139</span>    <span class="c1"># - Always start by validating the structure of the json, if not valid send an invalid response.</span>
<span class="linenos">140</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">141</span>        <span class="n">obj</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span>
<span class="linenos">142</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">143</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">400</span><span class="p">)</span> 
<span class="linenos">144</span>    
<span class="linenos">145</span>    <span class="c1"># print(obj)</span>
<span class="linenos">146</span>    <span class="n">answer_user_inputted</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">147</span>    <span class="c1"># 3. Let&#39;s validate the data of our JSON object with a custom function.</span>
<span class="linenos">148</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;question_id&quot;</span><span class="p">,</span><span class="s2">&quot;answer_id&quot;</span><span class="p">})):</span>
<span class="linenos">149</span>        <span class="k">if</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">valid_json</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;question_id&quot;</span><span class="p">,</span><span class="s2">&quot;input&quot;</span><span class="p">})):</span> 
<span class="linenos">150</span>            <span class="n">answer_user_inputted</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">151</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">152</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Some required key or value is missing from the JSON object&quot;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
<span class="linenos">153</span>
<span class="linenos">154</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">155</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">156</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">157</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">answer_user_inputted</span><span class="p">):</span>
<span class="linenos">158</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO session_user_answer (sessionID, questionAnswerID) VALUES (</span><span class="si">%s</span><span class="s2">, (SELECT ID FROM question_answer WHERE questionID=</span><span class="si">%s</span><span class="s2"> AND answerID=</span><span class="si">%s</span><span class="s2">))&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;answer_id&#39;</span><span class="p">]))</span>
<span class="linenos">159</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">160</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO session_user_answer (sessionID, questionID, input) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;question_id&#39;</span><span class="p">],</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]))</span>
<span class="linenos">161</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">162</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">163</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">164</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">165</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">166</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">167</span>
<span class="linenos">168</span>    <span class="c1"># 5. The Update request was a success, the user &#39;is in the rabbit hole&#39;</span>
<span class="linenos">169</span>    <span class="k">return</span> <span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
<span class="linenos">170</span>
<span class="linenos">171</span>
<span class="linenos">172</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">173</span><span class="sd">[Summary]: Get sessions (opened and closed)</span>
<span class="linenos">174</span><span class="sd">[Returns]: Returns response result.</span>
<span class="linenos">175</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">176</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/sessions&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">177</span><span class="k">def</span> <span class="nf">get_sessions</span><span class="p">():</span>
<span class="linenos">178</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">179</span>
<span class="linenos">180</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">181</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">182</span>
<span class="linenos">183</span>    <span class="c1"># 2. Let&#39;s existing sessions from the database.</span>
<span class="linenos">184</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">185</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">186</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">187</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, userID, moduleID, ended, createdOn, updatedOn FROM session&quot;</span><span class="p">)</span>
<span class="linenos">188</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">189</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">190</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">191</span>    
<span class="linenos">192</span>    <span class="c1"># 2.1. Check for empty results.</span>
<span class="linenos">193</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">194</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">195</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">196</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>    
<span class="linenos">197</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">198</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">199</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">200</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">201</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">202</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">203</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">204</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ended&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">205</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">206</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">207</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">208</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">209</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">210</span>        <span class="c1"># 3. &#39;May the Force be with you&#39;.</span>
<span class="linenos">211</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos">212</span>
<span class="linenos">213</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">214</span><span class="sd">[Summary]: Ends a user&#39;s session.</span>
<span class="linenos">215</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">216</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">217</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/session/&lt;ID&gt;/end&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;PUT&#39;</span><span class="p">])</span>
<span class="linenos">218</span><span class="k">def</span> <span class="nf">end_session</span><span class="p">(</span><span class="n">ID</span><span class="p">):</span>
<span class="linenos">219</span>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;PUT&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">220</span>
<span class="linenos">221</span>    <span class="c1"># 1. Check if the user has permissions to access this resource.</span>
<span class="linenos">222</span>    <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">223</span>
<span class="linenos">224</span>    <span class="c1"># 2. End a session by defining the flag ended to one.</span>
<span class="linenos">225</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">226</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">227</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">228</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE session SET ended=1 WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span> 
<span class="linenos">229</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">230</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">231</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">232</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">233</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">234</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">235</span>        <span class="c1"># 3. The request was a success, let&#39;s generate the recommendations.</span>
<span class="linenos">236</span>        <span class="k">return</span> <span class="n">find_recommendations</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">237</span>
<span class="linenos">238</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">239</span><span class="sd">[Summary]: Gets a session that was previsouly closed. A session is considered closed when all answers were given by the end user.</span>
<span class="linenos">240</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">241</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">242</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/session/&lt;ID&gt;/closed&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">243</span><span class="k">def</span> <span class="nf">find_session_closed</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">244</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">245</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">246</span>    
<span class="linenos">247</span>    <span class="c1"># 0. Check if the user has permissions to access this resource.</span>
<span class="linenos">248</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">249</span>
<span class="linenos">250</span>    <span class="c1"># 1. Let&#39;s get the data of the session that has ended.</span>
<span class="linenos">251</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting data of the session that has ended.&quot;</span><span class="p">)</span> 
<span class="linenos">252</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">253</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">254</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">255</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT session_ID, session_userID, session_moduleID, session_ended, session_createdOn, session_updatedOn, question_ID, question, answer_input, module_logic, answer_id, answer FROM view_session_answers WHERE session_ID=</span><span class="si">%s</span><span class="s2"> AND session_ended=1 ORDER BY question_ID&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">256</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">257</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">258</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">259</span>    
<span class="linenos">260</span>    <span class="c1"># 2. Check for empty results.</span>
<span class="linenos">261</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking emoty results&quot;</span><span class="p">)</span>
<span class="linenos">262</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">263</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">264</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">265</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, userID, moduleID, ended, createdOn, updatedOn FROM session WHERE ID = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">266</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">267</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">268</span>        <span class="c1"># 3. Let&#39;s get the info about the session.</span>
<span class="linenos">269</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">270</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">271</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">272</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">273</span>            <span class="c1"># data[&#39;module_logic&#39;] = row[9] </span>
<span class="linenos">274</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ended&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">275</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdOn&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">276</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedOn&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">277</span>            <span class="k">break</span>
<span class="linenos">278</span>
<span class="linenos">279</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">280</span>            <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">281</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT recommendation_id, recommendation, recommendation_description, recommendation_guide  FROM view_session_recommendation WHERE session_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">282</span>            <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">283</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">284</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">285</span>
<span class="linenos">286</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">287</span>            <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">288</span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">289</span>                <span class="n">recommendation</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">290</span>                <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>                  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">291</span>                <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">292</span>                <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">293</span>                <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;recommendation_guide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">294</span>                <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
<span class="linenos">295</span>            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;recommendations&quot;</span><span class="p">:</span> <span class="n">recommendations</span><span class="p">})</span>
<span class="linenos">296</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">297</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">298</span>
<span class="linenos">299</span>        <span class="k">if</span> <span class="p">(</span><span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">300</span>            <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">301</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">302</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
<span class="linenos">303</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">304</span>        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">305</span>        <span class="n">previous_question_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># To support multiple choice questions</span>
<span class="linenos">306</span>        <span class="c1"># 3. Let&#39;s get the info about the session.</span>
<span class="linenos">307</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">308</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">309</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">310</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">311</span>            <span class="c1"># data[&#39;module_logic&#39;] = row[9] </span>
<span class="linenos">312</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ended&#39;</span><span class="p">]</span>        <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">313</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdOn&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">314</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedOn&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">315</span>            <span class="k">break</span>
<span class="linenos">316</span>        <span class="c1"># 4. Let&#39;s get the questions and inputted answers.</span>
<span class="linenos">317</span>        <span class="n">questions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">318</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">319</span>            <span class="n">question</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">320</span>            <span class="k">if</span> <span class="n">previous_question_id</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">previous_question_id</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
<span class="linenos">321</span>                <span class="n">previous_question_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos">322</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">323</span>                <span class="k">continue</span>
<span class="linenos">324</span>            <span class="n">question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos">325</span>            <span class="n">question</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="linenos">326</span>
<span class="linenos">327</span>            <span class="n">answers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Empty array of answers</span>
<span class="linenos">328</span>            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">329</span>                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="n">question</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
<span class="linenos">330</span>                    <span class="k">continue</span>
<span class="linenos">331</span>                <span class="c1"># Let&#39;s check if the answer was user inputted, or selected from the database.</span>
<span class="linenos">332</span>                <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">333</span>                    <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]})</span>
<span class="linenos">334</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">335</span>                    <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> <span class="s2">&quot;ID&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">11</span><span class="p">]})</span>
<span class="linenos">336</span>            
<span class="linenos">337</span>            <span class="n">question</span><span class="p">[</span><span class="s1">&#39;answer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">answers</span>
<span class="linenos">338</span>            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
<span class="linenos">339</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;questions&quot;</span><span class="p">:</span>  <span class="n">questions</span><span class="p">})</span>
<span class="linenos">340</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">341</span>    
<span class="linenos">342</span>    <span class="c1"># 5. Let&#39;s now get the recommendations, if any, stored for this session</span>
<span class="linenos">343</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Getting recomendations stored&quot;</span><span class="p">)</span>
<span class="linenos">344</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">345</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">346</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT recommendation_id, recommendation, recommendation_description, recommendation_guide  FROM view_session_recommendation WHERE session_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">347</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">348</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">349</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">350</span>
<span class="linenos">351</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">352</span>        <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">353</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">354</span>            <span class="n">recommendation</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">355</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>                  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">356</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>             <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">357</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>         <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">358</span>            <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;recommendation_guide&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">359</span>            <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
<span class="linenos">360</span>        <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;recommendations&quot;</span><span class="p">:</span> <span class="n">recommendations</span><span class="p">})</span>
<span class="linenos">361</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">362</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">363</span>
<span class="linenos">364</span>    <span class="k">if</span> <span class="p">(</span><span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">365</span>        <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> 
<span class="linenos">366</span>    <span class="k">else</span><span class="p">:</span> 
<span class="linenos">367</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
<span class="linenos">368</span>
<span class="linenos">369</span>
<span class="linenos">370</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">371</span><span class="sd">[Summary]: Gets closed sessions. A session is considered closed when all answers were given by the end user.</span>
<span class="linenos">372</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">373</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">374</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/sessions/closed&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">375</span><span class="k">def</span> <span class="nf">get_sessions_closed</span><span class="p">(</span><span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">376</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">377</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">378</span>    
<span class="linenos">379</span>    <span class="c1"># Check if the user has permissions to access this resource.</span>
<span class="linenos">380</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">381</span>
<span class="linenos">382</span>    <span class="c1"># Let&#39;s get the list of sessions from the db.</span>
<span class="linenos">383</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">384</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">385</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">386</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id FROM session WHERE ended =1&quot;</span><span class="p">)</span>
<span class="linenos">387</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">388</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">389</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">390</span>    
<span class="linenos">391</span>    <span class="c1"># Check for empty results.</span>
<span class="linenos">392</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">393</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">394</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">395</span>        <span class="k">if</span> <span class="p">(</span><span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">396</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">397</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">398</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">400</span><span class="p">))</span>
<span class="linenos">399</span>
<span class="linenos">400</span>    <span class="n">sessions</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">401</span>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">402</span>        <span class="n">session</span> <span class="o">=</span> <span class="n">find_session_closed</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">403</span>        <span class="k">if</span> <span class="p">(</span><span class="n">session</span><span class="p">):</span> <span class="n">sessions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
<span class="linenos">404</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">405</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">406</span>
<span class="linenos">407</span>    <span class="c1"># &#39;May the Force be with you&#39;.</span>
<span class="linenos">408</span>    <span class="k">if</span> <span class="p">(</span><span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">409</span>        <span class="k">return</span><span class="p">(</span><span class="n">sessions</span><span class="p">)</span> 
<span class="linenos">410</span>    <span class="k">else</span><span class="p">:</span> 
<span class="linenos">411</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">sessions</span><span class="p">))</span>
<span class="linenos">412</span>
<span class="linenos">413</span>
<span class="linenos">414</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">415</span><span class="sd">[Summary]: Finds a session by ID (opened or closed)</span>
<span class="linenos">416</span><span class="sd">[Returns]: Returns response result.</span>
<span class="linenos">417</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">418</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/session/&lt;ID&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">419</span><span class="k">def</span> <span class="nf">find_session</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">420</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">421</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">422</span>
<span class="linenos">423</span>    <span class="c1"># 1. Check if the user has permissions to access this resource</span>
<span class="linenos">424</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">425</span>
<span class="linenos">426</span>    <span class="c1"># 2. Let&#39;s existing sessions from the database.</span>
<span class="linenos">427</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">428</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">429</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">430</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT ID, userID, moduleID, ended, createdOn, updatedOn FROM session WHERE ID=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">431</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">432</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">433</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">434</span>    
<span class="linenos">435</span>    <span class="c1"># 2.1. Check for empty results.</span>
<span class="linenos">436</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">437</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">438</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">439</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">440</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">441</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">442</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">443</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">444</span>        <span class="c1"># 2.2. Check if the session requested was ended.</span>
<span class="linenos">445</span>        <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
<span class="linenos">446</span>            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">447</span>            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">448</span>            <span class="n">datas</span> <span class="o">=</span> <span class="n">find_session_closed</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">449</span>            <span class="k">if</span> <span class="p">(</span><span class="n">datas</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">450</span>                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">451</span>                    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">452</span>                <span class="k">else</span><span class="p">:</span> 
<span class="linenos">453</span>                    <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">454</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">455</span>                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">456</span>                    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span> 
<span class="linenos">457</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">458</span>                    <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos">459</span>        
<span class="linenos">460</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">461</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">462</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">463</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">464</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">465</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">466</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ended&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">467</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">468</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">469</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">470</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">471</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">472</span>
<span class="linenos">473</span>        <span class="c1"># 3. &#39;May the Force be with you&#39;.</span>
<span class="linenos">474</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">475</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>    
<span class="linenos">476</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">477</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos">478</span>
<span class="linenos">479</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">480</span><span class="sd">[Summary]: Finds sessions by user email (opened or closed)</span>
<span class="linenos">481</span><span class="sd">[Returns]: Returns response result.</span>
<span class="linenos">482</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">483</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/sessions/user/&lt;user_email&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">484</span><span class="k">def</span> <span class="nf">find_sessions_of_user</span><span class="p">(</span><span class="n">user_email</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">485</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">486</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">487</span>
<span class="linenos">488</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">489</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">490</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">491</span>
<span class="linenos">492</span>    <span class="c1"># Let&#39;s existing sessions from the database.</span>
<span class="linenos">493</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">494</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">495</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">496</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT session_id, user_id, user_email, moduleID, ended, createdon, updatedon FROM view_user_sessions WHERE user_email=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">user_email</span><span class="p">)</span>
<span class="linenos">497</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">498</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">499</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">500</span>    
<span class="linenos">501</span>    <span class="c1"># Check for empty results.</span>
<span class="linenos">502</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">503</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">504</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">505</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">506</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">507</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">508</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">509</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">510</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">511</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">512</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">513</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">514</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">515</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_email&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">516</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ended&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">517</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">518</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos">519</span>            <span class="n">session</span>         <span class="o">=</span> <span class="n">find_session_closed</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">520</span>            <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos">521</span>                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;questions&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">):</span> 
<span class="linenos">522</span>                    <span class="n">questions</span>               <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">]</span>
<span class="linenos">523</span>                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">questions</span>
<span class="linenos">524</span>                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;recommendations&quot;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">):</span>
<span class="linenos">525</span>                    <span class="n">recommendations</span>         <span class="o">=</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span>
<span class="linenos">526</span>                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span>
<span class="linenos">527</span>            <span class="n">module</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">528</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span>
<span class="linenos">529</span>            <span class="k">del</span> <span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>
<span class="linenos">530</span>            <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">):</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">531</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">532</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">533</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">534</span>        
<span class="linenos">535</span>        <span class="c1"># &#39;May the Force be with you&#39;.</span>
<span class="linenos">536</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">537</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
<span class="linenos">538</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">539</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos">540</span>
<span class="linenos">541</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">542</span><span class="sd">[Summary]: Finds sessions by module ID and user email (closed)</span>
<span class="linenos">543</span><span class="sd">[Returns]: Returns response result.</span>
<span class="linenos">544</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">545</span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/sessions/module/&lt;module_id&gt;/user/&lt;user_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="linenos">546</span><span class="k">def</span> <span class="nf">find_sessions_of_user_module</span><span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">internal_call</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">547</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">548</span>        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span> <span class="k">return</span>
<span class="linenos">549</span>
<span class="linenos">550</span>    <span class="c1"># Check if the user has permissions to access this resource</span>
<span class="linenos">551</span>    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span> 
<span class="linenos">552</span>        <span class="n">views</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">isAuthenticated</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<span class="linenos">553</span>
<span class="linenos">554</span>    <span class="c1"># Let&#39;s existing sessions from the database.</span>
<span class="linenos">555</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">556</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">557</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">558</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT session_id, user_id, user_email, moduleID, ended, createdon, updatedon FROM view_user_sessions WHERE moduleID=</span><span class="si">%s</span><span class="s2"> AND user_id=</span><span class="si">%s</span><span class="s2"> AND ended=1 ORDER BY session_id DESC&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
<span class="linenos">559</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">560</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">561</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">562</span>    
<span class="linenos">563</span>    <span class="c1"># Check for empty results.</span>
<span class="linenos">564</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">565</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">566</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">567</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">568</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">569</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">570</span>            <span class="k">return</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="linenos">571</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">572</span>        <span class="n">datas</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Create a new nice empty array of dictionaries to be populated with data from the DB.</span>
<span class="linenos">573</span>        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">574</span>            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">575</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>          <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">576</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">577</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_email&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">578</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">579</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ended&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">580</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;createdOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="linenos">581</span>            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;updatedOn&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
<span class="linenos">582</span>            <span class="n">datas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">583</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">584</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">585</span>        
<span class="linenos">586</span>        <span class="c1"># &#39;May the Force be with you&#39;.</span>
<span class="linenos">587</span>        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">internal_call</span><span class="p">):</span>
<span class="linenos">588</span>            <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">datas</span><span class="p">))</span>
<span class="linenos">589</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">590</span>            <span class="k">return</span><span class="p">(</span><span class="n">datas</span><span class="p">)</span>
<span class="linenos">591</span>
<span class="linenos">592</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">593</span><span class="sd">[Summary]: After closing the session we need to find the recommendations based on the answers given on that session &lt;ID&gt;.</span>
<span class="linenos">594</span><span class="sd">[Returns]: Response result.</span>
<span class="linenos">595</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">596</span><span class="k">def</span> <span class="nf">find_recommendations</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
<span class="linenos">597</span>    <span class="c1"># 1. Is there a logic file to process the set of answers given in this session? If yes, then, run the logic file. </span>
<span class="linenos">598</span>    <span class="c1">#    This element will be in charge of calling the service to return one or more recommendations, depending on the implemented logic.  </span>
<span class="linenos">599</span>    <span class="c1">#    Otherwise, use the static information present in the database to infer the set of recommendations.</span>
<span class="linenos">600</span>    <span class="n">session</span> <span class="o">=</span> <span class="p">(</span><span class="n">find_session_closed</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
<span class="linenos">601</span>    
<span class="linenos">602</span>    <span class="k">if</span> <span class="p">(</span><span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">603</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;Unable to find recommendations for this session, maybe, there is something wrong with the answers given in this session.&quot;</span><span class="p">,</span> <span class="mi">403</span><span class="p">)</span> 
<span class="linenos">604</span>
<span class="linenos">605</span>    <span class="n">module</span>               <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">],</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">606</span>    <span class="n">tree</span>                 <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">get_module_tree</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]),</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">607</span>    <span class="c1"># Checks if tree exists</span>
<span class="linenos">608</span>    <span class="k">if</span> <span class="p">(</span><span class="n">tree</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">609</span>        <span class="n">ordered_questions</span>    <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">order_questions</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">],</span> <span class="p">[])</span>
<span class="linenos">610</span>
<span class="linenos">611</span>    <span class="c1">#if (session[&#39;module_logic&#39;] != None):</span>
<span class="linenos">612</span>    <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">613</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">614</span>            <span class="c1"># 2.1. Get information related to the current session. This includes the information about the module, the set of related questions, and the answers given by the user to those questions.</span>
<span class="linenos">615</span>            <span class="n">json_session</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">find_session</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
<span class="linenos">616</span>            <span class="c1"># Replace the questions with ordered questions</span>
<span class="linenos">617</span>            <span class="c1"># If questions exist</span>
<span class="linenos">618</span>            <span class="k">if</span><span class="p">(</span><span class="n">tree</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">619</span>                <span class="n">json_session</span><span class="p">[</span><span class="s1">&#39;questions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ordered_questions</span>
<span class="linenos">620</span>            <span class="c1"># 2.2. Get the set of available recommendations.</span>
<span class="linenos">621</span>            <span class="n">json_recommendations</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">views</span><span class="o">.</span><span class="n">recommendation</span><span class="o">.</span><span class="n">get_recommendations</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
<span class="linenos">622</span>            
<span class="linenos">623</span>            <span class="c1"># 2.3 Get dependencies of the current module, including the last sessions there were flagged has being closed.</span>
<span class="linenos">624</span>            <span class="n">module_id</span>   <span class="o">=</span> <span class="n">json_session</span><span class="p">[</span><span class="s1">&#39;module_id&#39;</span><span class="p">]</span>
<span class="linenos">625</span>            <span class="n">user_id</span>     <span class="o">=</span> <span class="n">json_session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]</span>
<span class="linenos">626</span>            <span class="n">dependencies</span> <span class="o">=</span> <span class="n">views</span><span class="o">.</span><span class="n">dependency</span><span class="o">.</span><span class="n">find_dependency_of_module</span><span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">627</span>
<span class="linenos">628</span>            <span class="k">if</span> <span class="p">(</span><span class="n">dependencies</span><span class="p">):</span>
<span class="linenos">629</span>                <span class="k">for</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
<span class="linenos">630</span>                    <span class="k">del</span> <span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos">631</span>                    <span class="k">del</span> <span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;createdon&#39;</span><span class="p">]</span>
<span class="linenos">632</span>                    <span class="k">del</span> <span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;updatedon&#39;</span><span class="p">]</span>
<span class="linenos">633</span>                    <span class="n">dep_module_id</span> <span class="o">=</span> <span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos">634</span>                    <span class="c1"># Get the last session of each dependency</span>
<span class="linenos">635</span>                    <span class="n">last_session_id</span>    <span class="o">=</span> <span class="p">(</span><span class="n">find_sessions_of_user_module</span><span class="p">(</span><span class="n">dep_module_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="linenos">636</span>                    <span class="c1"># Get the answers given to that last session </span>
<span class="linenos">637</span>                    <span class="n">last_session</span> <span class="o">=</span> <span class="n">find_session</span><span class="p">(</span><span class="n">last_session_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="linenos">638</span>                    <span class="n">dependency</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">][</span><span class="s1">&#39;last_session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_session</span>
<span class="linenos">639</span>            
<span class="linenos">640</span>            <span class="n">json_session</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>
<span class="linenos">641</span>
<span class="linenos">642</span>            <span class="c1"># 2.4. Dynamically load the logic element for the current session.</span>
<span class="linenos">643</span>            <span class="n">module_logic_filename</span> <span class="o">=</span> <span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">]</span>
<span class="linenos">644</span>            <span class="n">module_logic_filename</span> <span class="o">=</span> <span class="n">module_logic_filename</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">module_logic_filename</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span> <span class="c1"># Remove file extension</span>
<span class="linenos">645</span>            <span class="c1"># name = &quot;external.&quot; + module_logic_filename + &quot;.&quot; + module_logic_filename</span>
<span class="linenos">646</span>            <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;external.&#39;</span> <span class="o">+</span> <span class="n">module_logic_filename</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>
<span class="linenos">647</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">648</span>                <span class="n">provided_recommendations</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">json_session</span><span class="p">,</span> <span class="n">json_recommendations</span><span class="p">)</span>
<span class="linenos">649</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">650</span>                <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;logic_file&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos">651</span>                <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">652</span>                
<span class="linenos">653</span>            <span class="c1"># 2.5. Make the recommendations taking into account the results of the logic element.</span>
<span class="linenos">654</span>            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">provided_recommendations</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">655</span>                <span class="k">for</span> <span class="n">recommendation_id</span> <span class="ow">in</span> <span class="n">provided_recommendations</span><span class="p">:</span>
<span class="linenos">656</span>                    <span class="n">add_logic_session_recommendation</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">recommendation_id</span><span class="p">)</span>
<span class="linenos">657</span>
<span class="linenos">658</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">659</span>            <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">console_log</span><span class="p">(</span><span class="s2">&quot;end_session&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<span class="linenos">660</span>            <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">661</span>
<span class="linenos">662</span>    <span class="c1"># 2. Get the list of recommendations to be stored in the session.</span>
<span class="linenos">663</span>    <span class="c1">#    -&gt; Some redundancy is expected to exist on the database, however, it avoids further </span>
<span class="linenos">664</span>    <span class="c1">#       processing when checking the history of sessions.</span>
<span class="linenos">665</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">666</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">667</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">668</span>        <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">669</span>            <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;view_recommendation_logic&quot;</span>
<span class="linenos">670</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">671</span>            <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;view_recommendation&quot;</span>
<span class="linenos">672</span>        
<span class="linenos">673</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT session_id, recommendation_id, recommendation, recommendation_description, guideFileName FROM &quot;</span> <span class="o">+</span> <span class="n">table_name</span> <span class="o">+</span> <span class="s2">&quot; WHERE session_id=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
<span class="linenos">674</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">675</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">676</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">677</span>        
<span class="linenos">678</span>    <span class="c1"># 2.1 Check for empty results.</span>
<span class="linenos">679</span>    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
<span class="linenos">680</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">681</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">682</span>        <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">404</span><span class="p">))</span>
<span class="linenos">683</span>    
<span class="linenos">684</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">685</span>    <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">686</span>    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;recommendations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">recommendations</span>
<span class="linenos">687</span>    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">688</span>        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">):</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">689</span>        <span class="n">recommendation</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">690</span>        <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>                    <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">691</span>        <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>               <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">692</span>        <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>           <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="linenos">693</span>        <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;recommendation_guide&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="linenos">694</span>        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recommendation</span><span class="p">)</span>
<span class="linenos">695</span>        <span class="c1"># 3. Store the recommendations for the current session, only for those module that are not using any kind of external logic. </span>
<span class="linenos">696</span>        <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;logic_filename&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">697</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">698</span>                <span class="n">conn2</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">699</span>                <span class="n">cursor2</span>  <span class="o">=</span> <span class="n">conn2</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">700</span>                <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO session_recommendation (sessionID, recommendationID) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">recommendation</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]))</span>
<span class="linenos">701</span>                <span class="n">conn2</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">702</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">703</span>                <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">704</span>            <span class="k">finally</span><span class="p">:</span>
<span class="linenos">705</span>                <span class="n">cursor2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">706</span>                <span class="n">conn2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">707</span>    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">708</span>    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">709</span>    <span class="c1"># print(result)</span>
<span class="linenos">710</span>
<span class="linenos">711</span>    <span class="c1"># 4. Create ZIP with recommendations and guides</span>
<span class="linenos">712</span>    <span class="c1"># 4.1 Create the temporary directory to be zipped</span>
<span class="linenos">713</span>    <span class="n">temp_dir</span> <span class="o">=</span> <span class="s1">&#39;temp/session&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;/&#39;</span>
<span class="linenos">714</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">):</span>
<span class="linenos">715</span>        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
<span class="linenos">716</span>    <span class="c1"># 4.2 Generate the PDF recommendations file    </span>
<span class="linenos">717</span>    <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_recommendations_PDF</span><span class="p">(</span><span class="n">module_name</span><span class="o">=</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shortname&#39;</span><span class="p">],</span> <span class="n">session_id</span><span class="o">=</span><span class="n">ID</span><span class="p">,</span> <span class="n">recommendations</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
<span class="linenos">718</span>    <span class="c1"># 4.3 Add guides to the temporary directory</span>
<span class="linenos">719</span>    <span class="k">for</span> <span class="n">recm</span> <span class="ow">in</span> <span class="n">recommendations</span><span class="p">:</span>
<span class="linenos">720</span>        <span class="k">if</span> <span class="n">recm</span><span class="p">[</span><span class="s1">&#39;recommendation_guide&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">721</span>            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s1">&#39;external/&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">recm</span><span class="p">[</span><span class="s1">&#39;recommendation_guide&#39;</span><span class="p">]),</span> <span class="n">temp_dir</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">recm</span><span class="p">[</span><span class="s1">&#39;recommendation_guide&#39;</span><span class="p">]))</span>
<span class="linenos">722</span>    <span class="c1"># 4.4 Zip all the files</span>
<span class="linenos">723</span>    <span class="n">zipped</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">create_recommendations_ZIP</span><span class="p">(</span><span class="n">module_name</span><span class="o">=</span><span class="n">module</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;shortname&#39;</span><span class="p">],</span> <span class="n">session_id</span><span class="o">=</span><span class="n">ID</span><span class="p">)</span>
<span class="linenos">724</span>    <span class="c1"># 4.5 Remove all the files created to zip</span>
<span class="linenos">725</span>    <span class="k">if</span> <span class="n">zipped</span><span class="p">:</span>
<span class="linenos">726</span>        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
<span class="linenos">727</span>    <span class="k">return</span><span class="p">(</span><span class="n">modules</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">build_response_json</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>  
<span class="linenos">728</span>
<span class="linenos">729</span>
<span class="linenos">730</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">731</span><span class="sd">[Summary]: Adds a recommendation to a session, this method is exclusively used after the logic of a module is executed.</span>
<span class="linenos">732</span><span class="sd">[Returns]: </span>
<span class="linenos">733</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">734</span><span class="k">def</span> <span class="nf">add_logic_session_recommendation</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">recommendation_id</span><span class="p">):</span>
<span class="linenos">735</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">736</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">737</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">738</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO session_recommendation (sessionID, recommendationID) VALUES (</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">recommendation_id</span><span class="p">))</span>
<span class="linenos">739</span>        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="linenos">740</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">741</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span> 
<span class="linenos">742</span>    <span class="k">finally</span><span class="p">:</span>
<span class="linenos">743</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">744</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">745</span>
<span class="linenos">746</span>    <span class="c1"># The recommendation is linked to the session.</span>
<span class="linenos">747</span>    <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">748</span>
<span class="linenos">749</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">750</span><span class="sd">[Summary]: Counts number of closed sessions by module ID and user ID.</span>
<span class="linenos">751</span><span class="sd">[Returns]: Returns response result.</span>
<span class="linenos">752</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">753</span><span class="k">def</span> <span class="nf">count_sessions_of_user_module</span><span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
<span class="linenos">754</span>    <span class="c1"># Let&#39;s get existing sessions from the database.</span>
<span class="linenos">755</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">756</span>        <span class="n">conn</span>    <span class="o">=</span> <span class="n">mysql</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">757</span>        <span class="n">cursor</span>  <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="linenos">758</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(session_id) FROM view_user_sessions WHERE moduleID=</span><span class="si">%s</span><span class="s2"> AND user_id=</span><span class="si">%s</span><span class="s2"> AND ended=1 ORDER BY session_id DESC&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">module_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">))</span>
<span class="linenos">759</span>        <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
<span class="linenos">760</span>        <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">761</span>        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">762</span>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">763</span>        <span class="k">raise</span> <span class="n">modules</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span><span class="p">)</span>
<span class="linenos">764</span>
<span class="linenos">765</span>    <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">):</span>
<span class="linenos">766</span>        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">767</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">768</span>        <span class="k">return</span> <span class="mi">0</span>
</pre></div>
</div>
</details><section id="get-user-sessions">
<h2>Get User Sessions<a class="headerlink" href="#get-user-sessions" title="Permalink to this headline"></a></h2>
<dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/sessions</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get user sessions.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module executed on that session.</p></li>
<li><p><strong>user_id</strong> (<em>int</em>) – The session belongs to this user.</p></li>
<li><p><strong>ended</strong> (<em>boolean</em>) – Flag that indicates that a session was terminated by the user.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Sessions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve sessions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/sessions&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;ended&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;updatedOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;createdOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">end</span></code> flag should be set to true when all the questions of a module were answered by a user.</p>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/session/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get user session identified by <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – id of the session.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module executed on that session.</p></li>
<li><p><strong>user_id</strong> (<em>int</em>) – The session belongs to this user.</p></li>
<li><p><strong>ended</strong> (<em>boolean</em>) – Flag that indicates that a session was terminated by the user.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Sessions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve sessions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/sessions&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;ended&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;updatedOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;createdOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/session/user/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">string:</span> </em><em class="sig-param"><span class="pre">email</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get sessions of a user identified by <code class="docutils literal notranslate"><span class="pre">email</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>email</strong> (<em>string</em>) – Email of the user.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session or module.</p></li>
<li><p><strong>user_email</strong> (<em>string</em>) – The email of the user.</p></li>
<li><p><strong>ended</strong> (<em>boolean</em>) – Flag that indicates that a session was terminated by the user.</p></li>
<li><p><strong>type_id</strong> (<em>int</em>) – Module type id.</p></li>
<li><p><strong>shortname</strong> (<em>string</em>) – Unique short name or abbreviation.</p></li>
<li><p><strong>fullname</strong> (<em>string</em>) – Full name of the module.</p></li>
<li><p><strong>displayname</strong> (<em>string</em>) – Module display name that can be used by a frontend.</p></li>
<li><p><strong>dependencies</strong> (<em>array</em>) – An array that contains the set of modules that the current module depends on.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Module description.</p></li>
<li><p><strong>avatar</strong> (<em>string</em>) – Avatar of the user (i.e., location in disk).</p></li>
<li><p><strong>logic_filename</strong> (<em>string</em>) – Filename of the file containing the dynamic logic of the module.</p></li>
<li><p><strong>plugin</strong> (<em>boolean</em>) – A flag that sets if the current module is a plugin.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Sessions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve sessions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/sessions/user/forrest@sam.pt&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>

            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;user_email&quot;</span><span class="p">:</span><span class="s2">&quot;forrest@sam.pt&quot;</span><span class="p">,</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;ended&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;module&quot;</span><span class="p">:{</span>
               <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
               <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="s2">&quot;SRE&quot;</span><span class="p">,</span>
               <span class="nt">&quot;fullname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Elicitation&quot;</span><span class="p">,</span>
               <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements&quot;</span><span class="p">,</span>
               <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
               <span class="nt">&quot;dependencies&quot;</span><span class="p">:[],</span>
               <span class="nt">&quot;logic_filename&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
               <span class="nt">&quot;type_id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
               <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
               <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span><span class="p">,</span>
               <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Fri, 19 Nov 2021 15:29:18 GMT&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;createdOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/session/closed</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get user sessions that were set as closed or terminated.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Response JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session, question, answer, or recommendation.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module executed on that session.</p></li>
<li><p><strong>user_id</strong> (<em>int</em>) – The session belongs to this user.</p></li>
<li><p><strong>ended</strong> (<em>boolean</em>) – Flag that indicates that a session was terminated by the user.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The content of question, answer, or recommendation.</p></li>
<li><p><strong>answer</strong> (<em>array</em>) – Selected answers for the current question and session.</p></li>
<li><p><strong>recommendation_guide</strong> (<em>string</em>) – The filename of the recommendation guide.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-odd">Status Codes</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Sessions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve sessions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/sessions/closed&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;ended&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;questions&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;answer&quot;</span><span class="p">:[{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">}],</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;recommendations&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                  <span class="nt">&quot;recommendation_guide&quot;</span><span class="p">:</span><span class="kc">null</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;createdOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:31:29 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/session/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/closed</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get user sessions identified by <code class="docutils literal notranslate"><span class="pre">id</span></code> that were flagged as closed.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session, question, answer, or recommendation.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module executed on that session.</p></li>
<li><p><strong>user_id</strong> (<em>int</em>) – The session belongs to this user.</p></li>
<li><p><strong>ended</strong> (<em>boolean</em>) – Flag that indicates that a session was terminated by the user.</p></li>
<li><p><strong>content</strong> (<em>string</em>) – The content of question, answer, or recommendation.</p></li>
<li><p><strong>answer</strong> (<em>array</em>) – Selected answers for the current question and session.</p></li>
<li><p><strong>recommendation_guide</strong> (<em>string</em>) – The filename of the recommendation guide.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Sessions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve sessions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/sessions/closed&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
            <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;ended&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;questions&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;answer&quot;</span><span class="p">:[{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">}],</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;recommendations&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
                  <span class="nt">&quot;recommendation_guide&quot;</span><span class="p">:</span><span class="kc">null</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;createdOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:31:29 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<hr/><dl class="http get">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">GET</span> </span><span class="sig-name descname"><span class="pre">/api/session/module/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span><span class="sig-name descname"><span class="pre">/user/</span></span><span class="sig-paren">(</span><em class="property"><span class="pre">int:</span> </em><em class="sig-param"><span class="pre">id</span></em><span class="sig-paren">)</span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Get user sessions that were flagged as closed for a particular user <code class="docutils literal notranslate"><span class="pre">id</span></code> and module <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the module or user.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session.</p></li>
<li><p><strong>user_id</strong> (<em>int</em>) – The session belongs to this user.</p></li>
<li><p><strong>user_email</strong> (<em>string</em>) – The email of the user.</p></li>
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module executed on that session.</p></li>
<li><p><strong>ended</strong> (<em>boolean</em>) – Flag that indicates that a session was terminated by the user.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Sessions successfully retrieved.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to retrieve sessions.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/sessions/module/1/user/2&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;content&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="mi">2</span>
            <span class="nt">&quot;user_email&quot;</span><span class="p">:</span><span class="s2">&quot;forrest@sam.pt&quot;</span><span class="p">,</span>
            <span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;ended&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;createdOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 10:31:41 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedOn&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:31:29 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="create-user-session">
<h2>Create User Session<a class="headerlink" href="#create-user-session" title="Permalink to this headline"></a></h2>
<dl class="http post">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">POST</span> </span><span class="sig-name descname"><span class="pre">/api/session</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Starts a new user session taking into account a user selected module identified by <code class="docutils literal notranslate"><span class="pre">module_id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>module_id</strong> (<em>int</em>) – Id of the module that will be executed on that user session.</p></li>
<li><p><strong>email</strong> (<em>string</em>) – Email of the user who started the session.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the new session.</p></li>
<li><p><strong>shortname</strong> (<em>string</em>) – Unique short name or abbreviation of the module.</p></li>
<li><p><strong>fullname</strong> (<em>string</em>) – Full name of the module.</p></li>
<li><p><strong>displayname</strong> (<em>string</em>) – Module display name that can be used by a frontend.</p></li>
<li><p><strong>description</strong> (<em>string</em>) – Module description.</p></li>
<li><p><strong>tree</strong> (<em>array</em>) – Array of questions and answers mapped to the module.</p></li>
<li><p><strong>dependencies</strong> (<em>array</em>) – An array that contains the set of modules that the current module depends on.</p></li>
<li><p><strong>recommendations</strong> (<em>array</em>) – Array of recommendations that contains the mapping between question <code class="docutils literal notranslate"><span class="pre">id</span></code> and answer <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p></li>
<li><p><strong>tree</strong> – Array of questions and answers mapped to the module.</p></li>
<li><p><strong>createdon</strong> (<em>datetime</em>) – Creation date and time.</p></li>
<li><p><strong>updatedon</strong> (<em>datetime</em>) – Update date and time.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Session successfully created.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to create session.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;module_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nt">&quot;email&quot;</span><span class="p">:</span><span class="s2">&quot;forrest@sam.pt&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/session&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;module&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;shortname&quot;</span><span class="p">:</span><span class="s2">&quot;SRE&quot;</span><span class="p">,</span>
            <span class="nt">&quot;displayname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements&quot;</span><span class="p">,</span>
            <span class="nt">&quot;fullname&quot;</span><span class="p">:</span><span class="s2">&quot;Security Requirements Elicitation&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="s2">&quot;Module description&quot;</span><span class="p">,</span>
            <span class="nt">&quot;avatar&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;logic_filename&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;type_id&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;dependencies&quot;</span><span class="p">:[],</span>
            <span class="nt">&quot;recommendations&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;questions_answers&quot;</span><span class="p">:[</span>
                     <span class="p">{</span>
                        <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                        <span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                        <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                        <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:55:12 GMT&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:55:12 GMT&quot;</span>
                     <span class="p">}</span>
                  <span class="p">],</span>
                  <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:55:12 GMT&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:55:12 GMT&quot;</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;tree&quot;</span><span class="p">:[</span>
               <span class="p">{</span>
                  <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                  <span class="nt">&quot;order&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                  <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;What is the domain of your IoT system ?&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;multipleAnswers&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                  <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;question&quot;</span><span class="p">,</span>
                  <span class="nt">&quot;expanded&quot;</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
                  <span class="nt">&quot;children&quot;</span><span class="p">:[</span>
                     <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Smart home&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="nt">&quot;children&quot;</span><span class="p">:[]},</span>
                     <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Smart Healthcare&quot;</span><span class="p">,</span> <span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="nt">&quot;children&quot;</span><span class="p">:[]}</span>
                  <span class="p">]</span>
               <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&quot;createdon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:55:12 GMT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;updatedon&quot;</span><span class="p">:</span><span class="s2">&quot;Sat, 20 Nov 2021 11:55:12 GMT&quot;</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="edit-user-session">
<h2>Edit User Session<a class="headerlink" href="#edit-user-session" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/session</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Update a session. Specifically, by adding an answer to a question for the session module.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Request JSON Object</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>question_id</strong> (<em>int</em>) – Id of the module that will be executed on that user session.</p></li>
<li><p><strong>answer_id</strong> (<em>int</em>) – Email of the user who started the session.</p></li>
<li><p><strong>input</strong> (<em>string</em>) – (optional) User direct answer that was not choosen from a predefined set of answers.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Session successfully created.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to create session.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<p><strong>Example Request</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;answer_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <code class="docutils literal notranslate"><span class="pre">input</span></code> parameter should only be included in the request body if the question is not a multi-choice one where the user has to include a direct answer:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;question_id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="nt">&quot;input&quot;</span><span class="p">:</span><span class="s2">&quot;This is the user answer&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;/api/session/1&quot;</span><span class="p">:{</span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span><span class="p">}}</span>
</pre></div>
</div>
</section>
<section id="close-user-session">
<h2>Close User Session<a class="headerlink" href="#close-user-session" title="Permalink to this headline"></a></h2>
<dl class="http put">
<dt class="sig sig-object http">
<span class="sig-name descname"><span class="pre">PUT</span> </span><span class="sig-name descname"><span class="pre">/api/session/{id}/end</span></span></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Synopsis</dt>
<dd class="field-odd"><p>Close or terminate a user session through the session <code class="docutils literal notranslate"><span class="pre">id</span></code>.</p>
</dd>
<dt class="field-even">Request Headers</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7235#section-4.2">Authorization</a></span> – Bearer token provided by <a class="reference internal" href="#authenticate"><span class="std std-ref">/api/user/login</span></a>.</p></li>
</ul>
</dd>
<dt class="field-odd">Response Headers</dt>
<dd class="field-odd"><ul class="simple">
<li><p><span><a class="reference external" href="https://tools.ietf.org/html/rfc7231#section-3.1.1.5">Content-Type</a></span> – application/json</p></li>
</ul>
</dd>
<dt class="field-even">Parameters</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session.</p></li>
</ul>
</dd>
<dt class="field-odd">Response JSON Object</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>id</strong> (<em>int</em>) – Id of the session that was closed.</p></li>
<li><p><strong>recommendations</strong> (<em>array</em>) – An array that contains the recommendations based on the answers given by the user in the session.</p></li>
<li><p><strong>status</strong> (<em>int</em>) – Status code.</p></li>
</ul>
</dd>
<dt class="field-even">Status Codes</dt>
<dd class="field-even"><ul class="simple">
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.2.1">200 OK</a></span> – Session successfully closed.</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.4.1">400 Bad Request</a></span> – The server was unable to process the request (e.g., malformed request syntax).</p></li>
<li><p><span><a class="reference external" href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html#sec10.5.1">500 Internal Server Error</a></span> – Fail to close session.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This service will return the set of recommendations based on the answers given by the user in that session.</p>
</div>
<p><strong>Example Response</strong></p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
   <span class="nt">&quot;/api/session/1/end&quot;</span><span class="p">:{</span>
      <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
      <span class="nt">&quot;recommendations&quot;</span><span class="p">:[</span>
         <span class="p">{</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Confidentiality&quot;</span><span class="p">,</span>
            <span class="nt">&quot;description&quot;</span><span class="p">:</span><span class="kc">null</span><span class="p">,</span>
            <span class="nt">&quot;recommendation_guide&quot;</span><span class="p">:</span><span class="kc">null</span>
         <span class="p">}</span>
      <span class="p">],</span>
      <span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="mi">200</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="acknowledgment">
<h1>Acknowledgment<a class="headerlink" href="#acknowledgment" title="Permalink to this headline"></a></h1>
<p>This work was performed under the scope of Project SECURIoTESIGN with funding from FCT/COMPETE/FEDER with reference number POCI-01-0145-FEDER-030657. This work is funded by Portuguese FCT/MCTES through national funds and, when applicable, co-funded by EU funds under the project UIDB/50008/2020, research grants BIL/Nº11/2019-B00701, BIL/Nº12/2019-B00702, and FCT research and doctoral grant SFRH/BD/133838/2017 and BIM/n°32/2018-B00582, respectively, and also supported by project CENTRO-01-0145-FEDER-000019 - C4 - Competence Center in Cloud Computing, Research Line 1: Cloud Systems, Work package WP 1.2 - Systems design and development processes and software for Cloud and Internet of Things ecosystems, cofinanced by the European Regional Development Fund (ERDF) through the Programa Operacional Regional do Centro (Centro 2020), in the scope of the Sistema de Apoio à Investigação Científica e Tecnológica - Programas Integrados de IC&amp;DT.</p>
</section>
<section id="license">
<h1>License<a class="headerlink" href="#license" title="Permalink to this headline"></a></h1>
<p>Apache License</p>
<p>Version 2.0, January 2004</p>
<p><a class="reference external" href="http://www.apache.org/licenses/">http://www.apache.org/licenses/</a></p>
<p>TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION</p>
<blockquote>
<div><ol class="arabic">
<li><p>Definitions.</p>
<p>“License” shall mean the terms and conditions for use, reproduction,
and distribution as defined by Sections 1 through 9 of this document.</p>
<p>“Licensor” shall mean the copyright owner or entity authorized by
the copyright owner that is granting the License.</p>
<p>“Legal Entity” shall mean the union of the acting entity and all
other entities that control, are controlled by, or are under common
control with that entity. For the purposes of this definition,
“control” means (i) the power, direct or indirect, to cause the
direction or management of such entity, whether by contract or
otherwise, or (ii) ownership of fifty percent (50%) or more of the
outstanding shares, or (iii) beneficial ownership of such entity.</p>
<p>“You” (or “Your”) shall mean an individual or Legal Entity
exercising permissions granted by this License.</p>
<p>“Source” form shall mean the preferred form for making modifications,
including but not limited to software source code, documentation
source, and configuration files.</p>
<p>“Object” form shall mean any form resulting from mechanical
transformation or translation of a Source form, including but
not limited to compiled object code, generated documentation,
and conversions to other media types.</p>
<p>“Work” shall mean the work of authorship, whether in Source or
Object form, made available under the License, as indicated by a
copyright notice that is included in or attached to the work
(an example is provided in the Appendix below).</p>
<p>“Derivative Works” shall mean any work, whether in Source or Object
form, that is based on (or derived from) the Work and for which the
editorial revisions, annotations, elaborations, or other modifications
represent, as a whole, an original work of authorship. For the purposes
of this License, Derivative Works shall not include works that remain
separable from, or merely link (or bind by name) to the interfaces of,
the Work and Derivative Works thereof.</p>
<p>“Contribution” shall mean any work of authorship, including
the original version of the Work and any modifications or additions
to that Work or Derivative Works thereof, that is intentionally
submitted to Licensor for inclusion in the Work by the copyright owner
or by an individual or Legal Entity authorized to submit on behalf of
the copyright owner. For the purposes of this definition, “submitted”
means any form of electronic, verbal, or written communication sent
to the Licensor or its representatives, including but not limited to
communication on electronic mailing lists, source code control systems,
and issue tracking systems that are managed by, or on behalf of, the
Licensor for the purpose of discussing and improving the Work, but
excluding communication that is conspicuously marked or otherwise
designated in writing by the copyright owner as “Not a Contribution.”</p>
<p>“Contributor” shall mean Licensor and any individual or Legal Entity
on behalf of whom a Contribution has been received by Licensor and
subsequently incorporated within the Work.</p>
</li>
<li><p>Grant of Copyright License. Subject to the terms and conditions of
this License, each Contributor hereby grants to You a perpetual,
worldwide, non-exclusive, no-charge, royalty-free, irrevocable
copyright license to reproduce, prepare Derivative Works of,
publicly display, publicly perform, sublicense, and distribute the
Work and such Derivative Works in Source or Object form.</p></li>
<li><p>Grant of Patent License. Subject to the terms and conditions of
this License, each Contributor hereby grants to You a perpetual,
worldwide, non-exclusive, no-charge, royalty-free, irrevocable
(except as stated in this section) patent license to make, have made,
use, offer to sell, sell, import, and otherwise transfer the Work,
where such license applies only to those patent claims licensable
by such Contributor that are necessarily infringed by their
Contribution(s) alone or by combination of their Contribution(s)
with the Work to which such Contribution(s) was submitted. If You
institute patent litigation against any entity (including a
cross-claim or counterclaim in a lawsuit) alleging that the Work
or a Contribution incorporated within the Work constitutes direct
or contributory patent infringement, then any patent licenses
granted to You under this License for that Work shall terminate
as of the date such litigation is filed.</p></li>
<li><p>Redistribution. You may reproduce and distribute copies of the
Work or Derivative Works thereof in any medium, with or without
modifications, and in Source or Object form, provided that You
meet the following conditions:</p>
<ol class="loweralpha simple">
<li><p>You must give any other recipients of the Work or
Derivative Works a copy of this License; and</p></li>
<li><p>You must cause any modified files to carry prominent notices
stating that You changed the files; and</p></li>
<li><p>You must retain, in the Source form of any Derivative Works
that You distribute, all copyright, patent, trademark, and
attribution notices from the Source form of the Work,
excluding those notices that do not pertain to any part of
the Derivative Works; and</p></li>
<li><p>If the Work includes a “NOTICE” text file as part of its
distribution, then any Derivative Works that You distribute must
include a readable copy of the attribution notices contained
within such NOTICE file, excluding those notices that do not
pertain to any part of the Derivative Works, in at least one
of the following places: within a NOTICE text file distributed
as part of the Derivative Works; within the Source form or
documentation, if provided along with the Derivative Works; or,
within a display generated by the Derivative Works, if and
wherever such third-party notices normally appear. The contents
of the NOTICE file are for informational purposes only and
do not modify the License. You may add Your own attribution
notices within Derivative Works that You distribute, alongside
or as an addendum to the NOTICE text from the Work, provided
that such additional attribution notices cannot be construed
as modifying the License.</p></li>
</ol>
<p>You may add Your own copyright statement to Your modifications and
may provide additional or different license terms and conditions
for use, reproduction, or distribution of Your modifications, or
for any such Derivative Works as a whole, provided Your use,
reproduction, and distribution of the Work otherwise complies with
the conditions stated in this License.</p>
</li>
<li><p>Submission of Contributions. Unless You explicitly state otherwise,
any Contribution intentionally submitted for inclusion in the Work
by You to the Licensor shall be under the terms and conditions of
this License, without any additional terms or conditions.
Notwithstanding the above, nothing herein shall supersede or modify
the terms of any separate license agreement you may have executed
with Licensor regarding such Contributions.</p></li>
<li><p>Trademarks. This License does not grant permission to use the trade
names, trademarks, service marks, or product names of the Licensor,
except as required for reasonable and customary use in describing the
origin of the Work and reproducing the content of the NOTICE file.</p></li>
<li><p>Disclaimer of Warranty. Unless required by applicable law or
agreed to in writing, Licensor provides the Work (and each
Contributor provides its Contributions) on an “AS IS” BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied, including, without limitation, any warranties or conditions
of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
PARTICULAR PURPOSE. You are solely responsible for determining the
appropriateness of using or redistributing the Work and assume any
risks associated with Your exercise of permissions under this License.</p></li>
<li><p>Limitation of Liability. In no event and under no legal theory,
whether in tort (including negligence), contract, or otherwise,
unless required by applicable law (such as deliberate and grossly
negligent acts) or agreed to in writing, shall any Contributor be
liable to You for damages, including any direct, indirect, special,
incidental, or consequential damages of any character arising as a
result of this License or out of the use or inability to use the
Work (including but not limited to damages for loss of goodwill,
work stoppage, computer failure or malfunction, or any and all
other commercial damages or losses), even if such Contributor
has been advised of the possibility of such damages.</p></li>
<li><p>Accepting Warranty or Additional Liability. While redistributing
the Work or Derivative Works thereof, You may choose to offer,
and charge a fee for, acceptance of support, warranty, indemnity,
or other liability obligations and/or rights consistent with this
License. However, in accepting such obligations, You may act only
on Your own behalf and on Your sole responsibility, not on behalf
of any other Contributor, and only if You agree to indemnify,
defend, and hold each Contributor harmless for any liability
incurred by, or claims asserted against, such Contributor by reason
of your accepting any such warranty or additional liability.</p></li>
</ol>
<p>END OF TERMS AND CONDITIONS</p>
</div></blockquote>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>